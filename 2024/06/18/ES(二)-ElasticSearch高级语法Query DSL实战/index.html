<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ES(二)-ElasticSearch高级语法Query DSL实战 | 萝卜的博客</title><meta name="author" content="Radish"><meta name="copyright" content="Radish"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、ES高级查询Query DSLES中提供了一种强大的检索数据方式,这种检索方式称之为Query DSL（Domain Specified Language 领域专用语言） , Query DSL是利用Rest API传递JSON格式的请求体(RequestBody)数据与ES进行交互，这种方式的丰富查询语法让ES检索变得更强大，更简洁。 https://www.elastic.co/guide">
<meta property="og:type" content="article">
<meta property="og:title" content="ES(二)-ElasticSearch高级语法Query DSL实战">
<meta property="og:url" content="http://example.com/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="萝卜的博客">
<meta property="og:description" content="一、ES高级查询Query DSLES中提供了一种强大的检索数据方式,这种检索方式称之为Query DSL（Domain Specified Language 领域专用语言） , Query DSL是利用Rest API传递JSON格式的请求体(RequestBody)数据与ES进行交互，这种方式的丰富查询语法让ES检索变得更强大，更简洁。 https://www.elastic.co/guide">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/es_logo.png">
<meta property="article:published_time" content="2024-06-18T15:50:00.000Z">
<meta property="article:modified_time" content="2024-06-20T15:02:13.233Z">
<meta property="article:author" content="Radish">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/es_logo.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ES(二)-ElasticSearch高级语法Query DSL实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-20 23:02:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E9%9F%B3%E4%B9%90"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page child" href="/%E8%A7%86%E9%A2%91"><i class="fa-fw /movies/"></i><span> 1</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="萝卜的博客"><span class="site-name">萝卜的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E9%9F%B3%E4%B9%90"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page child" href="/%E8%A7%86%E9%A2%91"><i class="fa-fw /movies/"></i><span> 1</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">ES(二)-ElasticSearch高级语法Query DSL实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-18T15:50:00.000Z" title="发表于 2024-06-18 23:50:00">2024-06-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-20T15:02:13.233Z" title="更新于 2024-06-20 23:02:13">2024-06-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/">Java后端</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/">分布式架构</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/ElasticSearch/">ElasticSearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ES(二)-ElasticSearch高级语法Query DSL实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="一、ES高级查询Query-DSL"><a href="#一、ES高级查询Query-DSL" class="headerlink" title="一、ES高级查询Query DSL"></a>一、ES高级查询Query DSL</h1><p><font color="red">ES中提供了一种强大的检索数据方式,这种检索方式称之为Query DSL</font>（Domain Specified Language 领域专用语言） , Query DSL是利用Rest API传递JSON格式的请求体(RequestBody)数据与ES进行交互，这种方式的丰富查询语法让ES检索变得更强大，更简洁。</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html</a></p>
<p>语法：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_doc/_search {json请求体数据}</span><br><span class="line">可以简化为下面写法</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search {json请求体数据}</span><br></pre></td></tr></tbody></table></figure>

<p>示例</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#无条件查询，默认返回<span class="number">10</span>条数据</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">    <span class="string">"query"</span>:{</span><br><span class="line">        <span class="string">"match_all"</span>:{}</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1718726091453.png" alt="1718726091453"></p>
<p>示例数据</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#指定ik分词器</span><br><span class="line"><span class="variable constant_">PUT</span> /es_db</span><br><span class="line">{</span><br><span class="line">  <span class="string">"settings"</span> : {</span><br><span class="line">      <span class="string">"index"</span> : {</span><br><span class="line">          <span class="string">"analysis.analyzer.default.type"</span>: <span class="string">"ik_max_word"</span></span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># 创建文档,指定id</span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">1</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">25</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"广州天河公园"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"java developer"</span></span><br><span class="line">}</span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">2</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"李四"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">28</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"广州荔湾大厦"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"java assistant"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">3</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"王五"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">26</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"广州白云山公园"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"php developer"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">4</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"赵六"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">22</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"长沙橘子洲"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"python assistant"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">5</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"张龙"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">19</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"长沙麓谷企业广场"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"java architect assistant"</span></span><br><span class="line">}    </span><br><span class="line">    </span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">6</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"赵虎"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">32</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"长沙麓谷兴工国际产业园"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"java architect"</span></span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">7</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"李虎"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">32</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"广州番禺节能科技园"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"java architect"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /es_db/_doc/<span class="number">8</span></span><br><span class="line">{</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"张星"</span>,</span><br><span class="line"><span class="string">"sex"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"age"</span>: <span class="number">32</span>,</span><br><span class="line"><span class="string">"address"</span>: <span class="string">"武汉东湖高新区未来智汇城"</span>,</span><br><span class="line"><span class="string">"remark"</span>: <span class="string">"golang developer"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="1、match-all"><a href="#1、match-all" class="headerlink" title="1、match_all"></a>1、match_all</h2><p>使用match_all，匹配所有文档，<font color="red">默认只会返回10条数据。</font></p>
<p><font color="red">原因：_search查询默认采用的是分页查询，每页记录数size的默认值为10。</font>如果想显示更多数据，指定size</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">等同于</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">    <span class="string">"query"</span>:{</span><br><span class="line">        <span class="string">"match_all"</span>:{}</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="返回源数据-source"><a href="#返回源数据-source" class="headerlink" title="返回源数据_source"></a><strong>返回源数据_source</strong></h3><p>_source 关键字: 是一个数组,在数组中用来指定展示那些字段</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 返回指定字段</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_all"</span>: {}</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"_source"</span>: [<span class="string">"name"</span>,<span class="string">"address"</span>]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#在查询中过滤</span><br><span class="line">#不查看源数据，仅查看元字段</span><br><span class="line">{</span><br><span class="line">  <span class="string">"_source"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    ...</span><br><span class="line">  } </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#只看以obj.开头的字段</span><br><span class="line">{</span><br><span class="line">  <span class="string">"_source"</span>: <span class="string">"obj.*"</span>,</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    ...</span><br><span class="line">  } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="返回指定条数size"><a href="#返回指定条数size" class="headerlink" title="返回指定条数size"></a><strong>返回指定条数size</strong></h3><p>size 关键字: 指定查询结果中返回指定条数。 默认返回值10条</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_all"</span>: {}</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">100</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="分页查询from-amp-size"><a href="#分页查询from-amp-size" class="headerlink" title="分页查询from&amp;size"></a><strong>分页查询from&amp;size</strong></h4><p>size：显示应该返回的结果数量，默认是 10</p>
<p>from：显示应该跳过的初始结果数量，默认是 0</p>
<p>from 关键字用来指定起始返回位置，和size关键字连用可实现分页效果</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_all"</span>: {}</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"from"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">5</span>  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="指定字段排序sort"><a href="#指定字段排序sort" class="headerlink" title="指定字段排序sort"></a>指定字段排序sort</h4><p><font color="red">注意：会让得分失效</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_all"</span>: {}</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"sort"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"age"</span>: <span class="string">"desc"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#排序，分页</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_all"</span>: {}</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"sort"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"age"</span>: <span class="string">"desc"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"from"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">5</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2 id="2、术语级别查询"><a href="#2、术语级别查询" class="headerlink" title="2、术语级别查询"></a>2、术语级别查询</h2><p>术语级别查询（Term-Level Queries）指的是<font color="red">搜索内容不经过文本分析直接用于文本匹配</font>，这个过程类似于数据库的SQL查询，搜索的对象大多是索引的非text类型字段。Elasticsearch 中的一些术语级别查询示例包括 term、terms 和 range 查询。</p>
<h3 id="Term-query术语查询"><a href="#Term-query术语查询" class="headerlink" title="Term query术语查询"></a><strong>Term query术语查询</strong></h3><p>术语查询直接返回包含搜索内容的文档，常用来查询索引中某个类型为keyword的文本字段，类似于SQL的“=”查询，使用十分普遍。</p>
<p><font color="red">注意：最好不要在term查询的字段中使用text字段，因为text字段会被分词，这样做既没有意义，还很有可能什么也查不到。</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 对bool，日期，数字，结构化的文本可以利用term做精确匹配</span><br><span class="line"># term 精确匹配</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"term"</span>: {</span><br><span class="line">      <span class="string">"age"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="number">28</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># 思考： 查询广州白云是否有数据，为什么？</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>:{</span><br><span class="line">    <span class="string">"term"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"广州白云"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># 采用term精确查询, 查询字段映射类型为keyword</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>:{</span><br><span class="line">    <span class="string">"term"</span>: {</span><br><span class="line">      <span class="string">"address.keyword"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"广州白云山公园"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">在ES中，Term查询，对输入不做分词。会将输入作为一个整体，在倒排索引中查找准确的词项</font>，并且使用相关度算分公式为每个包含该词项的文档进行相关度算分。</p>
<p>可以通过 Constant Score 将查询转换成一个 Filtering，避免算分，并利用缓存，提高性能。</p>
<ul>
<li>将Query 转成 Filter，忽略TF-IDF计算，避免相关性算分的开销</li>
<li>Filter可以有效利用缓存</li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"constant_score"</span>: {</span><br><span class="line">      <span class="string">"filter"</span>: {</span><br><span class="line">        <span class="string">"term"</span>: {</span><br><span class="line">          <span class="string">"address.keyword"</span>: <span class="string">"广州白云山公园"</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">term处理多值字段时，term查询是包含，不是等于。</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /employee/_bulk</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_id"</span>:<span class="number">1</span>}}</span><br><span class="line">{<span class="string">"name"</span>:<span class="string">"小明"</span>,<span class="string">"interest"</span>:[<span class="string">"跑步"</span>,<span class="string">"篮球"</span>]}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_id"</span>:<span class="number">2</span>}}</span><br><span class="line">{<span class="string">"name"</span>:<span class="string">"小红"</span>,<span class="string">"interest"</span>:[<span class="string">"跳舞"</span>,<span class="string">"画画"</span>]}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_id"</span>:<span class="number">3</span>}}</span><br><span class="line">{<span class="string">"name"</span>:<span class="string">"小丽"</span>,<span class="string">"interest"</span>:[<span class="string">"跳舞"</span>,<span class="string">"唱歌"</span>,<span class="string">"跑步"</span>]}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">POST</span> /employee/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"term"</span>: {</span><br><span class="line">      <span class="string">"interest.keyword"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"跑步"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Terms-Query多术语查询"><a href="#Terms-Query多术语查询" class="headerlink" title="Terms Query多术语查询"></a><strong>Terms Query多术语查询</strong></h3><p>Terms query用于在指定字段上匹配多个词项（terms）。它会精确匹配指定字段中包含的任何一个词项。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"terms"</span>: {</span><br><span class="line">      <span class="string">"remark.keyword"</span>: [<span class="string">"java assistant"</span>, <span class="string">"java architect"</span>]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="exists-query"><a href="#exists-query" class="headerlink" title="exists query"></a><strong>exists query</strong></h3><p>在Elasticsearch中可以使用exists进行查询，以判断文档中是否存在对应的字段。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#查询索引库中存在remarks字段的文档数据</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"exists"</span>: </span><br><span class="line">    {</span><br><span class="line">      <span class="string">"field"</span>: <span class="string">"remark"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ids-query"><a href="#ids-query" class="headerlink" title="ids query"></a><strong>ids query</strong></h3><p>ids 关键字 : 值为数组类型,用来根据一组id获取多个对应的文档</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"ids"</span>: {</span><br><span class="line">      <span class="string">"values"</span>: [<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="range-query范围查询"><a href="#range-query范围查询" class="headerlink" title="range query范围查询"></a><strong>range query范围查询</strong></h3><ul>
<li>range：范围关键字</li>
<li>gte 大于等于</li>
<li>lte  小于等于</li>
<li>gt 大于</li>
<li>lt 小于</li>
<li>now 当前时间</li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"range"</span>: {</span><br><span class="line">      <span class="string">"age"</span>: {</span><br><span class="line">        <span class="string">"gte"</span>: <span class="number">25</span>,</span><br><span class="line">        <span class="string">"lte"</span>: <span class="number">28</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#日期范围比较</span><br><span class="line"><span class="variable constant_">DELETE</span> /product</span><br><span class="line"><span class="variable constant_">POST</span> /product/_bulk</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_id"</span>:<span class="number">1</span>}}</span><br><span class="line">{<span class="string">"price"</span>:<span class="number">100</span>,<span class="string">"date"</span>:<span class="string">"2021-01-01"</span>,<span class="string">"productId"</span>:<span class="string">"XHDK-1293"</span>}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_id"</span>:<span class="number">2</span>}}</span><br><span class="line">{<span class="string">"price"</span>:<span class="number">200</span>,<span class="string">"date"</span>:<span class="string">"2022-01-01"</span>,<span class="string">"productId"</span>:<span class="string">"KDKE-5421"</span>}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">GET</span> /product/_mapping</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">GET</span> /product/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"range"</span>: {</span><br><span class="line">      <span class="string">"date"</span>: {</span><br><span class="line">        <span class="string">"gte"</span>: <span class="string">"now-2y"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="prefix-query前缀查询"><a href="#prefix-query前缀查询" class="headerlink" title="prefix query前缀查询"></a><strong>prefix query前缀查询</strong></h3><p>它会对分词后的term进行前缀搜索。</p>
<ul>
<li><font color="red">它不会分析要搜索字符串，传入的前缀就是想要查找的前缀</font></li>
<li>默认状态下，前缀查询不做相关度分数计算，它只是将所有匹配的文档返回，然后赋予所有相关分数值为1。它的行为更像是一个过滤器而不是查询。两者实际的区别就是过滤器是可以被缓存的，而前缀查询不行。</li>
</ul>
<p><font color="red">prefix的原理：需要遍历所有倒排索引，并比较每个term是否以所指定的前缀开头。</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"prefix"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"广州"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="wildcard-query通配符查询"><a href="#wildcard-query通配符查询" class="headerlink" title="wildcard query通配符查询"></a><strong>wildcard query通配符查询</strong></h3><p>通配符查询：工作原理和prefix相同，只不过它不是只比较开头，它能支持更为复杂的匹配模式。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"wildcard"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"*白*"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="fuzzy-query模糊查询"><a href="#fuzzy-query模糊查询" class="headerlink" title="fuzzy query模糊查询"></a><strong>fuzzy query模糊查询</strong></h3><p>在实际的搜索中，我们有时候会打错字，从而导致搜索不到。在<font color="red">Elasticsearch中，我们可以使用fuzziness属性来进行模糊查询，从而达到搜索有错别字的情形。</font></p>
<p>fuzzy 查询会用到两个很重要的参数，fuzziness，prefix_length</p>
<ul>
<li><p>fuzziness：表示输入的关键字通过几次操作可以转变成为ES库里面的对应field的字段</p>
</li>
<li><ul>
<li>操作是指：新增一个字符，删除一个字符，修改一个字符，每次操作可以记做编辑距离为1;</li>
<li>如中文集团到中威集团编辑距离就是1，只需要修改一个字符；如果fuzziness值在这里设置成2，会把编辑距离为2的东东集团也查出来。</li>
<li><font color="red">该参数默认值为0，即不开启模糊查询;</font> fuzzy 模糊查询最大模糊错误必须在0-2之间</li>
</ul>
</li>
<li><p>prefix_length：表示限制输入关键字和ES对应查询field的内容开头的第n个字符必须完全匹配，不允许错别字匹配;</p>
</li>
<li><ul>
<li>如这里等于1，则表示开头的字必须匹配，不匹配则不返回;</li>
<li>默认值也是0;</li>
<li>加大prefix_length的值可以提高效率和准确率。</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"fuzzy"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"白运山"</span>,</span><br><span class="line">        <span class="string">"fuzziness"</span>: <span class="number">1</span>    </span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="3、全文检索"><a href="#3、全文检索" class="headerlink" title="3、全文检索"></a>3、全文检索</h2><p>全文检索查询（Full Text Queries）和术语级别查询（Term-Level Queries）是 Elasticsearch 中搜索和检索数据的两种不同方法。</p>
<p><font color="red">全文检索查询旨在基于相关性搜索和匹配文本数据。</font>这些查询会对输入的文本进行分析，将其拆分为词项（单个单词），并执行诸如分词、词干处理和标准化等操作。Elasticsearch 中的一些全文检索查询示例包括 match、match_phrase 和 multi_match 查询。</p>
<p>全文检索的关键特点：</p>
<ul>
<li><font color="red">对输入的文本进行分析，并根据分析后的词项进行搜索和匹配。</font>全文检索查询会对输入的文本进行分析，将其拆分为词项，并基于这些词项进行搜索和匹配操作。</li>
<li>以相关性为基础进行搜索和匹配。全文检索查询使用相关性算法来确定文档与查询的匹配程度，并按照相关性进行排序。相关性可以基于词项的频率、权重和其他因素来计算。</li>
<li>全文检索查询适用于包含自由文本数据的字段，例如文档的内容、文章的正文或产品描述等。</li>
</ul>
<h3 id="match-query匹配查询"><a href="#match-query匹配查询" class="headerlink" title="match query匹配查询"></a><strong>match query匹配查询</strong></h3><p><font color="red">match在匹配时会对所查找的关键词进行分词，然后按分词匹配查找。</font></p>
<p>match支持以下参数：</p>
<ul>
<li><p>query : 指定匹配的值</p>
</li>
<li><p>operator : 匹配条件类型</p>
</li>
<li><ul>
<li><font color="red">and : 条件分词后都要匹配</font></li>
<li><font color="red">or : 条件分词后有一个匹配即可(默认)</font></li>
</ul>
</li>
<li><p>minmum_should_match : 最低匹配度，即条件在倒排索引中最低的匹配度</p>
</li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#match 分词后or的效果</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: <span class="string">"广州白云山公园"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># 分词后 and的效果</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"广州白云山公园"</span>,</span><br><span class="line">        <span class="string">"operator"</span>: <span class="string">"and"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在match中的应用： 当operator参数设置为or时，<font color="red">minnum_should_match参数用来控制匹配的分词的最少数量。</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 最少匹配广州，公园两个词</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"广州公园"</span>,</span><br><span class="line">        <span class="string">"minimum_should_match"</span>: <span class="number">2</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>对于match查询，其底层逻辑的概述：</p>
<ol>
<li>分词：首先，输入的查询文本会被分词器进行分词。分词器会将文本拆分成一个个词项（terms），如单词、短语或特定字符。分词器通常根据特定的语言规则和配置进行操作。</li>
<li>倒排索引：ES使用倒排索引来加速搜索过程。倒排索引是一种数据结构，它将词项映射到包含这些词项的文档。每个词项都有一个对应的倒排列表，其中包含了包含该词项的所有文档的引用。</li>
<li>匹配计算：一旦查询被分词，ES将根据查询的类型和参数计算文档与查询的匹配度。对于match查询，ES将比较查询的词项与倒排索引中的词项，并计算文档的相关性得分。相关性得分衡量了文档与查询的匹配程度。</li>
<li>结果返回：根据相关性得分，ES将返回最匹配的文档作为搜索结果。搜索结果通常按照相关性得分进行排序，以便最相关的文档排在前面。</li>
</ol>
<h3 id="multi-match-query-多字段查询"><a href="#multi-match-query-多字段查询" class="headerlink" title="multi_match query 多字段查询"></a><strong>multi_match query 多字段查询</strong></h3><p>可以根据字段类型，决定是否使用分词查询，得分最高的在前面</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"multi_match"</span>: {</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"长沙张龙"</span>,</span><br><span class="line">      <span class="string">"fields"</span>: [</span><br><span class="line">        <span class="string">"address"</span>,</span><br><span class="line">        <span class="string">"name"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">注意：字段类型分词,将查询条件分词之后进行查询，如果该字段不分词就会将查询条件作为整体进行查询。</font></p>
<h3 id="match-phrase-query短语查询"><a href="#match-phrase-query短语查询" class="headerlink" title="match_phrase query短语查询"></a><strong>match_phrase query短语查询</strong></h3><p>短语搜索(match phrase)会对搜索文本进行文本分析，然后到索引中寻找搜索的每个分词并<font color="red">要求分词相邻</font>，你可以通过调整slop参数设置分词出现的最大间隔距离。<font color="red">match_phrase 会将检索关键词分词。</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_phrase"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: <span class="string">"广州白云山"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_phrase"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: <span class="string">"广州白云"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">思考：为什么查询广州白云山有数据，广州白云没有数据？</font></p>
<p><img src="/../img/1718729012065.png" alt="1718729012065"></p>
<p>分析原因：</p>
<p>先查看广州白云山公园分词结果，可以知道广州和白云不是相邻的词条，中间会隔一个白云山，而match_phrase匹配的是相邻的词条，所以查询广州白云山有结果，但查询广州白云没有结果。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> _analyze</span><br><span class="line">{</span><br><span class="line">    <span class="string">"analyzer"</span>:<span class="string">"ik_max_word"</span>,</span><br><span class="line">    <span class="string">"text"</span>:<span class="string">"广州白云山"</span></span><br><span class="line">}</span><br><span class="line">#结果</span><br><span class="line">{</span><br><span class="line">  <span class="string">"tokens"</span> : [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"token"</span> : <span class="string">"广州"</span>,</span><br><span class="line">      <span class="string">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="string">"end_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="string">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="string">"position"</span> : <span class="number">0</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"token"</span> : <span class="string">"白云山"</span>,</span><br><span class="line">      <span class="string">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="string">"end_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="string">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="string">"position"</span> : <span class="number">1</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"token"</span> : <span class="string">"白云"</span>,</span><br><span class="line">      <span class="string">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="string">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="string">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="string">"position"</span> : <span class="number">2</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"token"</span> : <span class="string">"云山"</span>,</span><br><span class="line">      <span class="string">"start_offset"</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="string">"end_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="string">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="string">"position"</span> : <span class="number">3</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如何解决词条间隔的问题？可以借助slop参数，<font color="red">slop参数告诉match_phrase查询词条能够相隔多远时仍然将文档视为匹配。</font></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#广州云山分词后相隔为<span class="number">2</span>，可以匹配到结果</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_phrase"</span>: {</span><br><span class="line">      <span class="string">"address"</span>: {</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"广州云山"</span>,</span><br><span class="line">        <span class="string">"slop"</span>: <span class="number">2</span></span><br><span class="line">      } </span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="query-string-query"><a href="#query-string-query" class="headerlink" title="query_string query"></a><strong>query_string query</strong></h3><p>允许我们在单个查询字符串中指定AND | OR | NOT条件，同时也和 multi_match query 一样，支持多字段搜索。和match类似，但是match需要指定字段名，query_string是在所有字段中搜索，范围更广泛。</p>
<p><font color="red">注意: 查询字段分词就将查询条件分词查询，查询字段不分词将查询条件不分词查询</font></p>
<ul>
<li><strong>未指定字段查询</strong></li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># <span class="variable constant_">AND</span> 要求大写</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"query_string"</span>: {</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"赵六 AND 橘子洲"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><strong>指定单个字段查询</strong></li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#<span class="title class_">Query</span> <span class="title class_">String</span></span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"query_string"</span>: {</span><br><span class="line">      <span class="string">"default_field"</span>: <span class="string">"address"</span>,</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"白云山 OR 橘子洲"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><strong>指定多个字段查询</strong></li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"query_string"</span>: {</span><br><span class="line">      <span class="string">"fields"</span>: [<span class="string">"name"</span>,<span class="string">"address"</span>],</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"张三 OR (广州 AND 王五)"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="simple-query-string"><a href="#simple-query-string" class="headerlink" title="simple_query_string"></a><strong>simple_query_string</strong></h3><p>类似Query String，但是会忽略错误的语法,同时只支持部分查询语法，不支持AND OR NOT，会当作字符串处理。支持部分逻辑：</p>
<ul>
<li>+ 替代AND</li>
<li>| 替代OR</li>
<li>- 替代NOT</li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#simple_query_string 默认的operator是<span class="variable constant_">OR</span></span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"simple_query_string"</span>: {</span><br><span class="line">      <span class="string">"fields"</span>: [<span class="string">"name"</span>,<span class="string">"address"</span>],</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"广州公园"</span>,</span><br><span class="line">      <span class="string">"default_operator"</span>: <span class="string">"AND"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"simple_query_string"</span>: {</span><br><span class="line">      <span class="string">"fields"</span>: [<span class="string">"name"</span>,<span class="string">"address"</span>],</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"广州 + 公园"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>​	</p>
<h2 id="4、bool-query布尔查询"><a href="#4、bool-query布尔查询" class="headerlink" title="4、bool query布尔查询"></a>4、bool query布尔查询</h2><p>布尔查询可以按照布尔逻辑条件组织多条查询语句，只有符合整个布尔条件的文档才会被搜索出来。</p>
<p>在布尔条件中，可以包含两种不同的上下文。</p>
<ol>
<li>**搜索上下文(query context)**：使用搜索上下文时，Elasticsearch需要计算每个文档与搜索条件的相关度得分，这个得分的计算需使用一套复杂的计算公式，<font color="red">有一定的性能开销，带文本分析的全文检索的查询语句很适合放在搜索上下文中。</font></li>
<li>**过滤上下文(filter context)**：使用过滤上下文时，Elasticsearch只需要判断搜索条件跟文档数据是否匹配，例如使用Term query判断一个值是否跟搜索内容一致，使用Range query判断某数据是否位于某个区间等。<font color="red">过滤上下文的查询不需要进行相关度得分计算，还可以使用缓存加快响应速度，很多术语级查询语句都适合放在过滤上下文中。</font></li>
</ol>
<p>布尔查询一共支持4种组合类型:</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>must</td>
<td>可包含多个查询条件，每个条件均满足的文档才能被搜索到，每次查询需要计算相关度得分，属于搜索上下文</td>
</tr>
<tr>
<td>should</td>
<td>可包含多个查询条件，不存在must和fiter条件时，至少要满足多个查询条件中的一个，文档才能被搜索到，否则需满足的条件数量不受限制,匹配到的查询越多相关度越高，也属于搜索上下文</td>
</tr>
<tr>
<td>filter</td>
<td>可包含多个过滤条件，每个条件均满足的文档才能被搜索到，每个过滤条件不计算相关度得分，结果在一定条件下会被缓存， 属于过滤上下文</td>
</tr>
<tr>
<td>must_not</td>
<td>可包含多个过滤条件，每个条件均不满足的文档才能被搜索到，每个过滤条件不计算相关度得分，结果在一定条</td>
</tr>
</tbody></table>
<p>示例</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">PUT</span> /books</span><br><span class="line">{</span><br><span class="line">  <span class="string">"settings"</span>: {</span><br><span class="line">    <span class="string">"number_of_replicas"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"number_of_shards"</span>: <span class="number">1</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"mappings"</span>: {</span><br><span class="line">    <span class="string">"properties"</span>: {</span><br><span class="line">      <span class="string">"id"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"long"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"title"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"language"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"author"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"price"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"double"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"publish_time"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">        <span class="string">"format"</span>: <span class="string">"yyy-MM-dd"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"description"</span>: {</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">POST</span> /_bulk</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_index"</span>:<span class="string">"books"</span>,<span class="string">"_id"</span>:<span class="string">"1"</span>}}</span><br><span class="line">{<span class="string">"id"</span>:<span class="string">"1"</span>, <span class="string">"title"</span>:<span class="string">"Java编程思想"</span>, <span class="string">"language"</span>:<span class="string">"java"</span>, <span class="string">"author"</span>:<span class="string">"Bruce Eckel"</span>, <span class="string">"price"</span>:<span class="number">70.20</span>, <span class="string">"publish_time"</span>:<span class="string">"2007-10-01"</span>, <span class="string">"description"</span>:<span class="string">"Java学习必读经典，殿堂级著作！赢得了全球程序员的广泛赞誉。"</span>}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_index"</span>:<span class="string">"books"</span>,<span class="string">"_id"</span>:<span class="string">"2"</span>}}</span><br><span class="line">{<span class="string">"id"</span>:<span class="string">"2"</span>,<span class="string">"title"</span>:<span class="string">"Java程序性能优化"</span>,<span class="string">"language"</span>:<span class="string">"java"</span>,<span class="string">"author"</span>:<span class="string">"葛一鸣"</span>,<span class="string">"price"</span>:<span class="number">46.5</span>,<span class="string">"publish_time"</span>:<span class="string">"2012-08-01"</span>,<span class="string">"description"</span>:<span class="string">"让你的Java程序更快、更稳定。深入剖析软件设计层面、代码层面、JVM虚拟机层面的优化方法"</span>}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_index"</span>:<span class="string">"books"</span>,<span class="string">"_id"</span>:<span class="string">"3"</span>}}</span><br><span class="line">{<span class="string">"id"</span>:<span class="string">"3"</span>,<span class="string">"title"</span>:<span class="string">"Python科学计算"</span>,<span class="string">"language"</span>:<span class="string">"python"</span>,<span class="string">"author"</span>:<span class="string">"张若愚"</span>,<span class="string">"price"</span>:<span class="number">81.4</span>,<span class="string">"publish_time"</span>:<span class="string">"2016-05-01"</span>,<span class="string">"description"</span>:<span class="string">"零基础学python，光盘中作者独家整合开发winPython运行环境，涵盖了Python各个扩展库"</span>}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_index"</span>:<span class="string">"books"</span>,<span class="string">"_id"</span>:<span class="string">"4"</span>}}</span><br><span class="line">{<span class="string">"id"</span>:<span class="string">"4"</span>, <span class="string">"title"</span>:<span class="string">"Python基础教程"</span>, <span class="string">"language"</span>:<span class="string">"python"</span>, <span class="string">"author"</span>:<span class="string">"Helant"</span>, <span class="string">"price"</span>:<span class="number">54.50</span>, <span class="string">"publish_time"</span>:<span class="string">"2014-03-01"</span>, <span class="string">"description"</span>:<span class="string">"经典的Python入门教程，层次鲜明，结构严谨，内容翔实"</span>}</span><br><span class="line">{<span class="string">"index"</span>:{<span class="string">"_index"</span>:<span class="string">"books"</span>,<span class="string">"_id"</span>:<span class="string">"5"</span>}}</span><br><span class="line">{<span class="string">"id"</span>:<span class="string">"5"</span>,<span class="string">"title"</span>:<span class="string">"JavaScript高级程序设计"</span>,<span class="string">"language"</span>:<span class="string">"javascript"</span>,<span class="string">"author"</span>:<span class="string">"Nicholas C. Zakas"</span>,<span class="string">"price"</span>:<span class="number">66.4</span>,<span class="string">"publish_time"</span>:<span class="string">"2012-10-01"</span>,<span class="string">"description"</span>:<span class="string">"JavaScript技术经典名著"</span>}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">GET</span> /books/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"bool"</span>: {</span><br><span class="line">      <span class="string">"must"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"match"</span>: {</span><br><span class="line">            <span class="string">"title"</span>: <span class="string">"java编程"</span></span><br><span class="line">          }</span><br><span class="line">        },{</span><br><span class="line">          <span class="string">"match"</span>: {</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"性能优化"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">GET</span> /books/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"bool"</span>: {</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"match"</span>: {</span><br><span class="line">            <span class="string">"title"</span>: <span class="string">"java编程"</span></span><br><span class="line">          }</span><br><span class="line">        },{</span><br><span class="line">          <span class="string">"match"</span>: {</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"性能优化"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"minimum_should_match"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="variable constant_">GET</span> /books/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"bool"</span>: {</span><br><span class="line">      <span class="string">"filter"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"term"</span>: {</span><br><span class="line">            <span class="string">"language"</span>: <span class="string">"java"</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"range"</span>: {</span><br><span class="line">            <span class="string">"publish_time"</span>: {</span><br><span class="line">              <span class="string">"gte"</span>: <span class="string">"2010-08-01"</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="5、highlight高亮"><a href="#5、highlight高亮" class="headerlink" title="5、highlight高亮"></a>5、highlight高亮</h2><p>highlight 关键字: 可以让符合条件的文档中的关键词高亮。</p>
<p>highlight相关属性：</p>
<ul>
<li>pre_tags 前缀标签</li>
<li>post_tags 后缀标签</li>
<li>tags_schema 设置为styled可以使用内置高亮样式</li>
<li>require_field_match 多字段高亮需要设置为false</li>
</ul>
<p>示例数据</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#指定ik分词器</span><br><span class="line"><span class="variable constant_">PUT</span> /products</span><br><span class="line">{</span><br><span class="line">  <span class="string">"settings"</span> : {</span><br><span class="line">      <span class="string">"index"</span> : {</span><br><span class="line">          <span class="string">"analysis.analyzer.default.type"</span>: <span class="string">"ik_max_word"</span></span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /products/_doc/<span class="number">1</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"proId"</span> : <span class="string">"2"</span>,</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"牛仔男外套"</span>,</span><br><span class="line">  <span class="string">"desc"</span> : <span class="string">"牛仔外套男装春季衣服男春装夹克修身休闲男生潮牌工装潮流头号青年春秋棒球服男 7705浅蓝常规 XL"</span>,</span><br><span class="line">  <span class="string">"timestamp"</span> : <span class="number">1576313264451</span>,</span><br><span class="line">  <span class="string">"createTime"</span> : <span class="string">"2019-12-13 12:56:56"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PUT</span> /products/_doc/<span class="number">2</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"proId"</span> : <span class="string">"6"</span>,</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"HLA海澜之家牛仔裤男"</span>,</span><br><span class="line">  <span class="string">"desc"</span> : <span class="string">"HLA海澜之家牛仔裤男2019时尚有型舒适HKNAD3E109A 牛仔蓝(A9)175/82A(32)"</span>,</span><br><span class="line">  <span class="string">"timestamp"</span> : <span class="number">1576314265571</span>,</span><br><span class="line">  <span class="string">"createTime"</span> : <span class="string">"2019-12-18 15:56:56"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /products/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"term"</span>: {</span><br><span class="line">      <span class="string">"name"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"牛仔"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"highlight"</span>: {</span><br><span class="line">    <span class="string">"fields"</span>: {</span><br><span class="line">      <span class="string">"*"</span>:{}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="自定义高亮html标签"><a href="#自定义高亮html标签" class="headerlink" title="自定义高亮html标签"></a>自定义高亮html标签</h3><p>可以在highlight中使用pre_tags和post_tags</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /products/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"multi_match"</span>: {</span><br><span class="line">      <span class="string">"fields"</span>: [<span class="string">"name"</span>,<span class="string">"desc"</span>],</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"牛仔"</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"highlight"</span>: {</span><br><span class="line">    <span class="string">"post_tags"</span>: [<span class="string">"&lt;/span&gt;"</span>], </span><br><span class="line">    <span class="string">"pre_tags"</span>: [<span class="string">"&lt;span style='color:red'&gt;"</span>],</span><br><span class="line">    <span class="string">"fields"</span>: {</span><br><span class="line">      <span class="string">"*"</span>:{}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="多字段高亮"><a href="#多字段高亮" class="headerlink" title="多字段高亮"></a>多字段高亮</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /products/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"term"</span>: {</span><br><span class="line">      <span class="string">"name"</span>: {</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"牛仔"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"highlight"</span>: {</span><br><span class="line">    <span class="string">"pre_tags"</span>: [<span class="string">"&lt;font color='red'&gt;"</span>],</span><br><span class="line">    <span class="string">"post_tags"</span>: [<span class="string">"&lt;font/&gt;"</span>],</span><br><span class="line">    <span class="string">"require_field_match"</span>: <span class="string">"false"</span>,</span><br><span class="line">    <span class="string">"fields"</span>: {</span><br><span class="line">      <span class="string">"name"</span>: {},</span><br><span class="line">      <span class="string">"desc"</span>: {}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1 id="二、ES-深度分页问题及针对不同需求下的解决方案"><a href="#二、ES-深度分页问题及针对不同需求下的解决方案" class="headerlink" title="二、ES 深度分页问题及针对不同需求下的解决方案"></a>二、<strong>ES 深度分页问题及针对不同需求下的解决方案</strong></h1><h2 id="1、什么是深度分页"><a href="#1、什么是深度分页" class="headerlink" title="1、什么是深度分页"></a>1、<strong>什么是深度分页</strong></h2><p>分页问题是Elasticsearch中最常见的查询场景之一，正常情况下分页代码如实下面这样的：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 查询第一页<span class="number">5</span>条数据</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">    <span class="string">"match_all"</span>: {}</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"from"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">5</span>  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>输出结果如下图：</p>
<p><img src="/../img/1718893331168.png" alt="1718893331168"></p>
<p>但是如果我们查询的数据页数特别大，当from + size大于10000的时候，就会出现问题，如下图报错信息所示：</p>
<p><img src="/../img/1718893342891.png" alt="1718893342891"></p>
<p>ES通过参数index.max_result_window用来限制单次查询满足查询条件的结果窗口的大小，其默认值为10000。</p>
<h2 id="2、深度分页会带来什么问题"><a href="#2、深度分页会带来什么问题" class="headerlink" title="2、深度分页会带来什么问题"></a>2、<strong>深度分页会带来什么问题</strong></h2><p>ES分页查询流程大致如下：</p>
<ol>
<li>数据存储在各个分片中，协调节点将查询请求转发给各个节点，当各个节点执行搜索后，将排序后的前N条数据返回给协调节点。</li>
<li>协调节点汇总各个分片返回的数据，再次排序，最终返回前N条数据给客户端。</li>
<li>这个流程会导致一个深度分页的问题，也就是翻页越多，性能越差，甚至导致ES出现OOM。</li>
</ol>
<p><font color="red">在分布式系统中，对结果排序的成本随分页的深度成指数上升。</font></p>
<p>从10万名高考生中查询成绩为的10001-10100位的100名考生的信息。</p>
<p><img src="/../img/1718893515476.png" alt="1718893515476"></p>
<p>从上面案例中不难看出，每次有序的查询都会在每个分片中执行单独的查询，然后进行数据的二次排序，而这个二次排序的过程是发生在heap中的，也就是说当你单次查询的数量越大，那么堆内存中汇总的数据也就越多，对内存的压力也就越大。这里的单次查询的数据量取决于你查询的是第几条数据而不是查询了几条数据，比如你希望查询的是第10001-10100这一百条数据，但是ES必须将前10100全部取出进行二次查询。因此，<font color="red">如果查询的数据排序越靠后，就越容易导致OOM（Out Of Memory）情况的发生，频繁的深分页查询会导致频繁的FGC。</font></p>
<p>ES为了避免用户在不了解其内部原理的情况下而做出错误的操作，设置了一个阈值，即max_result_window，其默认值为10000，<font color="red">其作用是为了保护堆内存不被错误操作导致溢出。</font></p>
<h2 id="3、深度分页问题的常见解决方案"><a href="#3、深度分页问题的常见解决方案" class="headerlink" title="3、深度分页问题的常见解决方案"></a>3、深度分页问题的常见解决方案</h2><h4 id="尝试避免使用深度分页"><a href="#尝试避免使用深度分页" class="headerlink" title="尝试避免使用深度分页"></a><strong>尝试避免使用深度分页</strong></h4><p><font color="red">解决深度分页问题最好的办法就是避免使用深度分页。</font>谷歌、<a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=Elasticsearch&amp;rsv_spt=1&amp;rsv_iqid=0xd60a59ec0010ac70&amp;issp=1&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;rsv_dl=tb&amp;rsv_sug3=14&amp;rsv_sug1=12&amp;rsv_sug7=100&amp;rsv_sug2=0&amp;rsv_btype=i&amp;prefixsug=>lasticsearch&amp;rsp=5&amp;inputT=3940&amp;rsv_sug4=4336">百度</a>目前作为全球和国内做大的搜索引擎不约而同的在分页条中删除了“跳页”功能，其目的就是为了避免用户使用深度分页检索。</p>
<p><img src="/../img/1718893661299.png" alt="1718893661299"></p>
<p><img src="/../img/1718893664828.png" alt="1718893664828"></p>
<p><a target="_blank" rel="noopener" href="https://s.taobao.com/search?q=%E8%A1%A3%E6%9C%8D&amp;commend=all&amp;ssid=s5-e&amp;search_type=item&amp;sourceId=tb.index&amp;spm=a21bo.jianhua.201856-taobao-item.2&amp;ie=utf8&amp;initiative_id=tbindexz_20170306">淘宝</a>虽然没有删除“跳页”功能，但不管我们搜索什么内容，只要商品结果足够多，返回的商品列表都是仅展示前100页的数据，其本质和ES中的max_result_window作用是一样的，都是限制你去搜索更深页数的数据</p>
<p><img src="/../img/1718893683615.png" alt="1718893683615"></p>
<p>手机端APP就更不用说了，直接是下拉加载更多，连分页条都没有，相当于你只能点击“下一页”。</p>
<h4 id="滚动查询"><a href="#滚动查询" class="headerlink" title="滚动查询"></a>滚动查询</h4><p>scroll滚动搜索是先搜索一批数据，然后下次再搜索下一批数据，以此类推，直到搜索出全部的数据来。</p>
<p>scroll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该视图快照搜索数据，如果在搜索期间数据发生了变更，用户是看不到变更的数据的。因此，<font color="red">滚动查询不适合实时性要求高的搜索场景。</font></p>
<p><font color="red">官方已不推荐使用滚动查询进行深度分页查询</font>，因为无法保存索引状态。</p>
<p><strong>适合场景</strong></p>
<p>单个<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/paginate-search-results.html#scroll-search-results">滚动搜索</a>请求中检索大量结果，即非“C端业务”场景</p>
<p><strong>使用</strong></p>
<p>1）第一次进行scroll查询：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查询命令中新增scroll=1m,说明采用游标查询，保持游标查询窗口<span class="number">1</span>分钟，也就是本次快照的结果缓存起来的有效时间是<span class="number">1</span>分钟。</span><br><span class="line"><span class="variable constant_">GET</span> /es_db/_search?scroll=1m </span><br><span class="line">{</span><br><span class="line">    <span class="string">"query"</span>: { <span class="string">"match_all"</span>: {}},</span><br><span class="line">    <span class="string">"size"</span>:  <span class="number">2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果：除了返回前2条记录，还返回了一个游标ID值_scroll_id。</p>
<p><img src="/../img/1718893791845.png" alt="1718893791845"></p>
<p>2）从第二次查询开始，每次查询都要指定_scroll_id参数：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># scroll_id 的值就是上一个请求中返回的 _scroll_id 的值</span><br><span class="line"><span class="variable constant_">GET</span> /_search/scroll</span><br><span class="line">{</span><br><span class="line">    <span class="string">"scroll"</span>: <span class="string">"1m"</span>, </span><br><span class="line">    <span class="string">"scroll_id"</span> : <span class="string">"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFmNwcVdjblRxUzVhZXlicG9HeU02bWcAAAAAAABmzRY2YlV3Z0o5VVNTdWJobkE5Z3MtXzJB"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果：</p>
<p><img src="/../img/1718893824758.png" alt="1718893824758"></p>
<p>多次根据scroll_id游标查询，直到没有数据返回则结束查询。采用游标查询索引全量数据，更安全高效，限制了单次对内存的消耗。</p>
<p><strong>删除游标scroll</strong></p>
<p>scroll超过超时后，搜索上下文会自动删除。然而，保持scroll打开是有代价的，因此一旦不再使用，就应明确清除scroll上下文</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">DELETE</span> /_search/scroll</span><br><span class="line">{</span><br><span class="line">    <span class="string">"scroll_id"</span> : <span class="string">"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFmNwcVdjblRxUzVhZXlicG9HeU02bWcAAAAAAABmzRY2YlV3Z0o5VVNTdWJobkE5Z3MtXzJB"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意事项</strong></p>
<ul>
<li>scroll滚动查询不适合实时性要求高的查询场景，比较适合数据迁移的场景。</li>
<li>scroll查询完毕后，要手动清理掉 scroll_id 。虽然ES有自动清理机制，但是 srcoll_id 的存在会耗费大量的资源来保存一份当前查询结果集映像，并且会占用文件描述符。</li>
</ul>
<p>官方建议：ES7之后，不再建议使用scroll API进行深度分页。<font color="red">如果要分页检索超过 Top 10,000+ 结果时，推荐使用：PIT + search_after。</font></p>
<h4 id="search-after"><a href="#search-after" class="headerlink" title="search_after"></a><strong>search_after</strong></h4><p>参考文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/paginate-search-results.html#search-after">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/paginate-search-results.html#search-after</a></p>
<p>scroll API适用于高效的深度滚动，但滚动上下文成本高昂，不建议将其用于实时用户请求。而search_after参数通过提供一个活动光标来规避这个问题。这样可以使用上一页的结果来帮助检索下一页。</p>
<p>search_after 分页查询可以简单概括为如下几个步骤：</p>
<p><strong>1）获取索引的pit</strong></p>
<p>使用 search_after 需要具有相同查询和排序值的多个搜索请求。 如果在这些请求之间发生刷新，结果的顺序可能会发生变化，从而导致跨页面的结果不一致。 为防止出现这种情况，<font color="red">可以创建一个时间点 (PIT) 以保留搜索中的当前索引状态。</font>Point In Time（PIT）是 Elasticsearch 7.10 版本之后才有的新特性。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个时间点(<span class="variable constant_">PIT</span>)来保存搜索期间的当前索引状态</span><br><span class="line"><span class="variable constant_">POST</span> /es_db/_pit?keep_alive=1m</span><br><span class="line">#返回结果，会返回一个<span class="variable constant_">PID</span>的值</span><br><span class="line">{</span><br><span class="line">  <span class="string">"id"</span> : <span class="string">"39K1AwEFZXNfZGIWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAWdkhjbE9YNVRTMUNDcWNQQVR2ZXYzdwAAAAAAAAA9jhZvaGpLSDlzVVMxbW5idG5DZ0xEUHFRAAEWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAA"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>2） 根据pit首次查询</strong></p>
<p>根据pit查询的时候，不用指定索引的名词</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">        <span class="string">"match_all"</span>: {}</span><br><span class="line">    },</span><br><span class="line">  <span class="string">"pit"</span>: {</span><br><span class="line">        <span class="string">"id"</span>:  <span class="string">"39K1AwEFZXNfZGIWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAWdkhjbE9YNVRTMUNDcWNQQVR2ZXYzdwAAAAAAAAA9jhZvaGpLSDlzVVMxbW5idG5DZ0xEUHFRAAEWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAA"</span>, </span><br><span class="line">        <span class="string">"keep_alive"</span>: <span class="string">"1m"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">2</span>, </span><br><span class="line">  <span class="string">"sort"</span>: [</span><br><span class="line">        {<span class="string">"_id"</span>: <span class="string">"asc"</span>}    </span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>返回结果：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="string">"pit_id"</span> : <span class="string">"39K1AwEFZXNfZGIWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAWdkhjbE9YNVRTMUNDcWNQQVR2ZXYzdwAAAAAAAAA7hRZvaGpLSDlzVVMxbW5idG5DZ0xEUHFRAAEWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAA"</span>,</span><br><span class="line">  <span class="string">"took"</span> : <span class="number">16</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : {</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">"failed"</span> : <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"hits"</span> : {</span><br><span class="line">    <span class="string">"total"</span> : {</span><br><span class="line">      <span class="string">"value"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="string">"relation"</span> : <span class="string">"eq"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"max_score"</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"hits"</span> : [</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"_index"</span> : <span class="string">"es_db"</span>,</span><br><span class="line">        <span class="string">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="string">"_score"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"_source"</span> : {</span><br><span class="line">          <span class="string">"name"</span> : <span class="string">"李四"</span>,</span><br><span class="line">          <span class="string">"sex"</span> : <span class="number">1</span>,</span><br><span class="line">          <span class="string">"age"</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="string">"address"</span> : <span class="string">"广州荔湾大厦"</span>,</span><br><span class="line">          <span class="string">"remark"</span> : <span class="string">"java assistant"</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"sort"</span> : [</span><br><span class="line">          <span class="string">"2"</span>,</span><br><span class="line">          <span class="number">0</span></span><br><span class="line">        ]</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"_index"</span> : <span class="string">"es_db"</span>,</span><br><span class="line">        <span class="string">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"3"</span>,</span><br><span class="line">        <span class="string">"_score"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"_source"</span> : {</span><br><span class="line">          <span class="string">"name"</span> : <span class="string">"王五"</span>,</span><br><span class="line">          <span class="string">"sex"</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">"age"</span> : <span class="number">26</span>,</span><br><span class="line">          <span class="string">"address"</span> : <span class="string">"广州白云山公园"</span>,</span><br><span class="line">          <span class="string">"remark"</span> : <span class="string">"php developer"</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"sort"</span> : [</span><br><span class="line">          <span class="string">"3"</span>,</span><br><span class="line">          <span class="number">1</span></span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3）根据search_after和pit进行翻页查询</strong></p>
<p>要获得下一页结果，请使用最后一次命中的排序值（包括 tiebreaker）作为 search_after 参数重新运行先前的搜索。 如果使用 PIT，请在 pit.id 参数中使用最新的 PIT ID。 搜索的查询和排序参数必须保持不变。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#search_after指定为上一次查询返回的sort值。</span><br><span class="line"><span class="variable constant_">GET</span> /_search</span><br><span class="line">{</span><br><span class="line">  <span class="string">"query"</span>: {</span><br><span class="line">        <span class="string">"match_all"</span>: {}</span><br><span class="line">    },</span><br><span class="line">  <span class="string">"pit"</span>: {</span><br><span class="line">        <span class="string">"id"</span>:  <span class="string">"39K1AwEFZXNfZGIWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAWdkhjbE9YNVRTMUNDcWNQQVR2ZXYzdwAAAAAAAAA9jhZvaGpLSDlzVVMxbW5idG5DZ0xEUHFRAAEWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAA"</span>, </span><br><span class="line">        <span class="string">"keep_alive"</span>: <span class="string">"1m"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">2</span>, </span><br><span class="line">  <span class="string">"sort"</span>: [</span><br><span class="line">        {<span class="string">"_id"</span>: <span class="string">"asc"</span>}    </span><br><span class="line">    ],</span><br><span class="line">  <span class="string">"search_after"</span>: [                                </span><br><span class="line">    <span class="number">3</span></span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>返回结果：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="string">"pit_id"</span> : <span class="string">"39K1AwEFZXNfZGIWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAWdkhjbE9YNVRTMUNDcWNQQVR2ZXYzdwAAAAAAAAA8wxZvaGpLSDlzVVMxbW5idG5DZ0xEUHFRAAEWZTN2N2Nrdk5RRjY3QjBma1h5aFRodwAA"</span>,</span><br><span class="line">  <span class="string">"took"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : {</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">"failed"</span> : <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"hits"</span> : {</span><br><span class="line">    <span class="string">"total"</span> : {</span><br><span class="line">      <span class="string">"value"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="string">"relation"</span> : <span class="string">"eq"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"max_score"</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"hits"</span> : [</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"_index"</span> : <span class="string">"es_db"</span>,</span><br><span class="line">        <span class="string">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"4"</span>,</span><br><span class="line">        <span class="string">"_score"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"_source"</span> : {</span><br><span class="line">          <span class="string">"name"</span> : <span class="string">"赵六"</span>,</span><br><span class="line">          <span class="string">"sex"</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">"age"</span> : <span class="number">22</span>,</span><br><span class="line">          <span class="string">"address"</span> : <span class="string">"长沙橘子洲"</span>,</span><br><span class="line">          <span class="string">"remark"</span> : <span class="string">"python assistant"</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"sort"</span> : [</span><br><span class="line">          <span class="string">"4"</span></span><br><span class="line">        ]</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"_index"</span> : <span class="string">"es_db"</span>,</span><br><span class="line">        <span class="string">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"5"</span>,</span><br><span class="line">        <span class="string">"_score"</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"_source"</span> : {</span><br><span class="line">          <span class="string">"name"</span> : <span class="string">"张龙"</span>,</span><br><span class="line">          <span class="string">"sex"</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="string">"age"</span> : <span class="number">19</span>,</span><br><span class="line">          <span class="string">"address"</span> : <span class="string">"长沙麓谷企业广场"</span>,</span><br><span class="line">          <span class="string">"remark"</span> : <span class="string">"java architect assistant"</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"sort"</span> : [</span><br><span class="line">          <span class="string">"5"</span></span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h2><table>
<thead>
<tr>
<th>分页方式</th>
<th>性能</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>from + size</td>
<td>低</td>
<td>灵活性好，实现简单，支持随机翻页</td>
<td>受制于max_result_window设置，不能无限制翻页；存在深度翻译问题，越往后翻译越慢。</td>
<td>数据量比较小，能容忍深度分页问题</td>
</tr>
<tr>
<td>scroll</td>
<td>中</td>
<td>解决了深度分页问题</td>
<td>scroll查询的相应数据是非实时的，如果遍历过程中插入新的数据，是查询不到的；保留上下文需要足够的堆内存空间。</td>
<td>海量数据的导出，需要查询海量结果集的数据</td>
</tr>
<tr>
<td>search_after</td>
<td>高</td>
<td>性能最好，不存在深度分页问题，能够反映数据的实时变更</td>
<td>实现复杂，需要有一个全局唯一的字段连续分页的实现会比较复杂，因为每一次查询都需要上次查询的结果，它不适用于大幅度跳页查询</td>
<td>海量数据的分页</td>
</tr>
</tbody></table>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Radish</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/">http://example.com/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">萝卜的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="/../img/es_logo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/21/PyTorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/" title="PyTorch深度学习快速入门(一)-环境安装"><img class="cover" src="/../img/pytorch.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PyTorch深度学习快速入门(一)-环境安装</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/11/ES(%E4%B8%80)-ElasticSearch%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/" title="ES(一)-ElasticSearch快速入门实战"><img class="cover" src="/../img/es_logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ES(一)-ElasticSearch快速入门实战</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/06/11/ES(%E4%B8%80)-ElasticSearch%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/" title="ES(一)-ElasticSearch快速入门实战"><img class="cover" src="/../img/es_logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-11</div><div class="title">ES(一)-ElasticSearch快速入门实战</div></div></a></div><div><a href="/2024/06/26/ES(%E4%B8%89)-ElasticSearch%E6%90%9C%E7%B4%A2%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%85%A5%E4%B8%8E%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E5%AE%9E%E6%88%98/" title="ES(三)-ElasticSearch搜索技术深入与聚合查询实战"><img class="cover" src="/../img/es_logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-26</div><div class="title">ES(三)-ElasticSearch搜索技术深入与聚合查询实战</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Radish</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">愿内心深处的懦弱 不再将我吞噬</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81ES%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2Query-DSL"><span class="toc-number">1.</span> <span class="toc-text">一、ES高级查询Query DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81match-all"><span class="toc-number">1.1.</span> <span class="toc-text">1、match_all</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%BA%90%E6%95%B0%E6%8D%AE-source"><span class="toc-number">1.1.1.</span> <span class="toc-text">返回源数据_source</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%8C%87%E5%AE%9A%E6%9D%A1%E6%95%B0size"><span class="toc-number">1.1.2.</span> <span class="toc-text">返回指定条数size</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2from-amp-size"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">分页查询from&amp;size</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8Fsort"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">指定字段排序sort</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%9C%AF%E8%AF%AD%E7%BA%A7%E5%88%AB%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.</span> <span class="toc-text">2、术语级别查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Term-query%E6%9C%AF%E8%AF%AD%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.1.</span> <span class="toc-text">Term query术语查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Terms-Query%E5%A4%9A%E6%9C%AF%E8%AF%AD%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.2.</span> <span class="toc-text">Terms Query多术语查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exists-query"><span class="toc-number">1.2.3.</span> <span class="toc-text">exists query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ids-query"><span class="toc-number">1.2.4.</span> <span class="toc-text">ids query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#range-query%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.5.</span> <span class="toc-text">range query范围查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prefix-query%E5%89%8D%E7%BC%80%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.6.</span> <span class="toc-text">prefix query前缀查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wildcard-query%E9%80%9A%E9%85%8D%E7%AC%A6%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.7.</span> <span class="toc-text">wildcard query通配符查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fuzzy-query%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.8.</span> <span class="toc-text">fuzzy query模糊查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">1.3.</span> <span class="toc-text">3、全文检索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#match-query%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.1.</span> <span class="toc-text">match query匹配查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#multi-match-query-%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.2.</span> <span class="toc-text">multi_match query 多字段查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match-phrase-query%E7%9F%AD%E8%AF%AD%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.3.</span> <span class="toc-text">match_phrase query短语查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#query-string-query"><span class="toc-number">1.3.4.</span> <span class="toc-text">query_string query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#simple-query-string"><span class="toc-number">1.3.5.</span> <span class="toc-text">simple_query_string</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81bool-query%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.</span> <span class="toc-text">4、bool query布尔查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81highlight%E9%AB%98%E4%BA%AE"><span class="toc-number">1.5.</span> <span class="toc-text">5、highlight高亮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%AB%98%E4%BA%AEhtml%E6%A0%87%E7%AD%BE"><span class="toc-number">1.5.1.</span> <span class="toc-text">自定义高亮html标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AD%97%E6%AE%B5%E9%AB%98%E4%BA%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">多字段高亮</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ES-%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98%E5%8F%8A%E9%92%88%E5%AF%B9%E4%B8%8D%E5%90%8C%E9%9C%80%E6%B1%82%E4%B8%8B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">二、ES 深度分页问题及针对不同需求下的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5"><span class="toc-number">2.1.</span> <span class="toc-text">1、什么是深度分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E4%BC%9A%E5%B8%A6%E6%9D%A5%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.</span> <span class="toc-text">2、深度分页会带来什么问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98%E7%9A%84%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.</span> <span class="toc-text">3、深度分页问题的常见解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">尝试避免使用深度分页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">滚动查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#search-after"><span class="toc-number">2.3.0.3.</span> <span class="toc-text">search_after</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">2.4.</span> <span class="toc-text">4、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/03/openVPN%E6%90%AD%E5%BB%BA/" title="OpenVPN搭建流程">OpenVPN搭建流程</a><time datetime="2024-08-03T06:17:00.000Z" title="发表于 2024-08-03 14:17:00">2024-08-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/26/ES(%E4%B8%89)-ElasticSearch%E6%90%9C%E7%B4%A2%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%85%A5%E4%B8%8E%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E5%AE%9E%E6%88%98/" title="ES(三)-ElasticSearch搜索技术深入与聚合查询实战"><img src="/../img/es_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES(三)-ElasticSearch搜索技术深入与聚合查询实战"></a><div class="content"><a class="title" href="/2024/06/26/ES(%E4%B8%89)-ElasticSearch%E6%90%9C%E7%B4%A2%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%85%A5%E4%B8%8E%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E5%AE%9E%E6%88%98/" title="ES(三)-ElasticSearch搜索技术深入与聚合查询实战">ES(三)-ElasticSearch搜索技术深入与聚合查询实战</a><time datetime="2024-06-26T12:23:00.000Z" title="发表于 2024-06-26 20:23:00">2024-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/21/PyTorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/" title="PyTorch深度学习快速入门(一)-环境安装"><img src="/../img/pytorch.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PyTorch深度学习快速入门(一)-环境安装"></a><div class="content"><a class="title" href="/2024/06/21/PyTorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/" title="PyTorch深度学习快速入门(一)-环境安装">PyTorch深度学习快速入门(一)-环境安装</a><time datetime="2024-06-21T15:37:00.000Z" title="发表于 2024-06-21 23:37:00">2024-06-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/" title="ES(二)-ElasticSearch高级语法Query DSL实战"><img src="/../img/es_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES(二)-ElasticSearch高级语法Query DSL实战"></a><div class="content"><a class="title" href="/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/" title="ES(二)-ElasticSearch高级语法Query DSL实战">ES(二)-ElasticSearch高级语法Query DSL实战</a><time datetime="2024-06-18T15:50:00.000Z" title="发表于 2024-06-18 23:50:00">2024-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/11/ES(%E4%B8%80)-ElasticSearch%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/" title="ES(一)-ElasticSearch快速入门实战"><img src="/../img/es_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES(一)-ElasticSearch快速入门实战"></a><div class="content"><a class="title" href="/2024/06/11/ES(%E4%B8%80)-ElasticSearch%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/" title="ES(一)-ElasticSearch快速入门实战">ES(一)-ElasticSearch快速入门实战</a><time datetime="2024-06-11T15:06:00.000Z" title="发表于 2024-06-11 23:06:00">2024-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2023 - 2024 By Radish</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>