<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL性能优化(三)——Mysql索引优化实战 | 萝卜的博客</title><meta name="author" content="Radish"><meta name="copyright" content="Radish"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="示例表 12345678910111213141516171819202122232425262728CREATE TABLE `employees` (  `id` int(11) NOT NULL AUTO_INCREMENT,  `name` varchar(24) NOT NULL DEFAULT &amp;#x27;&amp;#x27; COMMENT &amp;#x27;姓名&amp;#x27;,  `age` in">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL性能优化(三)——Mysql索引优化实战">
<meta property="og:url" content="http://example.com/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%B8%89)%E2%80%94%E2%80%94Mysql%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="萝卜的博客">
<meta property="og:description" content="示例表 12345678910111213141516171819202122232425262728CREATE TABLE `employees` (  `id` int(11) NOT NULL AUTO_INCREMENT,  `name` varchar(24) NOT NULL DEFAULT &amp;#x27;&amp;#x27; COMMENT &amp;#x27;姓名&amp;#x27;,  `age` in">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/MySQL.png">
<meta property="article:published_time" content="2024-04-18T14:59:00.000Z">
<meta property="article:modified_time" content="2024-06-16T08:49:53.956Z">
<meta property="article:author" content="Radish">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/MySQL.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%B8%89)%E2%80%94%E2%80%94Mysql%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL性能优化(三)——Mysql索引优化实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-16 16:49:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E9%9F%B3%E4%B9%90"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page child" href="/%E8%A7%86%E9%A2%91"><i class="fa-fw /movies/"></i><span> 1</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="萝卜的博客"><span class="site-name">萝卜的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E9%9F%B3%E4%B9%90"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page child" href="/%E8%A7%86%E9%A2%91"><i class="fa-fw /movies/"></i><span> 1</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">MySQL性能优化(三)——Mysql索引优化实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-18T14:59:00.000Z" title="发表于 2024-04-18 22:59:00">2024-04-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-16T08:49:53.956Z" title="更新于 2024-06-16 16:49:53">2024-06-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/">Java后端</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL性能优化(三)——Mysql索引优化实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><p><strong>示例表</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `employees` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(<span class="number">24</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'姓名'</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) NOT NULL DEFAULT <span class="string">'0'</span> COMMENT <span class="string">'年龄'</span>,</span><br><span class="line">  `position` varchar(<span class="number">20</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'职位'</span>,</span><br><span class="line">  `hire_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'入职时间'</span>,</span><br><span class="line">  PRIMARY <span class="title function_">KEY</span> <span class="params">(`id`)</span>,</span><br><span class="line">  KEY `idx_name_age_position` (`name`,`age`,`position`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8 COMMENT=<span class="string">'员工记录表'</span>;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="title function_">employees</span><span class="params">(name,age,position,hire_time)</span> VALUES(<span class="string">'LiLei'</span>,<span class="number">22</span>,<span class="string">'manager'</span>,NOW());</span><br><span class="line">INSERT INTO <span class="title function_">employees</span><span class="params">(name,age,position,hire_time)</span> VALUES(<span class="string">'HanMeimei'</span>, <span class="number">23</span>,<span class="string">'dev'</span>,NOW());</span><br><span class="line">INSERT INTO <span class="title function_">employees</span><span class="params">(name,age,position,hire_time)</span> VALUES(<span class="string">'Lucy'</span>,<span class="number">23</span>,<span class="string">'dev'</span>,NOW());</span><br><span class="line"></span><br><span class="line">-- 插入一些示例数据</span><br><span class="line">drop&nbsp;procedure&nbsp;<span class="keyword">if</span>&nbsp;exists&nbsp;insert_emp;&nbsp;</span><br><span class="line">delimiter&nbsp;;;</span><br><span class="line">create&nbsp;procedure&nbsp;<span class="title function_">insert_emp</span><span class="params">()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">begin</span><br><span class="line">&nbsp;&nbsp;declare&nbsp;i&nbsp;<span class="type">int</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;set&nbsp;i=<span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;<span class="keyword">while</span>(i&lt;=<span class="number">100000</span>)<span class="keyword">do</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;insert&nbsp;into&nbsp;<span class="title function_">employees</span><span class="params">(name,age,position)</span>&nbsp;values(CONCAT(<span class="string">'zhuge'</span>,i),i,<span class="string">'dev'</span>);&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;i=i+<span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;end&nbsp;<span class="keyword">while</span>;</span><br><span class="line">end;;</span><br><span class="line">delimiter&nbsp;;</span><br><span class="line">call&nbsp;<span class="title function_">insert_emp</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>1、联合索引第一个字段用范围不会走索引</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">&gt;</span> <span class="string">'LiLei'</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621382879.png" alt="1713621382879"></p>
<p>结论：联合索引第一个字段就用范围查找不会走索引，mysql内部可能觉得第一个字段就用范围，结果集应该很大，回表效率不高，还不如就全表扫描</p>
<p><strong>2、强制走索引</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees force index(idx_name_age_position) <span class="keyword">WHERE</span> name <span class="operator">&gt;</span> <span class="string">'LiLei'</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621423495.png" alt="1713621423495"></p>
<p>结论：虽然使用了强制走索引让联合索引第一个字段范围查找也走索引，扫描的行rows看上去也少了点，但是最终查找效率不一定比全表扫描高，因为回表效率不高</p>
<p>做了一个小实验：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 关闭查询缓存</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> query_cache_size<span class="operator">=</span><span class="number">0</span>;  </span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> query_cache_type<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="comment">-- 执行时间0.333s</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">&gt;</span> <span class="string">'LiLei'</span>;</span><br><span class="line"><span class="comment">-- 执行时间0.444s</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees force index(idx_name_age_position) <span class="keyword">WHERE</span> name <span class="operator">&gt;</span> <span class="string">'LiLei'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3、覆盖索引优化</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> name,age,position <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">&gt;</span> <span class="string">'LiLei'</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621481704.png" alt="1713621481704"></p>
<p><strong>4、in和or在表数据量比较大的情况会走索引，在表记录不多的情况下会选择全表扫描</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">in</span> (<span class="string">'LiLei'</span>,<span class="string">'HanMeimei'</span>,<span class="string">'Lucy'</span>) <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621510475.png" alt="1713621510475"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> (name <span class="operator">=</span> <span class="string">'LiLei'</span> <span class="keyword">or</span> name <span class="operator">=</span> <span class="string">'HanMeimei'</span>) <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621599090.png" alt="1713621599090"></p>
<p>做一个小实验，将employees 表复制一张employees_copy的表，里面保留两三条记录</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees_copy <span class="keyword">WHERE</span> name <span class="keyword">in</span> (<span class="string">'LiLei'</span>,<span class="string">'HanMeimei'</span>,<span class="string">'Lucy'</span>) <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621635401.png" alt="1713621635401"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees_copy <span class="keyword">WHERE</span> (name <span class="operator">=</span> <span class="string">'LiLei'</span> <span class="keyword">or</span> name <span class="operator">=</span> <span class="string">'HanMeimei'</span>) <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621657234.png" alt="1713621657234"></p>
<p><strong>5、like KK% 一般情况都会走索引</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">like</span> <span class="string">'LiLei%'</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621696614.png" alt="1713621696614"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees_copy <span class="keyword">WHERE</span> name <span class="keyword">like</span> <span class="string">'LiLei%'</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">AND</span> position <span class="operator">=</span><span class="string">'manager'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713621711355.png" alt="1713621711355"></p>
<p>这里给大家补充一个概念，<strong>索引下推（Index Condition Pushdown，ICP）</strong>, like KK%其实就是用到了索引下推优化</p>
<p><strong>什么是索引下推了？</strong></p>
<p>对于辅助的联合索引(name,age,position)，正常情况按照最左前缀原则，<strong>SELECT * FROM employees WHERE name like ‘LiLei%’ AND age = 22 AND position =’manager’</strong>  这种情况只会走name字段索引，因为根据name字段过滤完，得到的索引行里的age和position是无序的，无法很好的利用索引。</p>
<p>在MySQL5.6之前的版本，这个查询只能在联合索引里匹配到名字是 <strong>‘LiLei’ 开头</strong>的索引，然后拿这些索引对应的主键逐个回表，到主键索引上找出相应的记录，再比对<strong>age</strong>和<strong>position</strong>这两个字段的值是否符合。</p>
<p>MySQL 5.6引入了索引下推优化，<strong>可以在索引遍历过程中，对索引中包含的所有字段先做判断，过滤掉不符合条件的记录之后再回表，可以有效的减少回表次数</strong>。使用了索引下推优化后，上面那个查询在联合索引里匹配到名字是 <strong>‘LiLei’ 开头</strong>的索引之后，同时还会在索引里过滤<strong>age</strong>和<strong>position</strong>这两个字段，拿着过滤完剩下的索引对应的主键id再回表查整行数据。</p>
<p>索引下推会减少回表次数，对于innodb引擎的表索引下推只能用于二级索引，innodb的主键索引（聚簇索引）树叶子节点上保存的是全行数据，所以这个时候索引下推并不会起到减少查询全行数据的效果。</p>
<p><strong>为什么范围查找Mysql没有用索引下推优化？</strong></p>
<p>估计应该是Mysql认为范围查找过滤的结果集过大，like KK% 在绝大多数情况来看，过滤后的结果集比较小，所以这里Mysql选择给 like KK% 用了索引下推优化，当然这也不是绝对的，有时like KK% 也不一定就会走索引下推。</p>
<h1 id="Mysql如何选择合适的索引"><a href="#Mysql如何选择合适的索引" class="headerlink" title="Mysql如何选择合适的索引"></a><strong>Mysql如何选择合适的索引</strong></h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">'a'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713622068998.png" alt="1713622068998"></p>
<p>如果用name索引需要遍历name字段联合索引树，然后还需要根据遍历出来的主键值去主键索引树里再去查出最终数据，成本比全表扫描还高，可以用覆盖索引优化，这样只需要遍历name字段的联合索引树就能拿到所有结果，如下：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> name,age,position <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">'a'</span> ;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713622130885.png" alt="1713622130885"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">'zzz'</span> ;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713622185201.png" alt="1713622185201"></p>
<p>对于上面这两种 name&gt;’a’ 和 name&gt;’zzz’ 的执行结果，mysql最终是否选择走索引或者一张表涉及多个索引，mysql最终如何选择索引，我们可以用<strong>trace工具</strong>来一查究竟，开启trace工具会影响mysql性能，所以只能临时分析sql使用，用完之后立即关闭</p>
<p><strong>trace工具用法：</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> session optimizer_trace<span class="operator">=</span>"enabled=on",end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;  <span class="comment">--开启trace</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">'a'</span> <span class="keyword">order</span> <span class="keyword">by</span> position;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.OPTIMIZER_TRACE;</span><br><span class="line"></span><br><span class="line">查看trace字段：</span><br><span class="line">{</span><br><span class="line">  "steps": [</span><br><span class="line">    {</span><br><span class="line">      "join_preparation": {    <span class="comment">--第一阶段：SQL准备阶段，格式化sql</span></span><br><span class="line">        "select#": <span class="number">1</span>,</span><br><span class="line">        "steps": [</span><br><span class="line">          {</span><br><span class="line">            "expanded_query": "/* select#1 */ select `employees`.`id` AS `id`,`employees`.`name` AS `name`,`employees`.`age` AS `age`,`employees`.`position` AS `position`,`employees`.`hire_time` AS `hire_time` from `employees` where (`employees`.`name` &gt; 'a') order by `employees`.`position`"</span><br><span class="line">          }</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      } <span class="comment">/* join_preparation */</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      "join_optimization": {    <span class="comment">--第二阶段：SQL优化阶段</span></span><br><span class="line">        "select#": <span class="number">1</span>,</span><br><span class="line">        "steps": [</span><br><span class="line">          {</span><br><span class="line">            "condition_processing": {    <span class="comment">--条件处理</span></span><br><span class="line">              "condition": "WHERE",</span><br><span class="line">              "original_condition": "(`employees`.`name` &gt; 'a')",</span><br><span class="line">              "steps": [</span><br><span class="line">                {</span><br><span class="line">                  "transformation": "equality_propagation",</span><br><span class="line">                  "resulting_condition": "(`employees`.`name` &gt; 'a')"</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                  "transformation": "constant_propagation",</span><br><span class="line">                  "resulting_condition": "(`employees`.`name` &gt; 'a')"</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                  "transformation": "trivial_condition_removal",</span><br><span class="line">                  "resulting_condition": "(`employees`.`name` &gt; 'a')"</span><br><span class="line">                }</span><br><span class="line">              ] <span class="comment">/* steps */</span></span><br><span class="line">            } <span class="comment">/* condition_processing */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "substitute_generated_columns": {</span><br><span class="line">            } <span class="comment">/* substitute_generated_columns */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "table_dependencies": [    <span class="comment">--表依赖详情</span></span><br><span class="line">              {</span><br><span class="line">                "table": "`employees`",</span><br><span class="line">                "row_may_be_null": <span class="literal">false</span>,</span><br><span class="line">                "map_bit": <span class="number">0</span>,</span><br><span class="line">                "depends_on_map_bits": [</span><br><span class="line">                ] <span class="comment">/* depends_on_map_bits */</span></span><br><span class="line">              }</span><br><span class="line">            ] <span class="comment">/* table_dependencies */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "ref_optimizer_key_uses": [</span><br><span class="line">            ] <span class="comment">/* ref_optimizer_key_uses */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "rows_estimation": [    <span class="comment">--预估表的访问成本</span></span><br><span class="line">              {</span><br><span class="line">                "table": "`employees`",</span><br><span class="line">                "range_analysis": {</span><br><span class="line">                  "table_scan": {     <span class="comment">--全表扫描情况</span></span><br><span class="line">                    "rows": <span class="number">10123</span>,    <span class="comment">--扫描行数</span></span><br><span class="line">                    "cost": <span class="number">2054.7</span>    <span class="comment">--查询成本</span></span><br><span class="line">                  } <span class="comment">/* table_scan */</span>,</span><br><span class="line">                  "potential_range_indexes": [    <span class="comment">--查询可能使用的索引</span></span><br><span class="line">                    {</span><br><span class="line">                      "index": "PRIMARY",    <span class="comment">--主键索引</span></span><br><span class="line">                      "usable": <span class="literal">false</span>,</span><br><span class="line">                      "cause": "not_applicable"</span><br><span class="line">                    },</span><br><span class="line">                    {</span><br><span class="line">                      "index": "idx_name_age_position",    <span class="comment">--辅助索引</span></span><br><span class="line">                      "usable": <span class="literal">true</span>,</span><br><span class="line">                      "key_parts": [</span><br><span class="line">                        "name",</span><br><span class="line">                        "age",</span><br><span class="line">                        "position",</span><br><span class="line">                        "id"</span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    }</span><br><span class="line">                  ] <span class="comment">/* potential_range_indexes */</span>,</span><br><span class="line">                  "setup_range_conditions": [</span><br><span class="line">                  ] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">                  "group_index_range": {</span><br><span class="line">                    "chosen": <span class="literal">false</span>,</span><br><span class="line">                    "cause": "not_group_by_or_distinct"</span><br><span class="line">                  } <span class="comment">/* group_index_range */</span>,</span><br><span class="line">                  "analyzing_range_alternatives": {    <span class="comment">--分析各个索引使用成本</span></span><br><span class="line">                    "range_scan_alternatives": [</span><br><span class="line">                      {</span><br><span class="line">                        "index": "idx_name_age_position",</span><br><span class="line">                        "ranges": [</span><br><span class="line">                          "a &lt; name"      <span class="comment">--索引使用范围</span></span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        "index_dives_for_eq_ranges": <span class="literal">true</span>,</span><br><span class="line">                        "rowid_ordered": <span class="literal">false</span>,    <span class="comment">--使用该索引获取的记录是否按照主键排序</span></span><br><span class="line">                        "using_mrr": <span class="literal">false</span>,</span><br><span class="line">                        "index_only": <span class="literal">false</span>,       <span class="comment">--是否使用覆盖索引</span></span><br><span class="line">                        "rows": <span class="number">5061</span>,              <span class="comment">--索引扫描行数</span></span><br><span class="line">                        "cost": <span class="number">6074.2</span>,            <span class="comment">--索引使用成本</span></span><br><span class="line">                        "chosen": <span class="literal">false</span>,           <span class="comment">--是否选择该索引</span></span><br><span class="line">                        "cause": "cost"</span><br><span class="line">                      }</span><br><span class="line">                    ] <span class="comment">/* range_scan_alternatives */</span>,</span><br><span class="line">                    "analyzing_roworder_intersect": {</span><br><span class="line">                      "usable": <span class="literal">false</span>,</span><br><span class="line">                      "cause": "too_few_roworder_scans"</span><br><span class="line">                    } <span class="comment">/* analyzing_roworder_intersect */</span></span><br><span class="line">                  } <span class="comment">/* analyzing_range_alternatives */</span></span><br><span class="line">                } <span class="comment">/* range_analysis */</span></span><br><span class="line">              }</span><br><span class="line">            ] <span class="comment">/* rows_estimation */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "considered_execution_plans": [</span><br><span class="line">              {</span><br><span class="line">                "plan_prefix": [</span><br><span class="line">                ] <span class="comment">/* plan_prefix */</span>,</span><br><span class="line">                "table": "`employees`",</span><br><span class="line">                "best_access_path": {    <span class="comment">--最优访问路径</span></span><br><span class="line">                  "considered_access_paths": [   <span class="comment">--最终选择的访问路径</span></span><br><span class="line">                    {</span><br><span class="line">                      "rows_to_scan": <span class="number">10123</span>,</span><br><span class="line">                      "access_type": "scan",     <span class="comment">--访问类型：为scan，全表扫描</span></span><br><span class="line">                      "resulting_rows": <span class="number">10123</span>,</span><br><span class="line">                      "cost": <span class="number">2052.6</span>,</span><br><span class="line">                      "chosen": <span class="literal">true</span>,            <span class="comment">--确定选择</span></span><br><span class="line">                      "use_tmp_table": <span class="literal">true</span></span><br><span class="line">                    }</span><br><span class="line">                  ] <span class="comment">/* considered_access_paths */</span></span><br><span class="line">                } <span class="comment">/* best_access_path */</span>,</span><br><span class="line">                "condition_filtering_pct": <span class="number">100</span>,</span><br><span class="line">                "rows_for_plan": <span class="number">10123</span>,</span><br><span class="line">                "cost_for_plan": <span class="number">2052.6</span>,</span><br><span class="line">                "sort_cost": <span class="number">10123</span>,</span><br><span class="line">                "new_cost_for_plan": <span class="number">12176</span>,</span><br><span class="line">                "chosen": <span class="literal">true</span></span><br><span class="line">              }</span><br><span class="line">            ] <span class="comment">/* considered_execution_plans */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "attaching_conditions_to_tables": {</span><br><span class="line">              "original_condition": "(`employees`.`name` &gt; 'a')",</span><br><span class="line">              "attached_conditions_computation": [</span><br><span class="line">              ] <span class="comment">/* attached_conditions_computation */</span>,</span><br><span class="line">              "attached_conditions_summary": [</span><br><span class="line">                {</span><br><span class="line">                  "table": "`employees`",</span><br><span class="line">                  "attached": "(`employees`.`name` &gt; 'a')"</span><br><span class="line">                }</span><br><span class="line">              ] <span class="comment">/* attached_conditions_summary */</span></span><br><span class="line">            } <span class="comment">/* attaching_conditions_to_tables */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "clause_processing": {</span><br><span class="line">              "clause": "ORDER BY",</span><br><span class="line">              "original_clause": "`employees`.`position`",</span><br><span class="line">              "items": [</span><br><span class="line">                {</span><br><span class="line">                  "item": "`employees`.`position`"</span><br><span class="line">                }</span><br><span class="line">              ] <span class="comment">/* items */</span>,</span><br><span class="line">              "resulting_clause_is_simple": <span class="literal">true</span>,</span><br><span class="line">              "resulting_clause": "`employees`.`position`"</span><br><span class="line">            } <span class="comment">/* clause_processing */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "reconsidering_access_paths_for_index_ordering": {</span><br><span class="line">              "clause": "ORDER BY",</span><br><span class="line">              "steps": [</span><br><span class="line">              ] <span class="comment">/* steps */</span>,</span><br><span class="line">              "index_order_summary": {</span><br><span class="line">                "table": "`employees`",</span><br><span class="line">                "index_provides_order": <span class="literal">false</span>,</span><br><span class="line">                "order_direction": "undefined",</span><br><span class="line">                "index": "unknown",</span><br><span class="line">                "plan_changed": <span class="literal">false</span></span><br><span class="line">              } <span class="comment">/* index_order_summary */</span></span><br><span class="line">            } <span class="comment">/* reconsidering_access_paths_for_index_ordering */</span></span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "refine_plan": [</span><br><span class="line">              {</span><br><span class="line">                "table": "`employees`"</span><br><span class="line">              }</span><br><span class="line">            ] <span class="comment">/* refine_plan */</span></span><br><span class="line">          }</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      } <span class="comment">/* join_optimization */</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      "join_execution": {    <span class="comment">--第三阶段：SQL执行阶段</span></span><br><span class="line">        "select#": <span class="number">1</span>,</span><br><span class="line">        "steps": [</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      } <span class="comment">/* join_execution */</span></span><br><span class="line">    }</span><br><span class="line">  ] <span class="comment">/* steps */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">结论：全表扫描的成本低于索引扫描，所以mysql最终选择全表扫描</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">'zzz'</span> <span class="keyword">order</span> <span class="keyword">by</span> position;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.OPTIMIZER_TRACE;</span><br><span class="line"></span><br><span class="line">查看trace字段可知索引扫描的成本低于全表扫描，所以mysql最终选择索引扫描</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> session optimizer_trace<span class="operator">=</span>"enabled=off";    <span class="comment">--关闭trace</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="常见sql深入优化"><a href="#常见sql深入优化" class="headerlink" title="常见sql深入优化"></a><strong>常见sql深入优化</strong></h1><p><strong>Order by与Group by优化</strong></p>
<p>Case1：</p>
<p><img src="/../img/1713622407788.png" alt="1713622407788"></p>
<p>分析：</p>
<p>利用最左前缀法则：中间字段不能断，因此查询用到了name索引，从key_len=74也能看出，age索引列用在排序过程中，因为Extra字段里没有using filesort</p>
<p>Case 2：</p>
<p><img src="/../img/1713622446791.png" alt="1713622446791"></p>
<p>分析：</p>
<p>从explain的执行结果来看：key_len=74，查询使用了name索引，由于用了position进行排序，跳过了age，出现了Using filesort。</p>
<p>Case 3：</p>
<p><img src="/../img/1713622485083.png" alt="1713622485083"></p>
<p>分析：</p>
<p>查找只用到索引name，age和position用于排序，无Using filesort。</p>
<p>Case 4：</p>
<p><img src="/../img/1713622510359.png" alt="1713622510359"></p>
<p>分析：</p>
<p>和Case 3中explain的执行结果一样，但是出现了Using filesort，因为索引的创建顺序为name,age,position，但是排序的时候age和position颠倒位置了。</p>
<p>Case 5：</p>
<p><img src="/../img/1713622533339.png" alt="1713622533339"></p>
<p>分析：</p>
<p>与Case 4对比，在Extra中并未出现Using filesort，因为age为常量，在排序中被优化，所以索引未颠倒，不会出现Using filesort。</p>
<p>Case 6：</p>
<p><img src="/../img/1713622569152.png" alt="1713622569152"></p>
<p>分析：</p>
<p>虽然排序的字段列与索引顺序一样，且order by默认升序，这里position desc变成了降序，导致与索引的排序方式不同，从而产生Using filesort。Mysql8以上版本有降序索引可以支持该种查询方式。</p>
<p>Case 7：</p>
<p><img src="/../img/1713622635314.png" alt="1713622635314"></p>
<p>分析：</p>
<p>对于排序来说，多个相等条件也是范围查询</p>
<p>Case 8：</p>
<p><img src="/../img/1713622658555.png" alt="1713622658555"></p>
<p>可以用覆盖索引优化</p>
<p><img src="/../img/1713622668731.png" alt="1713622668731"></p>
<p><strong>优化总结：</strong></p>
<p>1、MySQL支持两种方式的排序filesort和index，Using index是指MySQL扫描索引本身完成排序。index效率高，filesort效率低。</p>
<p>2、order by满足两种情况会使用Using index。</p>
<ol>
<li><p>order by语句使用索引最左前列。</p>
</li>
<li><p>使用where子句与order by子句条件列组合满足索引最左前列。</p>
</li>
</ol>
<p>3、尽量在索引列上完成排序，遵循索引建立（索引创建的顺序）时的最左前缀法则。</p>
<p>4、如果order by的条件不在索引列上，就会产生Using filesort。</p>
<p>5、能用覆盖索引尽量用覆盖索引</p>
<p>6、group by与order by很类似，其实质是先排序后分组，遵照索引创建顺序的最左前缀法则。对于group by的优化如果不需要排序的可以加上<strong>order by null禁止排序</strong>。注意，where高于having，能写在where中的限定条件就不要去having限定了。</p>
<p><strong>Using filesort文件排序原理详解</strong></p>
<p><strong>filesort文件排序方式</strong></p>
<ul>
<li>单路排序：是一次性取出满足条件行的所有字段，然后在sort buffer中进行排序；用trace工具可以看到sort_mode信息里显示&lt; sort_key, additional_fields &gt;或者&lt; sort_key, packed_additional_fields &gt;</li>
<li>双路排序（又叫<strong>回表</strong>排序模式）：是首先根据相应的条件取出相应的<strong>排序字段</strong>和<strong>可以直接定位行数据的行 ID</strong>，然后在 sort buffer 中进行排序，排序完后需要再次取回其它需要的字段；用trace工具可以看到sort_mode信息里显示&lt; sort_key, rowid &gt;</li>
</ul>
<p>MySQL 通过比较系统变量 max_length_for_sort_data(<strong>默认1024字节</strong>) 的大小和需要查询的字段总大小来判断使用哪种排序模式。</p>
<ul>
<li>如果 字段的总长度小于max_length_for_sort_data ，那么使用 单路排序模式；</li>
<li>如果 字段的总长度大于max_length_for_sort_data ，那么使用 双路排序模·式。</li>
</ul>
<p><strong>示例验证下各种排序方式：</strong></p>
<p><img src="/../img/1713623050959.png" alt="1713623050959"></p>
<p>查看下这条sql对应trace结果如下(只展示排序部分)：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> session optimizer_trace<span class="operator">=</span>"enabled=on",end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;  <span class="comment">--开启trace</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">'zhuge'</span> <span class="keyword">order</span> <span class="keyword">by</span> position;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.OPTIMIZER_TRACE;</span><br><span class="line"></span><br><span class="line">trace排序部分结果：</span><br><span class="line">"join_execution": {    <span class="comment">--Sql执行阶段</span></span><br><span class="line">        "select#": <span class="number">1</span>,</span><br><span class="line">        "steps": [</span><br><span class="line">          {</span><br><span class="line">            "filesort_information": [</span><br><span class="line">              {</span><br><span class="line">                "direction": "asc",</span><br><span class="line">                "table": "`employees`",</span><br><span class="line">                "field": "position"</span><br><span class="line">              }</span><br><span class="line">            ] <span class="comment">/* filesort_information */</span>,</span><br><span class="line">            "filesort_priority_queue_optimization": {</span><br><span class="line">              "usable": <span class="literal">false</span>,</span><br><span class="line">              "cause": "not applicable (no LIMIT)"</span><br><span class="line">            } <span class="comment">/* filesort_priority_queue_optimization */</span>,</span><br><span class="line">            "filesort_execution": [</span><br><span class="line">            ] <span class="comment">/* filesort_execution */</span>,</span><br><span class="line">            "filesort_summary": {                      <span class="comment">--文件排序信息</span></span><br><span class="line">              "rows": <span class="number">10000</span>,                           <span class="comment">--预计扫描行数</span></span><br><span class="line">              "examined_rows": <span class="number">10000</span>,                  <span class="comment">--参与排序的行</span></span><br><span class="line">              "number_of_tmp_files": <span class="number">3</span>,                <span class="comment">--使用临时文件的个数，这个值如果为0代表全部使用的sort_buffer内存排序，否则使用的磁盘文件排序</span></span><br><span class="line">              "sort_buffer_size": <span class="number">262056</span>,              <span class="comment">--排序缓存的大小，单位Byte</span></span><br><span class="line">              "sort_mode": "&lt;sort_key, packed_additional_fields&gt;"       <span class="comment">--排序方式，这里用的单路排序</span></span><br><span class="line">            } <span class="comment">/* filesort_summary */</span></span><br><span class="line">          }</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      } <span class="comment">/* join_execution */</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> max_length_for_sort_data <span class="operator">=</span> <span class="number">10</span>;    <span class="comment">--employees表所有字段长度总和肯定大于10字节</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">'zhuge'</span> <span class="keyword">order</span> <span class="keyword">by</span> position;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.OPTIMIZER_TRACE;</span><br><span class="line"></span><br><span class="line">trace排序部分结果：</span><br><span class="line">"join_execution": {</span><br><span class="line">        "select#": <span class="number">1</span>,</span><br><span class="line">        "steps": [</span><br><span class="line">          {</span><br><span class="line">            "filesort_information": [</span><br><span class="line">              {</span><br><span class="line">                "direction": "asc",</span><br><span class="line">                "table": "`employees`",</span><br><span class="line">                "field": "position"</span><br><span class="line">              }</span><br><span class="line">            ] <span class="comment">/* filesort_information */</span>,</span><br><span class="line">            "filesort_priority_queue_optimization": {</span><br><span class="line">              "usable": <span class="literal">false</span>,</span><br><span class="line">              "cause": "not applicable (no LIMIT)"</span><br><span class="line">            } <span class="comment">/* filesort_priority_queue_optimization */</span>,</span><br><span class="line">            "filesort_execution": [</span><br><span class="line">            ] <span class="comment">/* filesort_execution */</span>,</span><br><span class="line">            "filesort_summary": {</span><br><span class="line">              "rows": <span class="number">10000</span>,</span><br><span class="line">              "examined_rows": <span class="number">10000</span>,</span><br><span class="line">              "number_of_tmp_files": <span class="number">2</span>,</span><br><span class="line">              "sort_buffer_size": <span class="number">262136</span>,   </span><br><span class="line">              "sort_mode": "&lt;sort_key, rowid&gt;"         <span class="comment">--排序方式，这里用的双路排序</span></span><br><span class="line">            } <span class="comment">/* filesort_summary */</span></span><br><span class="line">          }</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      } <span class="comment">/* join_execution */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> session optimizer_trace<span class="operator">=</span>"enabled=off";    <span class="comment">--关闭trace</span></span><br></pre></td></tr></tbody></table></figure>

<p>我们先看<strong>单路排序</strong>的详细过程：</p>
<ol>
<li>从索引name找到第一个满足 name = ‘zhuge’ 条件的主键 id</li>
<li>根据主键 id 取出整行，<strong>取出所有字段的值，存入 sort_buffer 中</strong></li>
<li>从索引name找到下一个满足 name = ‘zhuge’ 条件的主键 id</li>
<li>重复步骤 2、3 直到不满足 name = ‘zhuge’ </li>
<li>对 sort_buffer 中的数据按照字段 position 进行排序</li>
<li>返回结果给客户端</li>
</ol>
<p>我们再看下<strong>双路排序</strong>的详细过程：</p>
<ol>
<li>从索引 name 找到第一个满足 name = ‘zhuge’  的主键id</li>
<li>根据主键 id 取出整行，<strong>把排序字段 position 和主键 id 这两个字段放到 sort buffer 中</strong></li>
<li>从索引 name 取下一个满足 name = ‘zhuge’  记录的主键 id</li>
<li>重复 3、4 直到不满足 name = ‘zhuge’ </li>
<li>对 sort_buffer 中的字段 position 和主键 id 按照字段 position 进行排序</li>
<li>遍历排序好的 id 和字段 position，按照 id 的值<strong>回到原表</strong>中取出 所有字段的值返回给客户端</li>
</ol>
<p>其实对比两个排序模式，单路排序会把所有需要查询的字段都放到 sort buffer 中，而双路排序只会把主键和需要排序的字段放到 sort buffer 中进行排序，然后再通过主键回到原表查询需要的字段。</p>
<p>如果 MySQL <strong>排序内存</strong> <strong>sort_buffer</strong> 配置的比较小并且没有条件继续增加了，可以适当把 max_length_for_sort_data 配置小点，让优化器选择使用<strong>双路排序</strong>算法，可以在sort_buffer 中一次排序更多的行，只是需要再根据主键回到原表取数据。</p>
<p>如果 MySQL 排序内存有条件可以配置比较大，可以适当增大 max_length_for_sort_data 的值，让优化器优先选择全字段排序(<strong>单路排序</strong>)，把需要的字段放到 sort_buffer 中，这样排序后就会直接从内存里返回查询结果了。</p>
<p>所以，MySQL通过 <strong>max_length_for_sort_data</strong> 这个参数来控制排序，在不同场景使用不同的排序模式，从而提升排序效率。</p>
<p><strong>注意</strong>，如果全部使用sort_buffer内存排序一般情况下效率会高于磁盘文件排序，但不能因为这个就随便增大sort_buffer(默认1M)，mysql很多参数设置都是做过优化的，不要轻易调整。</p>
<h1 id="索引设计原则"><a href="#索引设计原则" class="headerlink" title="索引设计原则"></a><strong>索引设计原则</strong></h1><p><strong>1、代码先行，索引后上</strong></p>
<p>不知大家一般是怎么给数据表建立索引的，是建完表马上就建立索引吗？</p>
<p>这其实是不对的，一般应该等到主体业务功能开发完毕，把涉及到该表相关sql都要拿出来分析之后再建立索引。</p>
<p><strong>2、联合索引尽量覆盖条件</strong></p>
<p>比如可以设计一个或者两三个联合索引(尽量少建单值索引)，让每一个联合索引都尽量去包含sql语句里的where、order by、group by的字段，还要确保这些联合索引的字段顺序尽量满足sql查询的最左前缀原则。</p>
<p><strong>3、不要在小基数字段上建立索引</strong></p>
<p>索引基数是指这个字段在表里总共有多少个不同的值，比如一张表总共100万行记录，其中有个性别字段，其值不是男就是女，那么该字段的基数就是2。</p>
<p>如果对这种小基数字段建立索引的话，还不如全表扫描了，因为你的索引树里就包含男和女两种值，根本没法进行快速的二分查找，那用索引就没有太大的意义了。</p>
<p>一般建立索引，尽量使用那些基数比较大的字段，就是值比较多的字段，那么才能发挥出B+树快速二分查找的优势来。</p>
<p><strong>4、长字符串我们可以采用前缀索引</strong></p>
<p>尽量对字段类型较小的列设计索引，比如说什么tinyint之类的，因为字段类型较小的话，占用磁盘空间也会比较小，此时你在搜索的时候性能也会比较好一点。</p>
<p>当然，这个所谓的字段类型小一点的列，也不是绝对的，很多时候你就是要针对varchar(255)这种字段建立索引，哪怕多占用一些磁盘空间也是有必要的。</p>
<p>对于这种varchar(255)的大字段可能会比较占用磁盘空间，可以稍微优化下，比如针对这个字段的前20个字符建立索引，就是说，对这个字段里的每个值的前20个字符放在索引树里，类似于 KEY index(name(20),age,position)。</p>
<p>此时你在where条件里搜索的时候，如果是根据name字段来搜索，那么此时就会先到索引树里根据name字段的前20个字符去搜索，定位到之后前20个字符的前缀匹配的部分数据之后，再回到聚簇索引提取出来完整的name字段值进行比对。</p>
<p>但是假如你要是order by name，那么此时你的name因为在索引树里仅仅包含了前20个字符，所以这个排序是没法用上索引的， group by也是同理。所以这里大家要对前缀索引有一个了解。</p>
<p><strong>5、where与order by冲突时优先where</strong></p>
<p>在where和order by出现索引设计冲突时，到底是针对where去设计索引，还是针对order by设计索引？到底是让where去用上索引，还是让order by用上索引?</p>
<p>一般这种时候往往都是让where条件去使用索引来快速筛选出来一部分指定的数据，接着再进行排序。</p>
<p>因为大多数情况基于索引进行where筛选往往可以最快速度筛选出你要的少部分数据，然后做排序的成本可能会小很多。</p>
<p><strong>6、基于慢sql查询做优化</strong></p>
<p>可以根据监控后台的一些慢sql，针对这些慢sql查询做特定的索引优化。</p>
<p>关于慢sql查询不清楚的可以参考这篇文章：</p>
<h1 id="慢SQL查询优化"><a href="#慢SQL查询优化" class="headerlink" title="慢SQL查询优化"></a>慢SQL查询优化</h1><p><strong>1 概念</strong></p>
<p>MySQL的慢查询，全名是<strong>慢查询日志</strong>，是MySQL提供的一种日志记录，用来记录在MySQL中<strong>响应时间超过阀值</strong>的语句。</p>
<p>具体环境中，运行时间超过long_query_time值的SQL语句，则会被记录到慢查询日志中。</p>
<p>long_query_time的默认值为10，意思是记录运行10秒以上的语句。</p>
<p>默认情况下，MySQL数据库并不启动慢查询日志，需要手动来设置这个参数。</p>
<p>当然，<strong>如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。</p>
<p>慢查询日志支持将日志记录写入文件和数据库表。</p>
<p>官方文档，关于慢查询的日志介绍如下（部分资料，具体参考官方相关链接）：</p>
<p><strong>2 参数</strong></p>
<p>MySQL 慢查询的相关参数解释：</p>
<p>slow_query_log：是否开启慢查询日志，<strong>1表示开启，0表示关闭</strong>。</p>
<p>log-slow-queries ：旧版（5.6以下版本）MySQL数据库慢查询日志存储路径。可以不设置该参数，系统则会默认给一个缺省的文件host_name-slow.log</p>
<p>slow-query-log-file：新版（5.6及以上版本）MySQL数据库慢查询日志存储路径。可以不设置该参数，系统则会默认给一个缺省的文件host_name-slow.log</p>
<p>long_query_time：慢查询阈值，当查询时间多于设定的阈值时，记录日志。</p>
<p>log_queries_not_using_indexes：未使用索引的查询也被记录到慢查询日志中（可选项）。</p>
<p>log_output：日志存储方式。log_output=’FILE’表示将日志存入文件，默认值是’FILE’。log_output=’TABLE’表示将日志存入数据库。</p>
<p><strong>3 配置</strong></p>
<p><strong>3.1 slow_query_log</strong></p>
<p>默认情况下slow_query_log的值为OFF，表示慢查询日志是禁用的，可以通过设置slow_query_log的值来开启，如下所示：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables  <span class="keyword">like</span> <span class="string">'%slow_query_log%'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+-----------------------------------------------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name       <span class="operator">|</span> <span class="keyword">Value</span>                                         <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+-----------------------------------------------+</span></span><br><span class="line"> <span class="operator">|</span> slow_query_log      <span class="operator">|</span> OFF                                           <span class="operator">|</span></span><br><span class="line"> <span class="operator">|</span> slow_query_log_file <span class="operator">|</span> <span class="operator">/</span>home<span class="operator">/</span>WDPM<span class="operator">/</span>MysqlData<span class="operator">/</span>mysql<span class="operator">/</span>DB<span class="operator">-</span>Server<span class="operator">-</span>slow.log <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+-----------------------------------------------+</span></span><br><span class="line"> <span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> slow_query_log<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"> Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.09</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>使用set global slow_query_log=1开启了慢查询日志只对当前数据库生效，MySQL重启后则会失效。</p>
<p>如果要永久生效，就必须修改配置文件my.cnf（其它系统变量也是如此）。</p>
<p>my.cnf要增加或修改参数slow_query_log 和slow_query_log_file，如下所示</p>
<p>slow_query_log = 1</p>
<p>slow_query_log_file = /tmp/mysql_slow.log</p>
<p>然后重启MySQL服务器。</p>
<p><strong>3.2 slow_query_log_file</strong></p>
<p>这个参数用于指定慢查询日志的存放路径，缺省情况是host_name-slow.log文件，</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'slow_query_log_file'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+-----------------------------------------------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name       <span class="operator">|</span> <span class="keyword">Value</span>                                         <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+-----------------------------------------------+</span></span><br><span class="line"> <span class="operator">|</span> slow_query_log_file <span class="operator">|</span> <span class="operator">/</span>home<span class="operator">/</span>WDPM<span class="operator">/</span>MysqlData<span class="operator">/</span>mysql<span class="operator">/</span>DB<span class="operator">-</span>Server<span class="operator">-</span>slow.log <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+-----------------------------------------------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3.3 long_query_time</strong></p>
<p>开启了慢查询日志后，什么样的SQL才会记录到慢查询日志里面呢？</p>
<p>这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，可以使用命令修改，也可以在my.cnf参数里面修改。</p>
<p>关于运行时间正好等于long_query_time的情况，并不会被记录下来。</p>
<p>也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</p>
<p>从MySQL 5.1开始，long_query_time开始以微秒记录SQL语句运行时间，之前仅用秒为单位记录。</p>
<p>如果记录到表里面，只会记录整数部分，不会记录微秒部分。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'long_query_time%'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"> <span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">10.000000</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> long_query_time<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"> Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'long_query_time'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"> <span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">10.000000</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>如上所示，我修改了变量long_query_time，但是查询变量long_query_time的值还是10，难道没有修改到呢？</p>
<p>注意：使用命令 set global long_query_time=4修改后，需要重新连接或新开一个会话才能看到修改值。</p>
<p>用show variables like ‘long_query_time’查看是当前会话的变量值。</p>
<p>也可以不用重新连接会话，而是用show global variables like ‘long_query_time’;。</p>
<p><strong>3.4 log_output</strong></p>
<p>log_output参数指定日志的存储方式。</p>
<p>log_output=’FILE’表示将日志存入文件，默认值也是’FILE’。</p>
<p>log_output=’TABLE’表示将日志存入数据库，这样日志信息就会被写入到mysql.slow_log表中。</p>
<p>同时也支持两种日志存储方式，配置的时候以逗号隔开即可，如：log_output=’FILE,TABLE’。</p>
<p>日志记录到系统的专用日志表中，要比记录到文件耗费更多的系统资源。</p>
<p>因此对于需要启用慢查询日志，又需要能够获得更高的系统性能，那么<strong>建议优先记录到文件</strong>。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'%log_output%'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> log_output    <span class="operator">|</span> FILE  <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> log_output<span class="operator">=</span><span class="string">'TABLE'</span>;</span><br><span class="line"> Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'%log_output%'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> log_output    <span class="operator">|</span> <span class="keyword">TABLE</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> sleep(<span class="number">5</span>) ;</span><br><span class="line"> <span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"> <span class="operator">|</span> sleep(<span class="number">5</span>) <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"> <span class="operator">|</span>        <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">5.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span></span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.slow_log;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+---------------------------+------------+-----------+-----------+---------------+----+----------------+-----------+-----------+-----------------+-----------+</span></span><br><span class="line"> <span class="operator">|</span> start_time          <span class="operator">|</span> user_host                 <span class="operator">|</span> query_time <span class="operator">|</span> lock_time <span class="operator">|</span> rows_sent <span class="operator">|</span> rows_examined <span class="operator">|</span> db <span class="operator">|</span> last_insert_id <span class="operator">|</span> insert_id <span class="operator">|</span> server_id <span class="operator">|</span> sql_text        <span class="operator">|</span> thread_id <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+---------------------------+------------+-----------+-----------+---------------+----+----------------+-----------+-----------+-----------------+-----------+</span></span><br><span class="line"> <span class="operator">|</span> <span class="number">2016</span><span class="number">-06</span><span class="number">-16</span> <span class="number">17</span>:<span class="number">37</span>:<span class="number">53</span> <span class="operator">|</span> root[root] @ localhost [] <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span>   <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>  <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span>    <span class="operator">|</span>              <span class="number">0</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span> <span class="keyword">select</span> sleep(<span class="number">3</span>) <span class="operator">|</span>         <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">|</span> <span class="number">2016</span><span class="number">-06</span><span class="number">-16</span> <span class="number">21</span>:<span class="number">45</span>:<span class="number">23</span> <span class="operator">|</span> root[root] @ localhost [] <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">05</span>   <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>  <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span>    <span class="operator">|</span>              <span class="number">0</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span> <span class="keyword">select</span> sleep(<span class="number">5</span>) <span class="operator">|</span>         <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------+---------------------------+------------+-----------+-----------+---------------+----+----------------+-----------+-----------+-----------------+-----------+</span></span><br><span class="line"> <span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3.5 log-queries-not-using-indexes</strong></p>
<p>该系统变量指定<strong>未使用索引的查询</strong>也被记录到慢查询日志中（可选项）。</p>
<p>如果调优的话，建议开启这个选项。</p>
<p>另外，开启了这个参数，其实使用full index scan的SQL也会被记录到慢查询日志。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'log_queries_not_using_indexes'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> log_queries_not_using_indexes <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> log_queries_not_using_indexes<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"> Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'log_queries_not_using_indexes'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> log_queries_not_using_indexes <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3.6 log_slow_admin_statements</strong></p>
<p>这个系统变量表示，是否将慢管理语句例如ANALYZE TABLE和ALTER TABLE等记入慢查询日志。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">'log_slow_admin_statements'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> log_slow_admin_statements <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3.7 Slow_queries</strong></p>
<p>如果你想查询有多少条慢查询记录，可以使用Slow_queries系统变量。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">'%Slow_queries%'</span>;</span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="operator">|</span> Slow_queries  <span class="operator">|</span> <span class="number">2104</span>  <span class="operator">|</span></span><br><span class="line"> <span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"> <span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>

<p>另外，还有log_slow_slave_statements 和 –log-short-format 参数，可到MySQL网站了解。</p>
<p><strong>4 mysqldumpslow工具</strong></p>
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活。</p>
<p>MySQL提供了日志分析工具mysqldumpslow</p>
<p>查看mysqldumpslow的帮助信息：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@DB</span><span class="operator">-</span>Server <span class="operator">~</span>]# mysqldumpslow <span class="comment">--help</span></span><br><span class="line"> Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]</span><br><span class="line"> </span><br><span class="line">Parse <span class="keyword">and</span> summarize the MySQL slow query log. Options <span class="keyword">are</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">--verbose    verbose</span></span><br><span class="line">  <span class="comment">--debug      debug</span></span><br><span class="line">  <span class="comment">--help       write this text to standard output</span></span><br><span class="line"> </span><br><span class="line">  <span class="operator">-</span>v           verbose</span><br><span class="line">  <span class="operator">-</span>d           debug</span><br><span class="line">  <span class="operator">-</span>s <span class="keyword">ORDER</span>     what <span class="keyword">to</span> sort <span class="keyword">by</span> (al, <span class="keyword">at</span>, ar, c, l, r, t), <span class="string">'at'</span> <span class="keyword">is</span> <span class="keyword">default</span>（排序方式）</span><br><span class="line">                 al: average lock <span class="type">time</span>（平均锁定时间）</span><br><span class="line">                 ar: average <span class="keyword">rows</span> sent（平均返回记录数）</span><br><span class="line">                 <span class="keyword">at</span>: average query <span class="type">time</span>（平均查询时间）</span><br><span class="line">                  c: count（访问计数）</span><br><span class="line">                  l: lock <span class="type">time</span>（锁定时间）</span><br><span class="line">                  r: <span class="keyword">rows</span> sent（返回记录）</span><br><span class="line">                  t: query <span class="type">time</span>（查询时间）</span><br><span class="line">   <span class="operator">-</span>r           reverse the sort <span class="keyword">order</span> (largest <span class="keyword">last</span> instead <span class="keyword">of</span> <span class="keyword">first</span>)</span><br><span class="line">   <span class="operator">-</span>t NUM       just <span class="keyword">show</span> the top n queries（返回前面n条数据）</span><br><span class="line">   <span class="operator">-</span>a           don<span class="string">'t abstract all numbers to N and strings to '</span>S<span class="string">'</span></span><br><span class="line"><span class="string">   -n NUM       abstract numbers with at least n digits within names</span></span><br><span class="line"><span class="string">   -g PATTERN   grep: only consider stmts that include this string（正则匹配模式，大小写不敏感）</span></span><br><span class="line"><span class="string">   -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),</span></span><br><span class="line"><span class="string">                default is '</span><span class="operator">*</span><span class="string">', i.e. match all</span></span><br><span class="line"><span class="string">   -i NAME      name of server instance (if using mysql.server startup script)</span></span><br><span class="line"><span class="string">   -l           don'</span>t subtract lock <span class="type">time</span> <span class="keyword">from</span> total <span class="type">time</span></span><br><span class="line"> </span><br></pre></td></tr></tbody></table></figure>

<p>比如，得到返回记录集最多的10个SQL。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow <span class="operator">-</span>s r <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>database<span class="operator">/</span>mysql<span class="operator">/</span>mysql06_slow.log</span><br></pre></td></tr></tbody></table></figure>

<p>得到访问次数最多的10个SQL</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s c -t 10 /database/mysql/mysql06_slow.log  </span><br></pre></td></tr></tbody></table></figure>

<p>得到按照时间排序的前10条里面含有左连接的查询语句。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s t -t 10 -g “left join” /database/mysql/mysql06_slow.log          </span><br></pre></td></tr></tbody></table></figure>

<p>另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现刷屏的情况。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s r -t 20 /mysqldata/mysql/mysql06-slow.log | more</span><br></pre></td></tr></tbody></table></figure>



<h1 id="索引设计实战"><a href="#索引设计实战" class="headerlink" title="索引设计实战"></a><strong>索引设计实战</strong></h1><p>以社交场景APP来举例，我们一般会去搜索一些好友，这里面就涉及到对用户信息的筛选，这里肯定就是对用户user表搜索了，这个表一般来说数据量会比较大，我们先不考虑分库分表的情况，比如，我们一般会筛选地区(省市)，性别，年龄，身高，爱好之类的，有的APP可能用户还有评分，比如用户的受欢迎程度评分，我们可能还会根据评分来排序等等。</p>
<p>对于后台程序来说除了过滤用户的各种条件，还需要分页之类的处理，可能会生成类似sql语句执行：</p>
<p>select xx from user where xx=xx and xx=xx order by xx limit xx,xx</p>
<p>对于这种情况如何合理设计索引了，比如用户可能经常会根据省市优先筛选同城的用户，还有根据性别去筛选，那我们是否应该设计一个联合索引 (province,city,sex) 了？这些字段好像基数都不大，其实是应该的，因为这些字段查询太频繁了。</p>
<p>假设又有用户根据年龄范围去筛选了，比如 where  province=xx and city=xx and age&gt;=xx and age&lt;=xx，我们尝试着把age字段加入联合索引 (province,city,sex,age)，注意，一般这种范围查找的条件都要放在最后，之前讲过联合索引范围之后条件的是不能用索引的，但是对于当前这种情况依然用不到age这个索引字段，因为用户没有筛选sex字段，那怎么优化了？其实我们可以这么来优化下sql的写法：where  province=xx and city=xx and sex in (‘female’,’male’) and age&gt;=xx and age&lt;=xx</p>
<p>对于爱好之类的字段也可以类似sex字段处理，所以可以把爱好字段也加入索引 (province,city,sex,hobby,age) </p>
<p>假设可能还有一个筛选条件，比如要筛选最近一周登录过的用户，一般大家肯定希望跟活跃用户交友了，这样能尽快收到反馈，对应后台sql可能是这样：</p>
<p>where  province=xx and city=xx and sex in (‘female’,’male’) and age&gt;=xx and age&lt;=xx and latest_login_time&gt;= xx</p>
<p>那我们是否能把 latest_login_time 字段也加入索引了？比如  (province,city,sex,hobby,age,latest_login_time) ，显然是不行的，那怎么来优化这种情况了？其实我们可以试着再设计一个字段is_login_in_latest_7_days，用户如果一周内有登录值就为1，否则为0，那么我们就可以把索引设计成 (province,city,sex,hobby,is_login_in_latest_7_days,age)  来满足上面那种场景了！</p>
<p>一般来说，通过这么一个多字段的索引是能够过滤掉绝大部分数据的，就保留小部分数据下来基于磁盘文件进行order by语句的排序，最后基于limit进行分页，那么一般性能还是比较高的。</p>
<p>不过有时可能用户会这么来查询，就查下受欢迎度较高的女性，比如sql：where  sex = ‘female’  order by score limit xx,xx，那么上面那个索引是很难用上的，不能把太多的字段以及太多的值都用 in 语句拼接到sql里的，那怎么办了？其实我们可以再设计一个辅助的联合索引，比如 (sex,score)，这样就能满足查询要求了。</p>
<p>以上就是给大家讲的一些索引设计的思路了，核心思想就是，尽量利用一两个复杂的多字段联合索引，抗下你80%以上的查询，然后用一两个辅助索引尽量抗下剩余的一些非典型查询，保证这种大数据量表的查询尽可能多的都能充分利用索引，这样就能保证你的查询速度和性能了！</p>
<p><img src="/../img/1713624989902.png" alt="1713624989902"></p>
<h1 id="分页查询优化"><a href="#分页查询优化" class="headerlink" title="分页查询优化"></a><strong>分页查询优化</strong></h1><p>示例表</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employees` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">24</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'姓名'</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'年龄'</span>,</span><br><span class="line">  `position` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'职位'</span>,</span><br><span class="line">  `hire_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'入职时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_name_age_position` (`name`,`age`,`position`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">'员工记录表'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>很多时候我们业务系统实现分页功能可能会用如下sql实现</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees limit <span class="number">10000</span>,<span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>表示从表 employees 中取出从 10001 行开始的 10 行记录。看似只查询了 10 条记录，实际这条 SQL 是先读取 10010 条记录，然后抛弃前 10000 条记录，然后读到后面 10 条想要的数据。因此要查询一张大表比较靠后的数据，执行效率是非常低的。</p>
<p><strong>&gt;&gt;常见的分页场景优化技巧：</strong></p>
<p><strong>1、根据自增且连续的主键排序的分页查询</strong></p>
<p>首先来看一个根据自增且连续主键排序的分页查询的例子：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees limit <span class="number">90000</span>,<span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713625435191.png" alt="1713625435191"></p>
<p>该 SQL 表示查询从第 90001开始的五行数据，没添加单独 order by，表示通过<strong>主键排序</strong>。我们再看表 employees ，因为主键是自增并且连续的，所以可以改写成按照主键去查询从第 90001开始的五行数据，如下：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">90000</span> limit <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713625483798.png" alt="1713625483798"></p>
<p>查询的结果是一致的。我们再对比一下执行计划：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees limit <span class="number">90000</span>,<span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713625496529.png" alt="1713625496529"></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">90000</span> limit <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713625506099.png" alt="1713625506099"></p>
<p>显然改写后的 SQL 走了索引，而且扫描的行数大大减少，执行效率更高。 </p>
<p>但是，这条改写的SQL 在很多场景并不实用，因为表中可能某些记录被删后，主键空缺，导致结果不一致，如下图试验所示（先删除一条前面的记录，然后再测试原 SQL 和优化后的 SQL）：</p>
<p><img src="/../img/1713625523197.png" alt="1713625523197"></p>
<p><img src="/../img/1713625531679.png" alt="1713625531679"></p>
<p>两条 SQL 的结果并不一样，因此，如果主键不连续，不能使用上面描述的优化方法。</p>
<p>另外如果原 SQL 是 order by 非主键的字段，按照上面说的方法改写会导致两条 SQL 的结果不一致。所以这种改写得满足以下两个条件：</p>
<ul>
<li>主键自增且连续</li>
<li>结果是按照主键排序的</li>
</ul>
<p><strong>2、根据非主键字段排序的分页查询</strong></p>
<p>再看一个根据非主键字段排序的分页查询，SQL 如下：</p>
<p><strong>mysql&gt;  select * from employees</strong> <strong>ORDER BY name</strong> <strong>limit 90000,5;</strong></p>
<p><img src="/../img/1713625582099.png" alt="1713625582099"></p>
<p><strong>mysql&gt; EXPLAIN select * from employees</strong> <strong>ORDER BY name</strong> <strong>limit 90000,5;</strong></p>
<p><img src="/../img/1713625619478.png" alt="1713625619478"></p>
<p>发现并没有使用 name 字段的索引（key 字段对应的值为 null），具体原因上节课讲过：<strong>扫描整个索引并查找到没索引的行(可能要遍历多个索引树)的成本比扫描全表的成本更高，所以优化器放弃使用索引</strong>。</p>
<p>知道不走索引的原因，那么怎么优化呢？</p>
<p>其实关键是<strong>让排序时返回的字段尽可能少</strong>，所以可以让排序和分页操作先查出主键，然后根据主键查到对应的记录，SQL改写如下</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees e <span class="keyword">inner</span> <span class="keyword">join</span> (<span class="keyword">select</span> id <span class="keyword">from</span> employees <span class="keyword">order</span> <span class="keyword">by</span> name limit <span class="number">90000</span>,<span class="number">5</span>) ed <span class="keyword">on</span> e.id <span class="operator">=</span> ed.id;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713625724308.png" alt="1713625724308"></p>
<p>需要的结果与原 SQL 一致，执行时间减少了一半以上，我们再对比优化前后sql的执行计划：</p>
<p><img src="/../img/1713625932495.png" alt="1713625932495"></p>
<p>原 SQL 使用的是 filesort 排序，而优化后的 SQL 使用的是索引排序。</p>
<h1 id="Join关联查询优化"><a href="#Join关联查询优化" class="headerlink" title="Join关联查询优化"></a><strong>Join关联查询优化</strong></h1><p>示例表</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `a` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `b` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_a` (`a`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 <span class="keyword">like</span> t1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入一些示例数据</span></span><br><span class="line"><span class="comment">-- 往t1表插入1万行记录</span></span><br><span class="line"><span class="keyword">drop</span>&nbsp;<span class="keyword">procedure</span>&nbsp;if&nbsp;<span class="keyword">exists</span>&nbsp;insert_t1;&nbsp;</span><br><span class="line">delimiter&nbsp;;;</span><br><span class="line"><span class="keyword">create</span>&nbsp;<span class="keyword">procedure</span>&nbsp;insert_t1()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">&nbsp;&nbsp;<span class="keyword">declare</span>&nbsp;i&nbsp;<span class="type">int</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;<span class="keyword">set</span>&nbsp;i<span class="operator">=</span><span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;while(i<span class="operator">&lt;=</span><span class="number">10000</span>)do&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">insert</span>&nbsp;<span class="keyword">into</span>&nbsp;t1(a,b)&nbsp;<span class="keyword">values</span>(i,i);&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">set</span>&nbsp;i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;while;</span><br><span class="line"><span class="keyword">end</span>;;</span><br><span class="line">delimiter&nbsp;;</span><br><span class="line"><span class="keyword">call</span>&nbsp;insert_t1();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 往t2表插入100行记录</span></span><br><span class="line"><span class="keyword">drop</span>&nbsp;<span class="keyword">procedure</span>&nbsp;if&nbsp;<span class="keyword">exists</span>&nbsp;insert_t2;&nbsp;</span><br><span class="line">delimiter&nbsp;;;</span><br><span class="line"><span class="keyword">create</span>&nbsp;<span class="keyword">procedure</span>&nbsp;insert_t2()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">&nbsp;&nbsp;<span class="keyword">declare</span>&nbsp;i&nbsp;<span class="type">int</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;<span class="keyword">set</span>&nbsp;i<span class="operator">=</span><span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;while(i<span class="operator">&lt;=</span><span class="number">100</span>)do&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">insert</span>&nbsp;<span class="keyword">into</span>&nbsp;t2(a,b)&nbsp;<span class="keyword">values</span>(i,i);&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">set</span>&nbsp;i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;while;</span><br><span class="line"><span class="keyword">end</span>;;</span><br><span class="line">delimiter&nbsp;;</span><br><span class="line"><span class="keyword">call</span>&nbsp;insert_t2();</span><br></pre></td></tr></tbody></table></figure>

<p><strong>mysql的表关联常见有两种算法</strong></p>
<ul>
<li><p>Nested-Loop Join 算法</p>
</li>
<li><p>Block Nested-Loop Join 算法</p>
</li>
</ul>
<p><strong>1、</strong> <strong>嵌套循环连接</strong> <strong>Nested-Loop Join(NLJ) 算法</strong></p>
<p>一次一行循环地从第一张表（称为<strong>驱动表</strong>）中读取行，在这行数据中取到关联字段，根据关联字段在另一张表（<strong>被驱动表</strong>）里取出满足条件的行，然后取出两张表的结果合集。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">inner</span> <span class="keyword">join</span> t2 <span class="keyword">on</span> t1.a<span class="operator">=</span> t2.a;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713626069301.png" alt="1713626069301"></p>
<p>从执行计划中可以看到这些信息：</p>
<ul>
<li>驱动表是 t2，被驱动表是 t1。先执行的就是驱动表(执行计划结果的id如果一样则按从上到下顺序执行sql)；优化器一般会优先选择<strong>小表做驱动表，</strong>用where条件过滤完驱动表，然后再跟被驱动表做关联查询。<strong>所以使用 inner join 时，排在前面的表并不一定就是驱动表。</strong></li>
<li>当使用left join时，左表是驱动表，右表是被驱动表，当使用right join时，右表时驱动表，左表是被驱动表，当使用join时，mysql会选择数据量比较小的表作为驱动表，大表作为被驱动表。</li>
<li>使用了 NLJ算法。一般 join 语句中，如果执行计划 Extra 中未出现 <strong>Using join buffer</strong> 则表示使用的 join 算法是 NLJ。</li>
</ul>
<p><strong>上面sql的大致流程如下：</strong></p>
<ol>
<li>从表 t2 中读取一行数据（如果t2表有查询过滤条件的，用先用条件过滤完，再从过滤结果里取出一行数据）；</li>
<li>从第 1 步的数据中，取出关联字段 a，到表 t1 中查找；</li>
<li>取出表 t1 中满足条件的行，跟 t2 中获取到的结果合并，作为结果返回给客户端；</li>
<li>重复上面 3 步。</li>
</ol>
<p>整个过程会读取 t2 表的所有数据(<strong>扫描100行</strong>)，然后遍历这每行数据中字段 a 的值，根据 t2 表中 a 的值索引扫描 t1 表中的对应行(<strong>扫描100次 t1 表的索引，1次扫描可以认为最终只扫描 t1 表一行完整数据，也就是总共 t1 表也扫描了100行</strong>)。因此整个过程扫描了 <strong>200 行</strong>。</p>
<p>如果被驱动表的关联字段没索引，**使用NLJ算法性能会比较低(下面有详细解释)**，mysql会选择Block Nested-Loop Join算法。</p>
<p><strong>2、</strong> <strong>基于块的嵌套循环连接</strong> <strong>Block Nested-Loop Join(BNL)算法</strong></p>
<p>把<strong>驱动表</strong>的数据读入到 join_buffer 中，然后扫描<strong>被驱动表</strong>，把<strong>被驱动表</strong>每一行取出来跟 join_buffer 中的数据做对比。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">inner</span> <span class="keyword">join</span> t2 <span class="keyword">on</span> t1.b<span class="operator">=</span> t2.b;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1713626368861.png" alt="1713626368861"></p>
<p>Extra 中 的Using join buffer (Block Nested Loop)说明该关联查询使用的是 BNL 算法。</p>
<p><strong>上面sql的大致流程如下：</strong></p>
<ol>
<li>把 t2 的所有数据放入到 <strong>join_buffer</strong> 中</li>
<li>把表 t1 中每一行取出来，跟 join_buffer 中的数据做对比</li>
<li>返回满足 join 条件的数据</li>
</ol>
<p>整个过程对表 t1 和 t2 都做了一次全表扫描，因此扫描的总行数为10000(表 t1 的数据总量) + 100(表 t2 的数据总量) = <strong>10100</strong>。并且 join_buffer 里的数据是无序的，因此对表 t1 中的每一行，都要做 100 次判断，所以内存中的判断次数是 100 * 10000= <strong>100 万次</strong>。</p>
<p>这个例子里表 t2 才 100 行，要是表 t2 是一个大表，join_buffer 放不下怎么办呢？·</p>
<p>join_buffer 的大小是由参数 join_buffer_size 设定的，默认值是 256k。如果放不下表 t2 的所有数据话，策略很简单，就是<strong>分段放</strong>。</p>
<p>比如 t2 表有1000行记录， join_buffer 一次只能放800行数据，那么执行过程就是先往 join_buffer 里放800行记录，然后从 t1 表里取数据跟 join_buffer 中数据对比得到部分结果，然后清空  join_buffer ，再放入 t2 表剩余200行记录，再次从 t1 表里取数据跟 join_buffer 中数据对比。所以就多扫了一次 t1 表。</p>
<p><strong>被驱动表的关联字段没索引为什么要选择使用 BNL 算法而不使用 Nested-Loop Join 呢？</strong></p>
<p>如果上面第二条sql使用 Nested-Loop Join，那么扫描行数为 100 * 10000 = 100万次，这个是<strong>磁盘扫描</strong>。</p>
<p>很显然，用BNL磁盘扫描次数少很多，相比于磁盘扫描，BNL的内存计算会快得多。</p>
<p>因此MySQL对于被驱动表的关联字段没索引的关联查询，一般都会使用 BNL 算法。如果有索引一般选择 NLJ 算法，有索引的情况下 NLJ 算法比 BNL算法性能更高</p>
<p><strong>对于关联sql的优化</strong></p>
<ul>
<li><strong>关联字段加索引</strong>，让mysql做join操作时尽量选择NLJ算法，驱动表因为需要全部查询出来，所以过滤的条件也尽量要走索引，避免全表扫描，总之，能走索引的过滤条件尽量都走索引</li>
<li><strong>小表驱动大表</strong>，写多表连接sql时如果<strong>明确知道</strong>哪张表是小表可以用straight_join写法固定连接驱动方式，省去mysql优化器自己判断的时间</li>
</ul>
<p><strong>straight_join解释：straight_join</strong>功能同join类似，但能让左边的表来驱动右边的表，能改表优化器对于联表查询的执行顺序。</p>
<p>比如：select * from t2 straight_join t1 on t2.a = t1.a; 代表指定mysql选着 t2 表作为驱动表。</p>
<ul>
<li><strong>straight_join</strong>只适用于inner join，并不适用于left join，right join。（因为left join，right join已经代表指定了表的执行顺序）</li>
<li>尽可能让优化器去判断，因为大部分情况下mysql优化器是比人要聪明的。使用<strong>straight_join</strong>一定要慎重，因为部分情况下人为指定的执行顺序并不一定会比优化引擎要靠谱。</li>
</ul>
<p><strong>对于小表定义的明确</strong></p>
<p>在决定哪个表做驱动表的时候，应该是两个表按照各自的条件过滤，<strong>过滤完成之后</strong>，计算参与 join 的各个字段的总数据量，<strong>数据量小的那个表，就是“小表”</strong>，应该作为驱动表。</p>
<h1 id="in和exsits优化"><a href="#in和exsits优化" class="headerlink" title="in和exsits优化"></a><strong>in和exsits优化</strong></h1><p>原则：<strong>小表驱动大表</strong>，即小的数据集驱动大的数据集</p>
<p><strong>in：</strong>当B表的数据集小于A表的数据集时，in优于exists </p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> B)  </span><br><span class="line">#等价于：</span><br><span class="line">　　<span class="keyword">for</span>(<span class="keyword">select</span> id <span class="keyword">from</span> B){</span><br><span class="line">      <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> A.id <span class="operator">=</span> B.id</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>





<p><strong>exists：</strong>当A表的数据集小于B表的数据集时，exists优于in</p>
<p>　　将主查询A的数据，放到子查询B中做条件验证，根据验证结果（true或false）来决定主查询的数据是否保留</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id <span class="operator">=</span> A.id)</span><br><span class="line">#等价于:</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A){</span><br><span class="line">      <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> B <span class="keyword">where</span> B.id <span class="operator">=</span> A.id</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">#A表与B表的ID字段应建立索引</span><br></pre></td></tr></tbody></table></figure>

<p>1、EXISTS (subquery)只返回TRUE或FALSE,因此子查询中的SELECT * 也可以用SELECT 1替换,官方说法是实际执行时会忽略SELECT清单,因此没有区别</p>
<p>2、EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比</p>
<p>3、EXISTS子查询往往也可以用JOIN来代替，何种最优需要具体问题具体分析</p>
<h1 id="count-查询优化"><a href="#count-查询优化" class="headerlink" title="count(*)查询优化"></a><strong>count(*)查询优化</strong></h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 临时关闭mysql查询缓存，为了查看sql多次执行的真实时间</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> query_cache_size<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> query_cache_type<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> employees;</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> employees;</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">select</span> <span class="built_in">count</span>(name) <span class="keyword">from</span> employees;</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> employees;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意：以上4条sql只有根据某个字段count不会统计字段为null值的数据行</strong></p>
<p><img src="/../img/1713626990762.png" alt="1713626990762"></p>
<p><strong>四个sql的执行计划一样，说明这四个sql执行效率应该差不多</strong></p>
<p><strong>字段有索引：count(*)≈count(1)&gt;count(字段)&gt;count(主键 id)    //字段有索引，count(字段)统计走二级索引，二级索引存储数据比主键索引少，所以count(字段)&gt;count(主键 id)</strong> </p>
<p><strong>字段无索引：count(*)≈count(1)&gt;count(主键 id)&gt;count(字段)    //字段没有索引count(字段)统计走不了索引，count(主键 id)还可以走主键索引，所以count(主键 id)&gt;count(字段)</strong></p>
<p>count(1)跟count(字段)执行过程类似，不过count(1)不需要取出字段统计，就用常量1做统计，count(字段)还需要取出字段，所以理论上count(1)比count(字段)会快一点。</p>
<p>count(*) 是例外，mysql并不会把全部字段取出来，而是专门做了优化，不取值，按行累加，效率很高，所以不需要用count(列名)或count(常量)来替代 count(*)。</p>
<p>为什么对于count(id)，mysql最终选择辅助索引而不是主键聚集索引？因为二级索引相对主键索引存储数据更少，检索性能应该更高，mysql内部做了点优化(应该是在5.7版本才优化)。</p>
<p><strong>常见优化方法</strong></p>
<p><strong>1、查询mysql自己维护的总行数</strong></p>
<p>对于<strong>myisam存储引擎</strong>的表做不带where条件的count查询性能是很高的，因为myisam存储引擎的表的总行数会被mysql存储在磁盘上，查询不需要计算</p>
<p><img src="/../img/1713627146026.png" alt="1713627146026"></p>
<p>对于<strong>innodb存储引擎</strong>的表mysql不会存储表的总记录行数(因为有MVCC机制，后面会讲)，查询count需要实时计算</p>
<p><strong>2、show table status</strong></p>
<p>如果只需要知道表总行数的估计值可以用如下sql查询，性能很高</p>
<p><img src="/../img/1713627188984.png" alt="1713627188984"></p>
<p><strong>3、将总数维护到Redis里</strong></p>
<p>插入或删除表数据行的时候同时维护redis里的表总行数key的计数值(用incr或decr命令)，但是这种方式可能不准，很难保证表操作和redis操作的事务一致性</p>
<p><strong>4、增加数据库计数表</strong></p>
<p>插入或删除表数据行的时候同时维护计数表，让他们在同一个事务里操作</p>
<h1 id="阿里巴巴Mysql规范解读"><a href="#阿里巴巴Mysql规范解读" class="headerlink" title="阿里巴巴Mysql规范解读"></a><strong>阿里巴巴Mysql规范解读</strong></h1><p><strong>补充：MySQL数据类型选择</strong></p>
<p>在MySQL中，选择正确的数据类型，对于性能至关重要。一般应该遵循下面两步：</p>
<p>（1）确定合适的大类型：数字、字符串、时间、二进制；</p>
<p>（2）确定具体的类型：有无符号、取值范围、变长定长等。</p>
<p>在MySQL数据类型设置方面，尽量用更小的数据类型，因为它们通常有更好的性能，花费更少的硬件资源。并且，尽量把字段定义为NOT NULL，避免使用NULL。</p>
<p><strong>1、数值类型</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>范围（有符号）</th>
<th>范围（无符号）</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>TINYINT</td>
<td>1 字节</td>
<td>(-128, 127)</td>
<td>(0, 255)</td>
<td>小整数值</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>2 字节</td>
<td>(-32 768, 32 767)</td>
<td>(0, 65 535)</td>
<td>大整数值</td>
</tr>
<tr>
<td>MEDIUMINT</td>
<td>3 字节</td>
<td>(-8 388 608, 8 388 607)</td>
<td>(0, 16 777 215)</td>
<td>大整数值</td>
</tr>
<tr>
<td>INT或INTEGER</td>
<td>4 字节</td>
<td>(-2 147 483 648, 2 147 483 647)</td>
<td>(0, 4 294 967 295)</td>
<td>大整数值</td>
</tr>
<tr>
<td>BIGINT</td>
<td>8 字节</td>
<td>(-9 233 372 036 854 775 808, 9 223 372 036 854 775 807)</td>
<td>(0, 18 446 744 073 709 551 615)</td>
<td>极大整数值</td>
</tr>
<tr>
<td>FLOAT</td>
<td>4 字节</td>
<td>(-3.402 823 466 E+38, 1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38)</td>
<td>0, (1.175 494 351 E-38, 3.402 823 466 E+38)</td>
<td>单精度浮点数值</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>8 字节</td>
<td>(1.797 693 134 862 315 7 E+308, 2.225 073 858 507 201 4 E-308), 0, (2.225 073 858 507 201 4 E-308, 1.797 693 134 862 315 7 E+308)</td>
<td>0, (2.225 073 858 507 201 4 E-308, 1.797 693 134 862 315 7 E+308)</td>
<td>双精度浮点数值</td>
</tr>
<tr>
<td>DECIMAL</td>
<td>对DECIMAL(M,D) ，如果M&gt;D，为M+2否则为D+2</td>
<td>依赖于M和D的值</td>
<td>依赖于M和D的值</td>
<td>小数值</td>
</tr>
</tbody></table>
<p><strong>优化建议</strong></p>
<ol>
<li>如果整形数据没有负数，如ID号，建议指定为UNSIGNED无符号类型，容量可以扩大一倍。</li>
<li>建议使用TINYINT代替ENUM、BITENUM、SET。</li>
<li>避免使用整数的显示宽度(参看文档最后)，也就是说，不要用INT(10)类似的方法指定字段显示宽度，直接用INT。</li>
<li>DECIMAL最适合保存准确度要求高，而且用于计算的数据，比如价格。但是在使用DECIMAL类型的时候，注意长度设置。</li>
<li>建议使用整形类型来运算和存储实数，方法是，实数乘以相应的倍数后再操作。</li>
<li>整数通常是最佳的数据类型，因为它速度快，并且能使用AUTO_INCREMENT。</li>
</ol>
<p><strong>2、日期和时间</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小(字节)</th>
<th>范围</th>
<th>格式</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>DATE</td>
<td>3</td>
<td>1000-01-01 到 9999-12-31</td>
<td>YYYY-MM-DD</td>
<td>日期值</td>
</tr>
<tr>
<td>TIME</td>
<td>3</td>
<td>‘-838:59:59’ 到 ‘838:59:59’</td>
<td>HH:MM:SS</td>
<td>时间值或持续时间</td>
</tr>
<tr>
<td>YEAR</td>
<td>1</td>
<td>1901 到 2155</td>
<td>YYYY</td>
<td>年份值</td>
</tr>
<tr>
<td>DATETIME</td>
<td>8</td>
<td>1000-01-01 00:00:00 到 9999-12-31 23:59:59</td>
<td>YYYY-MM-DD HH:MM:SS</td>
<td>混合日期和时间值</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>4</td>
<td>1970-01-01 00:00:00 到 2038-01-19 03:14:07</td>
<td>YYYYMMDDhhmmss</td>
<td>混合日期和时间值，时间戳</td>
</tr>
</tbody></table>
<p><strong>优化建议</strong></p>
<ol>
<li>MySQL能存储的最小时间粒度为秒。</li>
<li>建议用DATE数据类型来保存日期。MySQL中默认的日期格式是yyyy-mm-dd。</li>
<li>用MySQL的内建类型DATE、TIME、DATETIME来存储时间，而不是使用字符串。</li>
<li>当数据格式为TIMESTAMP和DATETIME时，可以用CURRENT_TIMESTAMP作为默认（MySQL5.6以后），MySQL会自动返回记录插入的确切时间。</li>
<li>TIMESTAMP是UTC时间戳，与时区相关。</li>
<li>DATETIME的存储格式是一个YYYYMMDD HH:MM:SS的整数，与时区无关，你存了什么，读出来就是什么。</li>
<li>除非有特殊需求，一般的公司建议使用TIMESTAMP，它比DATETIME更节约空间，但是像阿里这样的公司一般会用DATETIME，因为不用考虑TIMESTAMP将来的时间上限问题。</li>
<li>有时人们把Unix的时间戳保存为整数值，但是这通常没有任何好处，这种格式处理起来不太方便，我们并不推荐它。</li>
</ol>
<p><strong>3、字符串</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>CHAR</td>
<td>0-255字节</td>
<td>定长字符串，char(n)当插入的字符数不足n时(n代表字符数)，插入空格进行补充保存。在进行检索时，尾部的空格会被去掉。</td>
</tr>
<tr>
<td>VARCHAR</td>
<td>0-65535 字节</td>
<td>变长字符串，varchar(n)中的n代表最大字符数，插入的字符数不足n时不会补充空格</td>
</tr>
<tr>
<td>TINYBLOB</td>
<td>0-255字节</td>
<td>不超过 255 个字符的二进制字符串</td>
</tr>
<tr>
<td>TINYTEXT</td>
<td>0-255字节</td>
<td>短文本字符串</td>
</tr>
<tr>
<td>BLOB</td>
<td>0-65 535字节</td>
<td>二进制形式的长文本数据</td>
</tr>
<tr>
<td>TEXT</td>
<td>0-65 535字节</td>
<td>长文本数据</td>
</tr>
<tr>
<td>MEDIUMBLOB</td>
<td>0-16 777 215字节</td>
<td>二进制形式的中等长度文本数据</td>
</tr>
<tr>
<td>MEDIUMTEXT</td>
<td>0-16 777 215字节</td>
<td>中等长度文本数据</td>
</tr>
<tr>
<td>LONGBLOB</td>
<td>0-4 294 967 295字节</td>
<td>二进制形式的极大文本数据</td>
</tr>
<tr>
<td>LONGTEXT</td>
<td>0-4 294 967 295字节</td>
<td>极大文本数据</td>
</tr>
</tbody></table>
<p><strong>优化建议</strong></p>
<ol>
<li>字符串的长度相差较大用VARCHAR；字符串短，且所有值都接近一个长度用CHAR。</li>
<li>CHAR和VARCHAR适用于包括人名、邮政编码、电话号码和不超过255个字符长度的任意字母数字组合。那些要用来计算的数字不要用VARCHAR类型保存，因为可能会导致一些与计算相关的问题。换句话说，可能影响到计算的准确性和完整性。</li>
<li>尽量少用BLOB和TEXT，如果实在要用可以考虑将BLOB和TEXT字段单独存一张表，用id关联。</li>
<li>BLOB系列存储二进制字符串，与字符集无关。TEXT系列存储非二进制字符串，与字符集相关。</li>
<li>BLOB和TEXT都不能有默认值。</li>
</ol>
<p><strong>PS：INT显示宽度</strong></p>
<p>我们经常会使用命令来创建数据表，而且同时会指定一个长度，如下。但是，这里的长度并非是TINYINT类型存储的最大长度，而是显示的最大长度。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`(</span><br><span class="line">    `id` TINYINT(<span class="number">2</span>) UNSIGNED</span><br><span class="line">);  </span><br></pre></td></tr></tbody></table></figure>

<p>这里表示user表的id字段的类型是TINYINT，可以存储的最大数值是255。所以，在存储数据时，如果存入值小于等于255，如200，虽然超过2位，但是没有超出TINYINT类型长度，所以可以正常保存；如果存入值大于255，如500，那么MySQL会自动保存为TINYINT类型的最大值255。</p>
<p>在查询数据时，不管查询结果为何值，都按实际输出。这里TINYINT(2)中2的作用就是，当需要在查询结果前填充0时，命令中加上ZEROFILL就可以实现，如：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`id` TINYINT(<span class="number">2</span>) UNSIGNED ZEROFILL</span><br></pre></td></tr></tbody></table></figure>

<p>这样，查询结果如果是5，那输出就是05。如果指定TINYINT(5)，那输出就是00005，其实实际存储的值还是5，而且存储的数据不会超过255，只是MySQL输出数据时在前面填充了0。</p>
<p>换句话说，在MySQL命令中，字段的类型长度TINYINT(2)、INT(11)不会影响数据的插入，只会在使用ZEROFILL时有用，让查询结果前填充0。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Radish</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%B8%89)%E2%80%94%E2%80%94Mysql%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/">http://example.com/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%B8%89)%E2%80%94%E2%80%94Mysql%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">萝卜的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="/../img/MySQL.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%BA%8C)%E2%80%94%E2%80%94Explain%E8%AF%A6%E8%A7%A3%E4%B8%8E%E7%B4%A2%E5%BC%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" title="MySQL性能优化(二)——Explain详解与索引最佳实践"><img class="cover" src="/../img/MySQL.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL性能优化(二)——Explain详解与索引最佳实践</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%B8%80)%E2%80%94%E2%80%94MySQl%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" title="MySQL性能优化(一)——MySQl索引底层数据结构与算法"><img class="cover" src="/../img/MySQL.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL性能优化(一)——MySQl索引底层数据结构与算法</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/07/18/MySQL%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8(%E4%B8%80)%E2%80%94%E2%80%94%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" title="MySQL分库分表(一)——集群搭建"><img class="cover" src="/../img/MySQL.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-18</div><div class="title">MySQL分库分表(一)——集群搭建</div></div></a></div><div><a href="/2023/07/22/MySQL%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8(%E4%B8%89)%E2%80%94%E2%80%94%E6%90%AD%E5%BB%BA%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6/" title="MySQL分库分表(三)——搭建半同步复制"><img class="cover" src="/../img/MySQL.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-22</div><div class="title">MySQL分库分表(三)——搭建半同步复制</div></div></a></div><div><a href="/2023/07/22/MySQL%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8(%E4%BA%8C)%E2%80%94%E2%80%94%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9%E4%B8%8EMySQL%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" title="MySQL分库分表(二)——集群扩容与MySQL数据迁移"><img class="cover" src="/../img/MySQL.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-22</div><div class="title">MySQL分库分表(二)——集群扩容与MySQL数据迁移</div></div></a></div><div><a href="/2024/04/18/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%B8%80)%E2%80%94%E2%80%94MySQl%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" title="MySQL性能优化(一)——MySQl索引底层数据结构与算法"><img class="cover" src="/../img/MySQL.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-18</div><div class="title">MySQL性能优化(一)——MySQl索引底层数据结构与算法</div></div></a></div><div><a href="/2024/04/20/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E4%BA%94)%E2%80%94%E2%80%94Mysql%E9%94%81%E6%9C%BA%E5%88%B6%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%A5%E5%8F%8AMVCC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%20-%20%E5%89%AF%E6%9C%AC/" title="MySQL性能优化(五)——Mysql锁机制与优化实践以及MVCC底层原理剖析"><img class="cover" src="/../img/MySQL.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-20</div><div class="title">MySQL性能优化(五)——Mysql锁机制与优化实践以及MVCC底层原理剖析</div></div></a></div><div><a href="/2024/04/20/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96(%E5%9B%9B)%E2%80%94%E2%80%94MySQL%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5/" title="MySQL性能优化(四)——MySQL事务原理与优化实践"><img class="cover" src="/../img/MySQL.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-20</div><div class="title">MySQL性能优化(四)——MySQL事务原理与优化实践</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Radish</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">愿内心深处的懦弱 不再将我吞噬</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="toc-number">1.</span> <span class="toc-text">Mysql如何选择合适的索引</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81sql%E6%B7%B1%E5%85%A5%E4%BC%98%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">常见sql深入优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">3.</span> <span class="toc-text">索引设计原则</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">慢SQL查询优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E5%AE%9E%E6%88%98"><span class="toc-number">5.</span> <span class="toc-text">索引设计实战</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">分页查询优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Join%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Join关联查询优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#in%E5%92%8Cexsits%E4%BC%98%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">in和exsits优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#count-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">count(*)查询优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4Mysql%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB"><span class="toc-number">10.</span> <span class="toc-text">阿里巴巴Mysql规范解读</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/03/openVPN%E6%90%AD%E5%BB%BA/" title="OpenVPN搭建流程">OpenVPN搭建流程</a><time datetime="2024-08-03T06:17:00.000Z" title="发表于 2024-08-03 14:17:00">2024-08-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/26/ES(%E4%B8%89)-ElasticSearch%E6%90%9C%E7%B4%A2%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%85%A5%E4%B8%8E%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E5%AE%9E%E6%88%98/" title="ES(三)-ElasticSearch搜索技术深入与聚合查询实战"><img src="/../img/es_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES(三)-ElasticSearch搜索技术深入与聚合查询实战"></a><div class="content"><a class="title" href="/2024/06/26/ES(%E4%B8%89)-ElasticSearch%E6%90%9C%E7%B4%A2%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%85%A5%E4%B8%8E%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E5%AE%9E%E6%88%98/" title="ES(三)-ElasticSearch搜索技术深入与聚合查询实战">ES(三)-ElasticSearch搜索技术深入与聚合查询实战</a><time datetime="2024-06-26T12:23:00.000Z" title="发表于 2024-06-26 20:23:00">2024-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/21/PyTorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/" title="PyTorch深度学习快速入门(一)-环境安装"><img src="/../img/pytorch.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PyTorch深度学习快速入门(一)-环境安装"></a><div class="content"><a class="title" href="/2024/06/21/PyTorch%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/" title="PyTorch深度学习快速入门(一)-环境安装">PyTorch深度学习快速入门(一)-环境安装</a><time datetime="2024-06-21T15:37:00.000Z" title="发表于 2024-06-21 23:37:00">2024-06-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/" title="ES(二)-ElasticSearch高级语法Query DSL实战"><img src="/../img/es_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES(二)-ElasticSearch高级语法Query DSL实战"></a><div class="content"><a class="title" href="/2024/06/18/ES(%E4%BA%8C)-ElasticSearch%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95Query%20DSL%E5%AE%9E%E6%88%98/" title="ES(二)-ElasticSearch高级语法Query DSL实战">ES(二)-ElasticSearch高级语法Query DSL实战</a><time datetime="2024-06-18T15:50:00.000Z" title="发表于 2024-06-18 23:50:00">2024-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/11/ES(%E4%B8%80)-ElasticSearch%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/" title="ES(一)-ElasticSearch快速入门实战"><img src="/../img/es_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES(一)-ElasticSearch快速入门实战"></a><div class="content"><a class="title" href="/2024/06/11/ES(%E4%B8%80)-ElasticSearch%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/" title="ES(一)-ElasticSearch快速入门实战">ES(一)-ElasticSearch快速入门实战</a><time datetime="2024-06-11T15:06:00.000Z" title="发表于 2024-06-11 23:06:00">2024-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2023 - 2024 By Radish</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>