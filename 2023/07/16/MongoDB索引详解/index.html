<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MongoDB索引详解 | 萝卜的博客</title><meta name="author" content="Radish"><meta name="copyright" content="Radish"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1、索引数据结构思考：MongoDB索引数据结构是B-Tree还是B+Tree?mongodb用的数据结构是B-Tree,具体来说是B+Tree B-Tree说法来源于官方文档，然后就导致了分歧：有人说MongoDB索引数据结构使用的是B-Tree,有的人又说是B+Tree。  MongoDB官方文档：https://docs.mongodb.com/manual/indexes/ MongoDB">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB索引详解">
<meta property="og:url" content="http://example.com/2023/07/16/MongoDB%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="萝卜的博客">
<meta property="og:description" content="1、索引数据结构思考：MongoDB索引数据结构是B-Tree还是B+Tree?mongodb用的数据结构是B-Tree,具体来说是B+Tree B-Tree说法来源于官方文档，然后就导致了分歧：有人说MongoDB索引数据结构使用的是B-Tree,有的人又说是B+Tree。  MongoDB官方文档：https://docs.mongodb.com/manual/indexes/ MongoDB">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/mongodb.png">
<meta property="article:published_time" content="2023-07-16T08:21:00.000Z">
<meta property="article:modified_time" content="2023-07-16T12:22:52.650Z">
<meta property="article:author" content="Radish">
<meta property="article:tag" content="MongoDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/mongodb.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/07/16/MongoDB%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MongoDB索引详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-16 20:22:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E9%9F%B3%E4%B9%90"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page child" href="/%E8%A7%86%E9%A2%91"><i class="fa-fw /movies/"></i><span> 1</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="萝卜的博客"><span class="site-name">萝卜的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E9%9F%B3%E4%B9%90"><i class="fa-fw /music/"></i><span> 0</span></a></li><li><a class="site-page child" href="/%E8%A7%86%E9%A2%91"><i class="fa-fw /movies/"></i><span> 1</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">MongoDB索引详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-16T08:21:00.000Z" title="发表于 2023-07-16 16:21:00">2023-07-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-16T12:22:52.650Z" title="更新于 2023-07-16 20:22:52">2023-07-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/">Java后端</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/">MongoDB</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MongoDB索引详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="1、索引数据结构"><a href="#1、索引数据结构" class="headerlink" title="1、索引数据结构"></a>1、索引数据结构</h1><p><font color="red">思考：MongoDB索引数据结构是B-Tree还是B+Tree?</font><br>mongodb用的数据结构是B-Tree,具体来说是B+Tree</p>
<p>B-Tree说法来源于官方文档，然后就导致了分歧：有人说MongoDB索引数据结构使用的是B-Tree,有的人又说是B+Tree。</p>
<blockquote>
<p>MongoDB官方文档：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/indexes/">https://docs.mongodb.com/manual/indexes/</a></p>
<p>MongoDB indexes use a B-tree data structure.</p>
</blockquote>
<p>![截图 (../img/截图 (4).png)](C:/Users/Radish/Downloads/截图 (4).png)</p>
<blockquote>
<p>WiredTiger官方文档：<a target="_blank" rel="noopener" href="https://source.wiredtiger.com/3.0.0/tune_page_size_and_comp.html">https://source.wiredtiger.com/3.0.0/tune_page_size_and_comp.html</a></p>
<p>WiredTiger maintains a table’s data in memory using a data structure called a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/B-tree">B-Tree</a> ( <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/B%2B_tree">B+ Tree</a> to be specific), referring to the nodes of a B-Tree as pages. Internal pages carry only keys. The leaf pages store both keys and values.</p>
</blockquote>
<p>![截图 (../img/截图 (5).png)](C:/Users/Radish/Downloads/截图 (5).png)</p>
<h2 id="WiredTiger数据文件在磁盘的存储结构"><a href="#WiredTiger数据文件在磁盘的存储结构" class="headerlink" title="WiredTiger数据文件在磁盘的存储结构"></a><strong>WiredTiger数据文件在磁盘的存储结构</strong></h2><p>![截图 (../img/截图 (6).png)](C:/Users/Radish/Downloads/截图 (6).png)</p>
<p>B+ Tree中的leaf page包含一个页头（page header）、块头（block header）和真正的数据（key/value），其中页头定义了页的类型、页中实际载荷数据的大小、页中记录条数等信息；块头定义了此页的checksum、块在磁盘上的寻址位置等信息。</p>
<p>WiredTiger有一个块设备管理的模块，用来为page分配block。如果要定位某一行数据（key/value）的位置，可以先通过block的位置找到此page（相对于文件起始位置的偏移量），再通过page找到行数据的相对位置，最后可以得到行数据相对于文件起始位置的偏移量offsets。</p>
<h1 id="2、索引操作"><a href="#2、索引操作" class="headerlink" title="2、索引操作"></a>2、索引操作</h1><h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><p>创建索引语法格式</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">collection</span>.<span class="title function_">createIndex</span>(keys, options)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Key 值为你要创建的索引字段，1 按升序创建索引， -1  按降序创建索引</li>
<li>可选参数列表如下：</li>
</ul>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td>background</td>
<td>Boolean</td>
<td>建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 “background” 可选参数。 “background” 默认值为false。</td>
</tr>
<tr>
<td>unique</td>
<td>Boolean</td>
<td>建立的索引是否唯一。指定为true创建唯一索引。默认值为false.</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称。</td>
</tr>
<tr>
<td>dropDups</td>
<td>Boolean</td>
<td>3.0+版本已废弃。在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 false.</td>
</tr>
<tr>
<td>sparse</td>
<td>Boolean</td>
<td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索引字段中不会查询出不包含对应字段的文档。默认值为 false.</td>
</tr>
<tr>
<td>expireAfterSeconds</td>
<td>integer</td>
<td>指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td>
</tr>
<tr>
<td>v</td>
<td>index version</td>
<td>索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td>
</tr>
<tr>
<td>weights</td>
<td>document</td>
<td>索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td>default_language</td>
<td>string</td>
<td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td>language_override</td>
<td>string</td>
<td>对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language.</td>
</tr>
</tbody></table>
<p>注意：<font color="red">3.0.0 版本前创建索引方法为 db.collection.ensureIndex()</font></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建索引后台执行</span><br><span class="line">db.<span class="property">values</span>.<span class="title function_">createIndex</span>({<span class="attr">open</span>: <span class="number">1</span>, <span class="attr">close</span>: <span class="number">1</span>}, {<span class="attr">background</span>: <span class="literal">true</span>})</span><br><span class="line"># 创建唯一索引</span><br><span class="line">db.<span class="property">values</span>.<span class="title function_">createIndex</span>({<span class="attr">title</span>:<span class="number">1</span>},{<span class="attr">unique</span>:<span class="literal">true</span>})</span><br></pre></td></tr></tbody></table></figure>



<h2 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h2><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查看索引信息</span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">getIndexes</span>()</span><br><span class="line">#查看索引键</span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">getIndexKeys</span>()</span><br></pre></td></tr></tbody></table></figure>



<h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#删除集合指定索引</span><br><span class="line">db.<span class="property">col</span>.<span class="title function_">dropIndex</span>(<span class="string">"索引名称"</span>)</span><br><span class="line">#删除集合所有索引   不能删除主键索引</span><br><span class="line">db.<span class="property">col</span>.<span class="title function_">dropIndexes</span>()</span><br></pre></td></tr></tbody></table></figure>



<h1 id="3、索引类型"><a href="#3、索引类型" class="headerlink" title="3、索引类型"></a>3、索引类型</h1><p>与大多数数据库一样，MongoDB支持各种丰富的索引类型，包括单键索引、复合索引，唯一索引等一些常用的结构。由于采用了灵活可变的文档类型，因此它也同样支持对嵌套字段、数组进行索引。通过建立合适的索引，我们可以极大地提升数据的检索速度。在一些特殊应用场景，MongoDB还支持地理空间索引、文本检索索引、TTL索引等不同的特性。</p>
<h2 id="单键索引（Single-Field-Indexes）"><a href="#单键索引（Single-Field-Indexes）" class="headerlink" title="单键索引（Single Field Indexes）"></a>单键索引（Single Field Indexes）</h2><p>在某一个特定的字段上建立索引 mongoDB在ID上建立了唯一的单键索引,所以经常会使用id来进行查询； 在索引字段上进行精确匹配、排序以及范围查找都会使用此索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">books</span>.<span class="title function_">createIndex</span>({<span class="attr">title</span>:<span class="number">1</span>})</span><br><span class="line"># 对内嵌文档字段创建索引：</span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">createIndex</span>({<span class="string">"author.name"</span>:<span class="number">1</span>})</span><br></pre></td></tr></tbody></table></figure>



<h2 id="复合索引（Compound-Index）"><a href="#复合索引（Compound-Index）" class="headerlink" title="复合索引（Compound Index）"></a><strong>复合索引（Compound Index）</strong></h2><p>复合索引是多个字段组合而成的索引，其性质和单字段索引类似。但不同的是，复合索引中字段的顺序、字段的升降序对查询性能有直接的影响，因此在设计复合索引时则需要考虑不同的查询场景。</p>
<p>![截图 (../img/截图 (7).png)](C:/Users/Radish/Downloads/截图 (7).png)</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">books</span>.<span class="title function_">createIndex</span>({<span class="attr">type</span>:<span class="number">1</span>,<span class="attr">favCount</span>:<span class="number">1</span>})</span><br><span class="line">#查看执行计划</span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">find</span>({<span class="attr">type</span>:<span class="string">"novel"</span>,<span class="attr">favCount</span>:{<span class="attr">$gt</span>:<span class="number">50</span>}}).<span class="title function_">explain</span>()</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1689508828036.png" alt="1689508828036"></p>
<h2 id="多键-数组-索引（Multikey-Index）"><a href="#多键-数组-索引（Multikey-Index）" class="headerlink" title="多键(数组)索引（Multikey Index）"></a><strong>多键(数组)索引（Multikey Index）</strong></h2><p><font color="red">在数组的属性上建立索引。</font>针对这个数组的任意值的查询都会定位到这个文档,既多个索引入口或者键值引用同一个文档</p>
<p>准备inventory集合：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">{ <span class="attr">_id</span>: <span class="number">5</span>, <span class="attr">type</span>: <span class="string">"food"</span>, <span class="attr">item</span>: <span class="string">"aaa"</span>, <span class="attr">ratings</span>: [ <span class="number">5</span>, <span class="number">8</span>, <span class="number">9</span> ] },</span><br><span class="line">{ <span class="attr">_id</span>: <span class="number">6</span>, <span class="attr">type</span>: <span class="string">"food"</span>, <span class="attr">item</span>: <span class="string">"bbb"</span>, <span class="attr">ratings</span>: [ <span class="number">5</span>, <span class="number">9</span> ] },</span><br><span class="line">{ <span class="attr">_id</span>: <span class="number">7</span>, <span class="attr">type</span>: <span class="string">"food"</span>, <span class="attr">item</span>: <span class="string">"ccc"</span>, <span class="attr">ratings</span>: [ <span class="number">9</span>, <span class="number">5</span>, <span class="number">8</span> ] },</span><br><span class="line">{ <span class="attr">_id</span>: <span class="number">8</span>, <span class="attr">type</span>: <span class="string">"food"</span>, <span class="attr">item</span>: <span class="string">"ddd"</span>, <span class="attr">ratings</span>: [ <span class="number">9</span>, <span class="number">5</span> ] },</span><br><span class="line">{ <span class="attr">_id</span>: <span class="number">9</span>, <span class="attr">type</span>: <span class="string">"food"</span>, <span class="attr">item</span>: <span class="string">"eee"</span>, <span class="attr">ratings</span>: [ <span class="number">5</span>, <span class="number">9</span>, <span class="number">5</span> ] }</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<p>创建多键索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">createIndex</span>( { <span class="attr">ratings</span>: <span class="number">1</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>多键索引很容易与复合索引产生混淆，复合索引是多个字段的组合，而多键索引则仅仅是在一个字段上出现了多键（multi key）。而实质上，多键索引也可以出现在复合字段上</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建复合多值索引</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">createIndex</span>( { <span class="attr">item</span>:<span class="number">1</span>,<span class="attr">ratings</span>: <span class="number">1</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">注意： MongoDB并不支持一个复合索引中同时出现多个数组字段</font></p>
<p>嵌入文档的索引数组</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">{</span><br><span class="line">  <span class="attr">_id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">item</span>: <span class="string">"abc"</span>,</span><br><span class="line">  <span class="attr">stock</span>: [</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"S"</span>, <span class="attr">color</span>: <span class="string">"red"</span>, <span class="attr">quantity</span>: <span class="number">25</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"S"</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">quantity</span>: <span class="number">10</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"M"</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">quantity</span>: <span class="number">50</span> }</span><br><span class="line">  ]</span><br><span class="line">},</span><br><span class="line">{</span><br><span class="line">  <span class="attr">_id</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">item</span>: <span class="string">"def"</span>,</span><br><span class="line">  <span class="attr">stock</span>: [</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"S"</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">quantity</span>: <span class="number">20</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"M"</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">quantity</span>: <span class="number">5</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"M"</span>, <span class="attr">color</span>: <span class="string">"black"</span>, <span class="attr">quantity</span>: <span class="number">10</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"L"</span>, <span class="attr">color</span>: <span class="string">"red"</span>, <span class="attr">quantity</span>: <span class="number">2</span> }</span><br><span class="line">  ]</span><br><span class="line">},</span><br><span class="line">{</span><br><span class="line">  <span class="attr">_id</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">item</span>: <span class="string">"ijk"</span>,</span><br><span class="line">  <span class="attr">stock</span>: [</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"M"</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">quantity</span>: <span class="number">15</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"L"</span>, <span class="attr">color</span>: <span class="string">"blue"</span>, <span class="attr">quantity</span>: <span class="number">100</span> },</span><br><span class="line">    { <span class="attr">size</span>: <span class="string">"L"</span>, <span class="attr">color</span>: <span class="string">"red"</span>, <span class="attr">quantity</span>: <span class="number">25</span> }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<p>在包含嵌套对象的数组字段上创建多键索引</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.createIndex( { "stock.size": 1, "stock.quantity": 1 } )</span><br><span class="line"></span><br><span class="line">db.inventory.find({"stock.size":"S","stock.quantity":{$gt:20}}).explain()</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../img/1689509094334.png" alt="1689509094334"></p>
<h2 id="Hash索引（Hashed-Indexes）"><a href="#Hash索引（Hashed-Indexes）" class="headerlink" title="Hash索引（Hashed Indexes）"></a><strong>Hash索引（Hashed Indexes）</strong></h2><p>不同于传统的B-Tree索引,哈希索引使用hash函数来创建索引。在索引字段上进行精确匹配,但不支持范围查询,不支持多键hash； Hash索引上的入口是均匀分布的,在分片集合中非常有用；</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">users</span>.<span class="title function_">createIndex</span>({username : <span class="string">'hashed'</span>})</span><br></pre></td></tr></tbody></table></figure>



<h2 id="地理空间索引（Geospatial-Index）"><a href="#地理空间索引（Geospatial-Index）" class="headerlink" title="地理空间索引（Geospatial Index）"></a><strong>地理空间索引（Geospatial Index）</strong></h2><p>在移动互联网时代，基于地理位置的检索（LBS）功能几乎是所有应用系统的标配。MongoDB为地理空间检索提供了非常方便的功能。<font color="red">地理空间索引（2dsphereindex）就是专门用于实现位置检索的一种特殊索引。</font></p>
<p>案例：MongoDB如何实现“查询附近商家”？</p>
<p>假设商家的数据模型如下：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurant</span>.<span class="title function_">insert</span>({</span><br><span class="line">    <span class="attr">restaurantId</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">restaurantName</span>:<span class="string">"兰州牛肉面"</span>,</span><br><span class="line">    location : {</span><br><span class="line">        <span class="attr">type</span>: <span class="string">"Point"</span>,</span><br><span class="line">        <span class="attr">coordinates</span>: [ -<span class="number">73.97</span>, <span class="number">40.77</span> ]</span><br><span class="line">    }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>创建一个2dsphere索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurant</span>.<span class="title function_">createIndex</span>({location : <span class="string">"2dsphere"</span>})</span><br></pre></td></tr></tbody></table></figure>

<p>查询附近10000米商家信息</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurant</span>.<span class="title function_">find</span>( { </span><br><span class="line">    <span class="attr">location</span>:{ </span><br><span class="line">        $near :{</span><br><span class="line">            $geometry :{ </span><br><span class="line">                type : <span class="string">"Point"</span> ,</span><br><span class="line">                coordinates : [  -<span class="number">73.88</span>, <span class="number">40.78</span> ] </span><br><span class="line">            } ,</span><br><span class="line">            <span class="attr">$maxDistance</span>:<span class="number">10000</span> </span><br><span class="line">        } </span><br><span class="line">    } </span><br><span class="line">} )</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$near查询操作符，用于实现附近商家的检索，返回数据结果会按距离排序。</li>
<li>$geometry操作符用于指定一个GeoJSON格式的地理空间对象，type=Point表示地理坐标点，coordinates则是用户当前所在的经纬度位置；$maxDistance限定了最大距离，单位是米。</li>
</ul>
<h2 id="全文索引（Text-Indexes）"><a href="#全文索引（Text-Indexes）" class="headerlink" title="全文索引（Text Indexes）"></a>全文索引（Text Indexes）</h2><p>MongoDB支持全文检索功能，可通过建立文本索引来实现简易的分词检索。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">reviews</span>.<span class="title function_">createIndex</span>( { <span class="attr">comments</span>: <span class="string">"text"</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>$text操作符可以在有text index的集合上执行文本检索。$text将会使用空格和标点符号作为分隔符对检索字符串进行分词， 并且对检索字符串中所有的分词结果进行一个逻辑上的 OR 操作。</p>
<p>全文索引能解决快速文本查找的需求，比如有一个博客文章集合，需要根据博客的内容来快速查找，则可以针对博客内容建立文本索引。</p>
<p><strong>案例</strong></p>
<p>数据准备</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">stores</span>.<span class="title function_">insert</span>(</span><br><span class="line">   [</span><br><span class="line">     { <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Java Hut"</span>, <span class="attr">description</span>: <span class="string">"Coffee and cakes"</span> },</span><br><span class="line">     { <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Burger Buns"</span>, <span class="attr">description</span>: <span class="string">"Gourmet hamburgers"</span> },</span><br><span class="line">     { <span class="attr">_id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Coffee Shop"</span>, <span class="attr">description</span>: <span class="string">"Just coffee"</span> },</span><br><span class="line">     { <span class="attr">_id</span>: <span class="number">4</span>, <span class="attr">name</span>: <span class="string">"Clothes Clothes Clothes"</span>, <span class="attr">description</span>: <span class="string">"Discount clothing"</span> },</span><br><span class="line">     { <span class="attr">_id</span>: <span class="number">5</span>, <span class="attr">name</span>: <span class="string">"Java Shopping"</span>, <span class="attr">description</span>: <span class="string">"Indonesian goods"</span> }</span><br><span class="line">   ]</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>创建name和description的全文索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">stores</span>.<span class="title function_">createIndex</span>({<span class="attr">name</span>: <span class="string">"text"</span>, <span class="attr">description</span>: <span class="string">"text"</span>})</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<p>通过$text操作符来查寻数据中所有包含“coffee”,”shop”，“java”列表中任何词语的商店</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">stores</span>.<span class="title function_">find</span>({<span class="attr">$text</span>: {<span class="attr">$search</span>: <span class="string">"java coffee shop"</span>}})</span><br></pre></td></tr></tbody></table></figure>

<p>MongoDB的文本索引功能存在诸多限制，而官方并未提供中文分词的功能，这使得该功能的应用场景十分受限。</p>
<h2 id="通配符索引（Wildcard-Indexes）"><a href="#通配符索引（Wildcard-Indexes）" class="headerlink" title="通配符索引（Wildcard Indexes）"></a>通配符索引（Wildcard Indexes）</h2><p>MongoDB的文档模式是动态变化的，而通配符索引可以建立在一些不可预知的字段上，以此实现查询的加速。MongoDB 4.2 引入了通配符索引来支持对未知或任意字段的查询。</p>
<p><strong>案例</strong></p>
<p>准备商品数据，不同商品属性不一样</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">products</span>.<span class="title function_">insert</span>([</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"product_name"</span> : <span class="string">"Spy Coat"</span>,</span><br><span class="line">      <span class="string">"product_attributes"</span> : {</span><br><span class="line">        <span class="string">"material"</span> : [ <span class="string">"Tweed"</span>, <span class="string">"Wool"</span>, <span class="string">"Leather"</span> ],</span><br><span class="line">        <span class="string">"size"</span> : {</span><br><span class="line">          <span class="string">"length"</span> : <span class="number">72</span>,</span><br><span class="line">          <span class="string">"units"</span> : <span class="string">"inches"</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"product_name"</span> : <span class="string">"Spy Pen"</span>,</span><br><span class="line">      <span class="string">"product_attributes"</span> : {</span><br><span class="line">         <span class="string">"colors"</span> : [ <span class="string">"Blue"</span>, <span class="string">"Black"</span> ],</span><br><span class="line">         <span class="string">"secret_feature"</span> : {</span><br><span class="line">           <span class="string">"name"</span> : <span class="string">"laser"</span>,</span><br><span class="line">           <span class="string">"power"</span> : <span class="string">"1000"</span>,</span><br><span class="line">           <span class="string">"units"</span> : <span class="string">"watts"</span>,</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"product_name"</span> : <span class="string">"Spy Book"</span></span><br><span class="line">    }</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<p>创建通配符索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">products</span>.<span class="title function_">createIndex</span>( { <span class="string">"product_attributes.$**"</span> : <span class="number">1</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<p>通配符索引可以支持任意单字段查询 product_attributes或其嵌入字段：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">products</span>.<span class="title function_">find</span>( { <span class="string">"product_attributes.size.length"</span> : { $gt : <span class="number">60</span> } } )</span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">find</span>( { <span class="string">"product_attributes.material"</span> : <span class="string">"Leather"</span> } )</span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">find</span>( { <span class="string">"product_attributes.secret_feature.name"</span> : <span class="string">"laser"</span> } )</span><br></pre></td></tr></tbody></table></figure>



<p><strong>注意事项</strong></p>
<ul>
<li>通配符索引不兼容的索引类型或属性</li>
</ul>
<p>![截图 (../img/截图 (8).png)](C:/Users/Radish/Downloads/截图 (8).png)</p>
<ul>
<li>通配符索引是稀疏的，不索引空字段。因此，通配符索引不能支持查询字段不存在的文档。</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 通配符索引不能支持以下查询</span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">find</span>( {<span class="string">"product_attributes"</span> : { $exists : <span class="literal">false</span> } } )</span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  { $match : { <span class="string">"product_attributes"</span> : { $exists : <span class="literal">false</span> } } }</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>通配符索引为文档或数组的内容生成条目，而不是文档/数组本身。因此通配符索引不能支持精确的文档/数组相等匹配。通配符索引可以支持查询字段等于空文档{}的情况。</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#通配符索引不能支持以下查询:</span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">find</span>({ <span class="string">"product_attributes.colors"</span> : [ <span class="string">"Blue"</span>, <span class="string">"Black"</span> ] } )</span><br><span class="line"></span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">aggregate</span>([{</span><br><span class="line">  $match : { <span class="string">"product_attributes.colors"</span> : [ <span class="string">"Blue"</span>, <span class="string">"Black"</span> ] } </span><br><span class="line">}])</span><br></pre></td></tr></tbody></table></figure>



<h1 id="4、索引属性"><a href="#4、索引属性" class="headerlink" title="4、索引属性"></a>4、索引属性</h1><h2 id="唯一索引（Unique-Indexes）"><a href="#唯一索引（Unique-Indexes）" class="headerlink" title="唯一索引（Unique Indexes）"></a><strong>唯一索引（Unique Indexes）</strong></h2><p>在现实场景中，唯一性是很常见的一种索引约束需求，重复的数据记录会带来许多处理上的麻烦，比如订单的编号、用户的登录名等。通过建立唯一性索引，可以保证集合中文档的指定字段拥有唯一值。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建唯一索引</span><br><span class="line">db.<span class="property">values</span>.<span class="title function_">createIndex</span>({<span class="attr">title</span>:<span class="number">1</span>},{<span class="attr">unique</span>:<span class="literal">true</span>})</span><br><span class="line"># 复合索引支持唯一性约束</span><br><span class="line">db.<span class="property">values</span>.<span class="title function_">createIndex</span>({<span class="attr">title</span>:<span class="number">1</span>，<span class="attr">type</span>:<span class="number">1</span>},{<span class="attr">unique</span>:<span class="literal">true</span>})</span><br><span class="line">#多键索引支持唯一性约束</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">createIndex</span>( { <span class="attr">ratings</span>: <span class="number">1</span> },{<span class="attr">unique</span>:<span class="literal">true</span>} )</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>唯一性索引对于文档中缺失的字段，会使用null值代替，因此不允许存在多个文档缺失索引字段的情况。</li>
<li>对于分片的集合，唯一性约束必须匹配分片规则。换句话说，为了保证全局的唯一性，分片键必须作为唯一性索引的前缀字段。</li>
</ul>
<h2 id="部分索引（Partial-Indexes）"><a href="#部分索引（Partial-Indexes）" class="headerlink" title="部分索引（Partial Indexes）"></a><strong>部分索引（Partial Indexes）</strong></h2><p>部分索引仅对满足指定过滤器表达式的文档进行索引。通过在一个集合中为文档的一个子集建立索引，部分索引具有更低的存储需求和更低的索引创建和维护的性能成本。3.2新版功能。</p>
<p>部分索引提供了稀疏索引功能的超集，应该优先于稀疏索引。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">createIndex</span>(</span><br><span class="line">   { <span class="attr">cuisine</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span> },</span><br><span class="line">   { <span class="attr">partialFilterExpression</span>: { <span class="attr">rating</span>: { <span class="attr">$gt</span>: <span class="number">5</span> } } }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>partialFilterExpression选项接受指定过滤条件的文档:</p>
<ul>
<li>等式表达式(例如:field: value或使用$eq操作符)</li>
<li>$exists: true</li>
<li>$gt， $gte， $lt， $lte</li>
<li>$type </li>
<li>顶层的$and</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 符合条件，使用索引</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">find</span>( { <span class="attr">cuisine</span>: <span class="string">"Italian"</span>, <span class="attr">rating</span>: { <span class="attr">$gte</span>: <span class="number">8</span> } } )</span><br><span class="line"># 不符合条件，不能使用索引</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">find</span>( { <span class="attr">cuisine</span>: <span class="string">"Italian"</span> } )</span><br></pre></td></tr></tbody></table></figure>



<p><strong>案例1</strong></p>
<p>restaurants集合数据</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">insert</span>({</span><br><span class="line">   <span class="string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="string">"5641f6a7522545bc535b5dc9"</span>),</span><br><span class="line">   <span class="string">"address"</span> : {</span><br><span class="line">      <span class="string">"building"</span> : <span class="string">"1007"</span>,</span><br><span class="line">      <span class="string">"coord"</span> : [</span><br><span class="line">         -<span class="number">73.856077</span>,</span><br><span class="line">         <span class="number">40.848447</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"street"</span> : <span class="string">"Morris Park Ave"</span>,</span><br><span class="line">      <span class="string">"zipcode"</span> : <span class="string">"10462"</span></span><br><span class="line">   },</span><br><span class="line">   <span class="string">"borough"</span> : <span class="string">"Bronx"</span>,</span><br><span class="line">   <span class="string">"cuisine"</span> : <span class="string">"Bakery"</span>,</span><br><span class="line">   <span class="string">"rating"</span> : { <span class="string">"date"</span> : <span class="title class_">ISODate</span>(<span class="string">"2014-03-03T00:00:00Z"</span>),</span><br><span class="line">                <span class="string">"grade"</span> : <span class="string">"A"</span>,</span><br><span class="line">                <span class="string">"score"</span> : <span class="number">2</span></span><br><span class="line">              },</span><br><span class="line">   <span class="string">"name"</span> : <span class="string">"Morris Park Bake Shop"</span>,</span><br><span class="line">   <span class="string">"restaurant_id"</span> : <span class="string">"30075445"</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>创建索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">createIndex</span>(</span><br><span class="line">   { <span class="attr">borough</span>: <span class="number">1</span>, <span class="attr">cuisine</span>: <span class="number">1</span> },</span><br><span class="line">   { <span class="attr">partialFilterExpression</span>: { <span class="string">'rating.grade'</span>: { <span class="attr">$eq</span>: <span class="string">"A"</span> } } }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">find</span>( { <span class="attr">borough</span>: <span class="string">"Bronx"</span>, <span class="string">'rating.grade'</span>: <span class="string">"A"</span> } )</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">find</span>( { <span class="attr">borough</span>: <span class="string">"Bronx"</span>, <span class="attr">cuisine</span>: <span class="string">"Bakery"</span> } )</span><br></pre></td></tr></tbody></table></figure>



<p><strong>唯一约束结合部分索引使用导致唯一约束失效的问题</strong></p>
<p>注意：如果同时指定了partialFilterExpression和唯一约束，那么唯一约束只适用于满足筛选器表达式的文档。如果文档不满足筛选条件，那么带有惟一约束的部分索引不会阻止插入不满足惟一约束的文档。</p>
<p><strong>案例2</strong></p>
<p>users集合数据准备</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">users</span>.<span class="title function_">insertMany</span>( [</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"david"</span>, <span class="attr">age</span>: <span class="number">29</span> },</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"amanda"</span>, <span class="attr">age</span>: <span class="number">35</span> },</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"rajiv"</span>, <span class="attr">age</span>: <span class="number">57</span> }</span><br><span class="line">] )</span><br></pre></td></tr></tbody></table></figure>

<p>创建索引，指定username字段和部分过滤器表达式age: {$gte: 21}的唯一约束。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">users</span>.<span class="title function_">createIndex</span>(</span><br><span class="line">   { <span class="attr">username</span>: <span class="number">1</span> },</span><br><span class="line">   { <span class="attr">unique</span>: <span class="literal">true</span>, <span class="attr">partialFilterExpression</span>: { <span class="attr">age</span>: { <span class="attr">$gte</span>: <span class="number">21</span> } } }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<p>索引防止了以下文档的插入，因为文档已经存在，且指定的用户名和年龄字段大于21:</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">users</span>.<span class="title function_">insertMany</span>( [</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"david"</span>, <span class="attr">age</span>: <span class="number">27</span> },</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"amanda"</span>, <span class="attr">age</span>: <span class="number">25</span> },</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"rajiv"</span>, <span class="attr">age</span>: <span class="number">32</span> }</span><br><span class="line">] )</span><br></pre></td></tr></tbody></table></figure>

<p>但是，以下具有重复用户名的文档是允许的，因为唯一约束只适用于年龄大于或等于21岁的文档。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">users</span>.<span class="title function_">insertMany</span>( [</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"david"</span>, <span class="attr">age</span>: <span class="number">20</span> },</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"amanda"</span> },</span><br><span class="line">   { <span class="attr">username</span>: <span class="string">"rajiv"</span>, <span class="attr">age</span>: <span class="literal">null</span> }</span><br><span class="line">] )</span><br></pre></td></tr></tbody></table></figure>



<h2 id="稀疏索引（Sparse-Indexes）"><a href="#稀疏索引（Sparse-Indexes）" class="headerlink" title="稀疏索引（Sparse Indexes）"></a><strong>稀疏索引（Sparse Indexes）</strong></h2><p>索引的稀疏属性确保索引只包含具有索引字段的文档的条目，索引将跳过没有索引字段的文档。</p>
<p>特性： 只对存在字段的文档进行索引（包括字段值为null的文档）</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#不索引不包含xmpp_id字段的文档</span><br><span class="line">db.<span class="property">addresses</span>.<span class="title function_">createIndex</span>( { <span class="string">"xmpp_id"</span>: <span class="number">1</span> }, { <span class="attr">sparse</span>: <span class="literal">true</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>如果稀疏索引会导致查询和排序操作的结果集不完整，MongoDB将不会使用该索引，除非hint()明确指定索引。</p>
<p><strong>案例</strong></p>
<p>数据准备</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">    {<span class="string">"userid"</span> : <span class="string">"newbie"</span>},</span><br><span class="line">    {<span class="string">"userid"</span> : <span class="string">"abby"</span>, <span class="string">"score"</span> : <span class="number">82</span>},</span><br><span class="line">    {<span class="string">"userid"</span> : <span class="string">"nina"</span>, <span class="string">"score"</span> : <span class="number">90</span>}</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<p>创建稀疏索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">createIndex</span>( { <span class="attr">score</span>: <span class="number">1</span> } , { <span class="attr">sparse</span>: <span class="literal">true</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用稀疏索引</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">find</span>( { <span class="attr">score</span>: { <span class="attr">$lt</span>: <span class="number">90</span> } } )</span><br><span class="line"></span><br><span class="line"># 即使排序是通过索引字段，<span class="title class_">MongoDB</span>也不会选择稀疏索引来完成查询，以返回完整的结果</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>( { <span class="attr">score</span>: -<span class="number">1</span> } )</span><br><span class="line"></span><br><span class="line"># 要使用稀疏索引，使用<span class="title function_">hint</span>()显式指定索引</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>( { <span class="attr">score</span>: -<span class="number">1</span> } ).<span class="title function_">hint</span>( { <span class="attr">score</span>: <span class="number">1</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>同时具有稀疏性和唯一性的索引可以防止集合中存在字段值重复的文档，但允许不包含此索引字段的文档插入。</p>
<p><strong>案例</strong></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">dropIndex</span>({<span class="attr">score</span>:<span class="number">1</span>})</span><br><span class="line"># 创建具有唯一约束的稀疏索引</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">createIndex</span>( { <span class="attr">score</span>: <span class="number">1</span> } , { <span class="attr">sparse</span>: <span class="literal">true</span>, <span class="attr">unique</span>: <span class="literal">true</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<p>这个索引将允许插入具有唯一的分数字段值或不包含分数字段的文档。因此，给定scores集合中的现有文档，索引允许以下插入操作:</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">insertMany</span>( [</span><br><span class="line">   { <span class="string">"userid"</span>: <span class="string">"AAAAAAA"</span>, <span class="string">"score"</span>: <span class="number">50</span> },</span><br><span class="line">   { <span class="string">"userid"</span>: <span class="string">"BBBBBBB"</span>, <span class="string">"score"</span>: <span class="number">64</span> },</span><br><span class="line">   { <span class="string">"userid"</span>: <span class="string">"CCCCCCC"</span> },</span><br><span class="line">   { <span class="string">"userid"</span>: <span class="string">"CCCCCCC"</span> }</span><br><span class="line">] )</span><br></pre></td></tr></tbody></table></figure>

<p>索引不允许添加下列文件，因为已经存在评分为82和90的文件：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">insertMany</span>( [</span><br><span class="line">   { <span class="string">"userid"</span>: <span class="string">"AAAAAAA"</span>, <span class="string">"score"</span>: <span class="number">82</span> },</span><br><span class="line">   { <span class="string">"userid"</span>: <span class="string">"BBBBBBB"</span>, <span class="string">"score"</span>: <span class="number">90</span> }</span><br><span class="line">] )</span><br></pre></td></tr></tbody></table></figure>



<h2 id="TTL索引（TTL-Indexes）"><a href="#TTL索引（TTL-Indexes）" class="headerlink" title="TTL索引（TTL Indexes）"></a><strong>TTL索引（TTL Indexes）</strong></h2><p>在一般的应用系统中，并非所有的数据都需要永久存储。例如一些系统事件、用户消息等，这些数据随着时间的推移，其重要程度逐渐降低。更重要的是，存储这些大量的历史数据需要花费较高的成本，因此项目中通常会对过期且不再使用的数据进行老化处理。</p>
<p>通常的做法如下：</p>
<p>方案一：为每个数据记录一个时间戳，应用侧开启一个定时器，按时间戳定期删除过期的数据。</p>
<p>方案二：数据按日期进行分表，同一天的数据归档到同一张表，同样使用定时器删除过期的表。</p>
<p>对于数据老化，MongoDB提供了一种更加便捷的做法：TTL（Time To Live）索引。TTL索引需要声明在一个日期类型的字段中，TTL 索引是特殊的单字段索引，MongoDB 可以使用它在一定时间或特定时钟时间后自动从集合中删除文档。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建 <span class="variable constant_">TTL</span> 索引，<span class="variable constant_">TTL</span> 值为<span class="number">3600</span>秒</span><br><span class="line">db.<span class="property">eventlog</span>.<span class="title function_">createIndex</span>( { <span class="string">"lastModifiedDate"</span>: <span class="number">1</span> }, { <span class="attr">expireAfterSeconds</span>: <span class="number">3600</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p>对集合创建TTL索引之后，MongoDB会在周期性运行的后台线程中对该集合进行检查及数据清理工作。除了数据老化功能，TTL索引具有普通索引的功能，同样可以用于加速数据的查询。</p>
<p>TTL 索引不保证过期数据会在过期后立即被删除。文档过期和 MongoDB 从数据库中删除文档的时间之间可能存在延迟。删除过期文档的后台任务每 60 秒运行一次。因此，在文档到期和后台任务运行之间的时间段内，文档可能会保留在集合中。</p>
<p><strong>案例</strong></p>
<p>数据准备</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">log_events</span>.<span class="title function_">insertOne</span>( {</span><br><span class="line">   <span class="string">"createdAt"</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">   <span class="string">"logEvent"</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="string">"logMessage"</span>: <span class="string">"Success!"</span></span><br><span class="line">} )</span><br></pre></td></tr></tbody></table></figure>

<p>创建TTL索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">log_events</span>.<span class="title function_">createIndex</span>( { <span class="string">"createdAt"</span>: <span class="number">1</span> }, { <span class="attr">expireAfterSeconds</span>: <span class="number">20</span> } )</span><br></pre></td></tr></tbody></table></figure>

<p><strong>可变的过期时间</strong></p>
<p>TTL索引在创建之后，仍然可以对过期时间进行修改。这需要使用collMod命令对索引的定义进行变更</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">runCommand</span>({<span class="attr">collMod</span>:<span class="string">"log_events"</span>,<span class="attr">index</span>:{<span class="attr">keyPattern</span>:{<span class="attr">createdAt</span>:<span class="number">1</span>},<span class="attr">expireAfterSeconds</span>:<span class="number">600</span>}})</span><br></pre></td></tr></tbody></table></figure>

<p><strong>使用约束</strong></p>
<p>TTL索引的确可以减少开发的工作量，而且通过数据库自动清理的方式会更加高效、可靠，但是在使用TTL索引时需要注意以下的限制：</p>
<ul>
<li>TTL索引只能支持单个字段，并且必须是非_id字段。</li>
<li>TTL索引不能用于固定集合。 </li>
<li>TTL索引无法保证及时的数据老化，MongoDB会通过后台的TTLMonitor定时器来清理老化数据，默认的间隔时间是1分钟。当然如果在数据库负载过高的情况下，TTL的行为则会进一步受到影响。</li>
<li>TTL索引对于数据的清理仅仅使用了remove命令，这种方式并不是很高效。因此TTL Monitor在运行期间对系统CPU、磁盘都会造成一定的压力。相比之下，按日期分表的方式操作会更加高效。</li>
</ul>
<h2 id="隐藏索引（Hidden-Indexes）"><a href="#隐藏索引（Hidden-Indexes）" class="headerlink" title="隐藏索引（Hidden Indexes）"></a><strong>隐藏索引（Hidden Indexes）</strong></h2><p>隐藏索引对查询规划器不可见，不能用于支持查询。通过对规划器隐藏索引，用户可以在不实际删除索引的情况下评估删除索引的潜在影响。如果影响是负面的，用户可以取消隐藏索引，而不必重新创建已删除的索引。4.4新版功能。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">创建隐藏索引</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">createIndex</span>({ <span class="attr">borough</span>: <span class="number">1</span> },{ <span class="attr">hidden</span>: <span class="literal">true</span> });</span><br><span class="line"># 隐藏现有索引</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">hideIndex</span>( { <span class="attr">borough</span>: <span class="number">1</span>} );</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">hideIndex</span>( <span class="string">"索引名称"</span> )</span><br><span class="line"># 取消隐藏索引</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">unhideIndex</span>( { <span class="attr">borough</span>: <span class="number">1</span>} );</span><br><span class="line">db.<span class="property">restaurants</span>.<span class="title function_">unhideIndex</span>( <span class="string">"索引名称"</span> ); </span><br></pre></td></tr></tbody></table></figure>

<p><strong>案例</strong></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">    {<span class="string">"userid"</span> : <span class="string">"newbie"</span>},</span><br><span class="line">    {<span class="string">"userid"</span> : <span class="string">"abby"</span>, <span class="string">"score"</span> : <span class="number">82</span>},</span><br><span class="line">    {<span class="string">"userid"</span> : <span class="string">"nina"</span>, <span class="string">"score"</span> : <span class="number">90</span>}</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<p>创建隐藏索引</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">createIndex</span>(</span><br><span class="line">   { <span class="attr">userid</span>: <span class="number">1</span> },</span><br><span class="line">   { <span class="attr">hidden</span>: <span class="literal">true</span> }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>查看索引信息</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">scores</span>.<span class="title function_">getIndexes</span>()</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 不使用索引</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">find</span>({<span class="attr">userid</span>:<span class="string">"abby"</span>}).<span class="title function_">explain</span>()</span><br><span class="line"></span><br><span class="line">#取消隐藏索引</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">unhideIndex</span>( { <span class="attr">userid</span>: <span class="number">1</span>} )</span><br><span class="line">#使用索引</span><br><span class="line">db.<span class="property">scores</span>.<span class="title function_">find</span>({<span class="attr">userid</span>:<span class="string">"abby"</span>}).<span class="title function_">explain</span>()</span><br></pre></td></tr></tbody></table></figure>



<h1 id="5、索引使用建议"><a href="#5、索引使用建议" class="headerlink" title="5、索引使用建议"></a>5、<strong>索引使用建议</strong></h1><p><strong>1）为每一个查询建立合适的索引</strong></p>
<p>这个是针对于数据量较大比如说超过几十上百万（文档数目）数量级的集合。如果没有索引MongoDB需要把所有的Document从盘上读到内存，这会对MongoDB服务器造成较大的压力并影响到其他请求的执行。</p>
<p><strong>2）创建合适的复合索引，不要依赖于交叉索引</strong></p>
<p>如果你的查询会使用到多个字段，MongoDB有两个索引技术可以使用：交叉索引和复合索引。交叉索引就是针对每个字段单独建立一个单字段索引，然后在查询执行时候使用相应的单字段索引进行索引交叉而得到查询结果。交叉索引目前触发率较低，所以如果你有一个多字段查询的时候，建议使用复合索引能够保证索引正常的使用。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查找所有年龄小于<span class="number">30</span>岁的深圳市马拉松运动员</span><br><span class="line">db.<span class="property">athelets</span>.<span class="title function_">find</span>({<span class="attr">sport</span>: <span class="string">"marathon"</span>, <span class="attr">location</span>: <span class="string">"sz"</span>, <span class="attr">age</span>: {<span class="attr">$lt</span>: <span class="number">30</span>}}})</span><br><span class="line">#创建复合索引</span><br><span class="line">db.<span class="property">athelets</span>.<span class="title function_">createIndex</span>({<span class="attr">sport</span>:<span class="number">1</span>, <span class="attr">location</span>:<span class="number">1</span>, <span class="attr">age</span>:<span class="number">1</span>})</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3）复合索引字段顺序：匹配条件在前，范围条件在后（Equality First, Range After）</strong></p>
<p>前面的例子，在创建复合索引时如果条件有匹配和范围之分，那么匹配条件（sport: “marathon”) 应该在复合索引的前面。范围条件(age: &lt;30)字段应该放在复合索引的后面。</p>
<p><strong>4）尽可能使用覆盖索引（Covered Index）</strong></p>
<p>建议只返回需要的字段，同时，利用覆盖索引来提升性能。</p>
<p><strong>5）建索引要在后台运行</strong></p>
<p>在对一个集合创建索引时，该集合所在的数据库将不接受其他读写操作。对大数据量的集合建索引，建议使用后台运行选项 {background: true}</p>
<p><strong>6）避免设计过长的数组索引</strong></p>
<p>数组索引是多值的，在存储时需要使用更多的空间。如果索引的数组长度特别长，或者数组的增长不受控制，则可能导致索引空间急剧膨胀。</p>
<h1 id="6、explain执行计划"><a href="#6、explain执行计划" class="headerlink" title="6、explain执行计划"></a>6、<strong>explain执行计划</strong></h1><p>通常我们需要关心的问题：</p>
<ul>
<li>查询是否使用了索引</li>
<li>索引是否减少了扫描的记录数量</li>
<li>是否存在低效的内存排序</li>
</ul>
<p>MongoDB提供了explain命令，它可以帮助我们评估指定查询模型（querymodel）的执行计划，根据实际情况进行调整，然后提高查询效率。</p>
<p>explain()方法的形式如下:</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">collection</span>.<span class="title function_">find</span>().<span class="title function_">explain</span>(&lt;verbose&gt;)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>verbose  可选参数，表示执行计划的输出模式，默认queryPlanner</li>
</ul>
<table>
<thead>
<tr>
<th>模式名字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>queryPlanner</td>
<td>执行计划的详细信息，包括查询计划、集合信息、查询条件、最佳执行计划、查询方式和 MongoDB 服务信息等</td>
</tr>
<tr>
<td>exectionStats</td>
<td>最佳执行计划的执行情况和被拒绝的计划等信息</td>
</tr>
<tr>
<td>allPlansExecution</td>
<td>选择并执行最佳执行计划，并返回最佳执行计划和其他执行计划的执行情况</td>
</tr>
</tbody></table>
<h2 id="queryPlanner"><a href="#queryPlanner" class="headerlink" title="queryPlanner"></a><strong>queryPlanner</strong></h2><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 未创建title的索引</span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">find</span>({<span class="attr">title</span>:<span class="string">"book-1"</span>}).<span class="title function_">explain</span>(<span class="string">"queryPlanner"</span>)</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th><strong>字段名称</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>plannerVersion</td>
<td>执行计划的版本</td>
</tr>
<tr>
<td>namespace</td>
<td>查询的集合</td>
</tr>
<tr>
<td>indexFilterSet</td>
<td>是否使用索引</td>
</tr>
<tr>
<td>parsedQuery</td>
<td>查询条件</td>
</tr>
<tr>
<td>winningPlan</td>
<td>最佳执行计划</td>
</tr>
<tr>
<td>stage</td>
<td>查询方式</td>
</tr>
<tr>
<td>filter</td>
<td>过滤条件</td>
</tr>
<tr>
<td>direction</td>
<td>查询顺序</td>
</tr>
<tr>
<td>rejectedPlans</td>
<td>拒绝的执行计划</td>
</tr>
<tr>
<td>serverInfo</td>
<td>mongodb服务器信息</td>
</tr>
</tbody></table>
<h2 id="executionStats"><a href="#executionStats" class="headerlink" title="executionStats"></a><strong>executionStats</strong></h2><p>executionStats 模式的返回信息中包含了 queryPlanner 模式的所有字段，并且还包含了最佳执行计划的执行情况</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#创建索引</span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">createIndex</span>({<span class="attr">title</span>:<span class="number">1</span>})</span><br><span class="line"></span><br><span class="line">db.<span class="property">books</span>.<span class="title function_">find</span>({<span class="attr">title</span>:<span class="string">"book-1"</span>}).<span class="title function_">explain</span>(<span class="string">"executionStats"</span>)</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th><strong>字段名称</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>winningPlan.inputStage</td>
<td>用来描述子stage，并且为其父stage提供文档和索引关键字</td>
</tr>
<tr>
<td>winningPlan.inputStage.stage</td>
<td>子查询方式</td>
</tr>
<tr>
<td>winningPlan.inputStage.keyPattern</td>
<td>所扫描的index内容</td>
</tr>
<tr>
<td>winningPlan.inputStage.indexName</td>
<td>索引名</td>
</tr>
<tr>
<td>winningPlan.inputStage.isMultiKey</td>
<td>是否是Multikey。如果索引建立在array上，将是true</td>
</tr>
<tr>
<td>executionStats.executionSuccess</td>
<td>是否执行成功</td>
</tr>
<tr>
<td>executionStats.nReturned</td>
<td>返回的个数</td>
</tr>
<tr>
<td>executionStats.executionTimeMillis</td>
<td>这条语句执行时间</td>
</tr>
<tr>
<td>executionStats.executionStages.executionTimeMillisEstimate</td>
<td>检索文档获取数据的时间</td>
</tr>
<tr>
<td>executionStats.executionStages.inputStage.executionTimeMillisEstimate</td>
<td>扫描获取数据的时间</td>
</tr>
<tr>
<td>executionStats.totalKeysExamined</td>
<td>索引扫描次数</td>
</tr>
<tr>
<td>executionStats.totalDocsExamined</td>
<td>文档扫描次数</td>
</tr>
<tr>
<td>executionStats.executionStages.isEOF</td>
<td>是否到达 steam 结尾，1 或者 true 代表已到达结尾</td>
</tr>
<tr>
<td>executionStats.executionStages.works</td>
<td>工作单元数，一个查询会分解成小的工作单元</td>
</tr>
<tr>
<td>executionStats.executionStages.advanced</td>
<td>优先返回的结果数</td>
</tr>
<tr>
<td>executionStats.executionStages.docsExamined</td>
<td>文档检查数</td>
</tr>
</tbody></table>
<h2 id="allPlansExecution"><a href="#allPlansExecution" class="headerlink" title="allPlansExecution"></a><strong>allPlansExecution</strong></h2><p>allPlansExecution返回的信息包含 executionStats 模式的内容，且包含allPlansExecution:[]块</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"allPlansExecution"</span> : [</span><br><span class="line">      {</span><br><span class="line">         <span class="string">"nReturned"</span> : &lt;int&gt;,</span><br><span class="line">         <span class="string">"executionTimeMillisEstimate"</span> : &lt;int&gt;,</span><br><span class="line">         <span class="string">"totalKeysExamined"</span> : &lt;int&gt;,</span><br><span class="line">         <span class="string">"totalDocsExamined"</span> :&lt;int&gt;,</span><br><span class="line">         <span class="string">"executionStages"</span> : {</span><br><span class="line">            <span class="string">"stage"</span> : &lt;<span class="variable constant_">STAGEA</span>&gt;,</span><br><span class="line">            <span class="string">"nReturned"</span> : &lt;int&gt;,</span><br><span class="line">            <span class="string">"executionTimeMillisEstimate"</span> : &lt;int&gt;,</span><br><span class="line">            ...</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">      },</span><br><span class="line">      ...</span><br><span class="line">   ]</span><br></pre></td></tr></tbody></table></figure>



<h2 id="stage状态"><a href="#stage状态" class="headerlink" title="stage状态"></a><strong>stage状态</strong></h2><table>
<thead>
<tr>
<th><strong>状态</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>COLLSCAN</td>
<td>全表扫描</td>
</tr>
<tr>
<td>IXSCAN</td>
<td>索引扫描</td>
</tr>
<tr>
<td>FETCH</td>
<td>根据索引检索指定文档</td>
</tr>
<tr>
<td>SHARD_MERGE</td>
<td>将各个分片返回数据进行合并</td>
</tr>
<tr>
<td>SORT</td>
<td>在内存中进行了排序</td>
</tr>
<tr>
<td>LIMIT</td>
<td>使用limit限制返回数</td>
</tr>
<tr>
<td>SKIP</td>
<td>使用skip进行跳过</td>
</tr>
<tr>
<td>IDHACK</td>
<td>对_id进行查询</td>
</tr>
<tr>
<td>SHARDING_FILTER</td>
<td>通过mongos对分片数据进行查询</td>
</tr>
<tr>
<td>COUNTSCAN</td>
<td>count不使用Index进行count时的stage返回</td>
</tr>
<tr>
<td>COUNT_SCAN</td>
<td>count使用了Index进行count时的stage返回</td>
</tr>
<tr>
<td>SUBPLA</td>
<td>未使用到索引的$or查询的stage返回</td>
</tr>
<tr>
<td>TEXT</td>
<td>使用全文索引进行查询时候的stage返回</td>
</tr>
<tr>
<td>PROJECTION</td>
<td>限定返回字段时候stage的返回</td>
</tr>
</tbody></table>
<p>执行计划的返回结果中尽量不要出现以下stage:</p>
<ul>
<li>COLLSCAN(全表扫描)</li>
<li>SORT(使用sort但是无index)</li>
<li>不合理的SKIP</li>
<li>SUBPLA(未用到index的$or)</li>
<li>COUNTSCAN(不使用index进行count)</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Radish</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/07/16/MongoDB%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/">http://example.com/2023/07/16/MongoDB%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">萝卜的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MongoDB/">MongoDB</a></div><div class="post_share"><div class="social-share" data-image="/../img/mongodb.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/07/18/MySQL%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8(%E4%B8%80)%E2%80%94%E2%80%94%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" title="MySQL分库分表(一)——集群搭建"><img class="cover" src="/../img/MySQL.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL分库分表(一)——集群搭建</div></div></a></div><div class="next-post pull-right"><a href="/2023/07/15/MongoDB%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%A3/" title="MongoDB聚合操作详解"><img class="cover" src="/../img/mongodb.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MongoDB聚合操作详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/06/16/MongoDB%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%B8%80)%E2%80%94%E2%80%94%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/" title="MongoDB基础入门(一)——基本介绍"><img class="cover" src="/../img/mongodb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-16</div><div class="title">MongoDB基础入门(一)——基本介绍</div></div></a></div><div><a href="/2023/06/17/MongoDB%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%B8%89)%E2%80%94%E2%80%94%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C/" title="MongoDB基础入门(三)——文档操作"><img class="cover" src="/../img/mongodb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-17</div><div class="title">MongoDB基础入门(三)——文档操作</div></div></a></div><div><a href="/2023/06/22/MongoDB%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%BA%94)%E2%80%94%E2%80%94SpringBoot%E6%95%B4%E5%90%88MongoDB/" title="MongoDB基础入门(五)——SpringBoot整合MongoDB"><img class="cover" src="/../img/mongodb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-22</div><div class="title">MongoDB基础入门(五)——SpringBoot整合MongoDB</div></div></a></div><div><a href="/2023/06/17/MongoDB%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%BA%8C)%E2%80%94%E2%80%94%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="MongoDB基础入门(二)——环境搭建"><img class="cover" src="/../img/mongodb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-17</div><div class="title">MongoDB基础入门(二)——环境搭建</div></div></a></div><div><a href="/2023/06/17/MongoDB%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E5%9B%9B)%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="MongoDB基础入门(四)——数据类型"><img class="cover" src="/../img/mongodb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-17</div><div class="title">MongoDB基础入门(四)——数据类型</div></div></a></div><div><a href="/2023/07/15/MongoDB%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%A3/" title="MongoDB聚合操作详解"><img class="cover" src="/../img/mongodb.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-15</div><div class="title">MongoDB聚合操作详解</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Radish</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">愿内心深处的懦弱 不再将我吞噬</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">1、索引数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WiredTiger%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%9C%A8%E7%A3%81%E7%9B%98%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">WiredTiger数据文件在磁盘的存储结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">2、索引操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">2.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.</span> <span class="toc-text">查看索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-number">2.3.</span> <span class="toc-text">删除索引</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">3、索引类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E9%94%AE%E7%B4%A2%E5%BC%95%EF%BC%88Single-Field-Indexes%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">单键索引（Single Field Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%EF%BC%88Compound-Index%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">复合索引（Compound Index）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E9%94%AE-%E6%95%B0%E7%BB%84-%E7%B4%A2%E5%BC%95%EF%BC%88Multikey-Index%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">多键(数组)索引（Multikey Index）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash%E7%B4%A2%E5%BC%95%EF%BC%88Hashed-Indexes%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">Hash索引（Hashed Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%E7%B4%A2%E5%BC%95%EF%BC%88Geospatial-Index%EF%BC%89"><span class="toc-number">3.5.</span> <span class="toc-text">地理空间索引（Geospatial Index）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95%EF%BC%88Text-Indexes%EF%BC%89"><span class="toc-number">3.6.</span> <span class="toc-text">全文索引（Text Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E7%B4%A2%E5%BC%95%EF%BC%88Wildcard-Indexes%EF%BC%89"><span class="toc-number">3.7.</span> <span class="toc-text">通配符索引（Wildcard Indexes）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E7%B4%A2%E5%BC%95%E5%B1%9E%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text">4、索引属性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%EF%BC%88Unique-Indexes%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">唯一索引（Unique Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E7%B4%A2%E5%BC%95%EF%BC%88Partial-Indexes%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">部分索引（Partial Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95%EF%BC%88Sparse-Indexes%EF%BC%89"><span class="toc-number">4.3.</span> <span class="toc-text">稀疏索引（Sparse Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TTL%E7%B4%A2%E5%BC%95%EF%BC%88TTL-Indexes%EF%BC%89"><span class="toc-number">4.4.</span> <span class="toc-text">TTL索引（TTL Indexes）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E7%B4%A2%E5%BC%95%EF%BC%88Hidden-Indexes%EF%BC%89"><span class="toc-number">4.5.</span> <span class="toc-text">隐藏索引（Hidden Indexes）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">5.</span> <span class="toc-text">5、索引使用建议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">6.</span> <span class="toc-text">6、explain执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#queryPlanner"><span class="toc-number">6.1.</span> <span class="toc-text">queryPlanner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#executionStats"><span class="toc-number">6.2.</span> <span class="toc-text">executionStats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#allPlansExecution"><span class="toc-number">6.3.</span> <span class="toc-text">allPlansExecution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stage%E7%8A%B6%E6%80%81"><span class="toc-number">6.4.</span> <span class="toc-text">stage状态</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/14/Tomcat(%E4%B8%80)-Tomcat%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E8%AE%BE%E8%AE%A1%E7%B2%BE%E9%AB%93%E5%88%86%E6%9E%90/" title="Tomcat(一)——Tomcat整体架构及其设计精髓分析"><img src="/../img/jvm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Tomcat(一)——Tomcat整体架构及其设计精髓分析"></a><div class="content"><a class="title" href="/2024/05/14/Tomcat(%E4%B8%80)-Tomcat%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E8%AE%BE%E8%AE%A1%E7%B2%BE%E9%AB%93%E5%88%86%E6%9E%90/" title="Tomcat(一)——Tomcat整体架构及其设计精髓分析">Tomcat(一)——Tomcat整体架构及其设计精髓分析</a><time datetime="2024-05-14T13:06:00.000Z" title="发表于 2024-05-14 21:06:00">2024-05-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/14/Java%E5%BC%80%E5%8F%91%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/" title="Java开发面试题总结"><img src="/../img/jvm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java开发面试题总结"></a><div class="content"><a class="title" href="/2024/05/14/Java%E5%BC%80%E5%8F%91%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/" title="Java开发面试题总结">Java开发面试题总结</a><time datetime="2024-05-14T13:06:00.000Z" title="发表于 2024-05-14 21:06:00">2024-05-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM(%E5%85%AB)%E2%80%94%E2%80%94%E8%AE%A9Java%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E7%9A%84JIT%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/" title="深入理解JVM(八)——让Java性能提升的JIT深度剖析"><img src="/../img/jvm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入理解JVM(八)——让Java性能提升的JIT深度剖析"></a><div class="content"><a class="title" href="/2024/05/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM(%E5%85%AB)%E2%80%94%E2%80%94%E8%AE%A9Java%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E7%9A%84JIT%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90/" title="深入理解JVM(八)——让Java性能提升的JIT深度剖析">深入理解JVM(八)——让Java性能提升的JIT深度剖析</a><time datetime="2024-05-13T13:22:00.000Z" title="发表于 2024-05-13 21:22:00">2024-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM(%E4%B8%83)%E2%80%94%E2%80%94%E4%B8%BAJava%E5%BC%80%E7%96%86%E6%8B%93%E5%9C%9F%E7%9A%84ZGC%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%20-%20%E5%89%AF%E6%9C%AC/" title="深入理解JVM(七)——为Java开疆拓土的ZGC深度剖析"><img src="/../img/jvm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入理解JVM(七)——为Java开疆拓土的ZGC深度剖析"></a><div class="content"><a class="title" href="/2024/05/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM(%E4%B8%83)%E2%80%94%E2%80%94%E4%B8%BAJava%E5%BC%80%E7%96%86%E6%8B%93%E5%9C%9F%E7%9A%84ZGC%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%20-%20%E5%89%AF%E6%9C%AC/" title="深入理解JVM(七)——为Java开疆拓土的ZGC深度剖析">深入理解JVM(七)——为Java开疆拓土的ZGC深度剖析</a><time datetime="2024-05-13T13:10:00.000Z" title="发表于 2024-05-13 21:10:00">2024-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/10/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM(%E5%85%AD)%E2%80%94%E2%80%94JVM%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98%E5%8F%8A%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E8%A7%A3/" title="深入理解JVM(六)——JVM调优实战及常量池详解"><img src="/../img/jvm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入理解JVM(六)——JVM调优实战及常量池详解"></a><div class="content"><a class="title" href="/2024/05/10/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM(%E5%85%AD)%E2%80%94%E2%80%94JVM%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98%E5%8F%8A%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E8%A7%A3/" title="深入理解JVM(六)——JVM调优实战及常量池详解">深入理解JVM(六)——JVM调优实战及常量池详解</a><time datetime="2024-05-10T13:43:00.000Z" title="发表于 2024-05-10 21:43:00">2024-05-10</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2023 - 2024 By Radish</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>